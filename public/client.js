(()=>{function e(e,t){const n=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);return void 0!==t?"rgba("+n+", "+a+", "+o+", "+t+")":"rgb("+n+", "+a+", "+o+")"}const t=async(e,t,n)=>{ke(!0);const a=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:{key:pe()}}),o=await a.json();if(o[1])throw Error("[FETCH-ERROR] "+o[1]);return ke(!1),{result:o[0],err:o[1]}};let n,a;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on(G_S_CONNECTED,([{games:e,maps:t,id:n,key:a}])=>{Ye(n),qe(t),Ie(a),Jt(e),i()}),e.on(G_S_LIST_UPDATED,([e])=>{Jt(e)}),e.on(G_S_LOBBY_DATA,([e])=>{qt(e)}),e.on(G_S_GAME_METADATA,([e])=>{Je(e),Ht(be(),e)}),e.on(G_S_START,([{gameData:e}])=>{mt(e),e.isPractice||rt("start")}),e.on(G_S_STOP,([e])=>{Et("menu"),xt(e),He(null)}),e.on(G_S_START_SIMULATION,([e])=>{Re([e]),gt(e),Ut(e)}),e.on(G_S_STOP_SIMULATION,([{dynamicGameData:e,timestamp:t}])=>{const n=ye();n.push({timestamp:t,dynamicGameData:e,last:!0}),n.length>500&&n.shift()}),e.on(G_S_BROADCAST,([{dynamicGameData:e,timestamp:t}])=>{const n=ye();n.push({timestamp:t,dynamicGameData:e}),n.length>500&&n.shift()}),e.on(G_S_FINISHED,([{gameData:e,replay:t}])=>{setTimeout(()=>{vt(e),We(t)},G_GAME_TIME_BUFFER_MS)}),e.on("connect",()=>{}),e.on("disconnect",e=>{wt("You disconnected from the game server!")}),e.on("error",e=>{console.error("socket-error",e),wt("An error occurred with the connection to the game server!")}),dt()},!1)})();let o=!1,l=null,s=+new Date,r=Math.PI;const i=()=>{Zt(),v("practice").disabled=!1,v("create-game").disabled=!1},c=()=>{n-s>9e3&&(s=+new Date)},d=()=>v("c").getContext("2d"),p=(e,t)=>{e.innerHTML=t},y=()=>{const e=d(),t=e.canvas;e.clearRect(0,0,t.width,t.height)},m=(e,t,n,a)=>{const o=d();o.beginPath(),o.arc(e,t,n,0,2*r,!1),o.fillStyle=a,o.fill()},u=(e,t,n,a)=>{const o=d();o.beginPath(),o.arc(e,t,n,0,2*r,!1),o.strokeStyle=a,o.stroke()},g=(e,t,n,a,o,l)=>{const s=d();if(s.save(),s.beginPath(),s.translate(e,t),s.fillStyle=o,void 0!==l){const e=n/2;s.translate(e,a/2),s.rotate(l*r/180),s.fillRect(-e,-a/1.5,n,a)}else s.fillRect(0,0,n,a);s.restore()},h=(e,t,n,a)=>{let o=a-t,l=n-e;const{sqrt:s,asin:i}=Math;let c=s(l*l+o*o),d=0;return d=a>=t&&n>=e?180*i(o/c)/r+90:a>=t&&n<e?180*i(o/-c)/r-90:a<t&&n>e?180*i(o/c)/r+90:180*i(-o/c)/r-90,d>=360&&(d=360-d),d<0&&(d=360+d),isNaN(d)?0:d},_=(e,t)=>({"":{blue:"#44F",yellow:"#cac200"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#FFF60B"}}[e][t]||e+t),f=e=>`background-color:${_("dark",e)};color:${_("light",e)};`,b=e=>{n=+new Date,a=0,l=e;const t=()=>{let e=+new Date;a=e-n,n=e,l(),requestAnimationFrame(t)};o||requestAnimationFrame(t),o=!0},G=()=>{const e=d().canvas,{left:t,top:n}=e.getBoundingClientRect();return{left:t,top:n,width:e.width,height:e.height}},E=(e,t)=>{const{width:n,height:a}=G();return{x:(e-n/2)/G_SCALE,y:-(t-a/2)/G_SCALE}},x=(e,t)=>{const{width:n,height:a}=G();return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+a/2)}},v=e=>document.getElementById(e),M=e=>{const{players:t,planets:n,projectiles:a}=e,o=me();y(),c(),$(n.map(t=>G_getEntityFromEntMap(t,e)),e);for(let t=0;t<o.length;t++){const n=o[t],{projectiles:a}=o[t];for(let t=0;t<a.length;t++){const o=G_getEntityFromEntMap(a[t],n);if(o.meta.type===G_action_move)continue;const{px:l,py:s,r:r,meta:i}=o,{x:c,y:d}=x(l,s),p=se(i.player,e);m(c,d,r*G_SCALE,_("light",p.color))}}if(A(a.map(t=>G_getEntityFromEntMap(t,e)).filter(e=>e.type!==G_action_move),e),w(t.map(t=>G_getEntityFromEntMap(t,e))),G_DEBUG)for(let t=0;t<e.resources.length;t++){const t=G_getEntityFromEntMap(e.resources.length,e),{x:n,y:a,r:o}=t,{x:l,y:s}=x(n,a);m(l,s,o*G_SCALE,"white")}},S=e=>{if(!e)return;const{planets:t,players:n}=e;if(y(),c(),w(n.map(t=>G_getEntityFromEntMap(t,e))),$(t.map(t=>G_getEntityFromEntMap(t,e))),G_DEBUG)for(let t=0;t<e.resources.length;t++){const n=G_getEntityFromEntMap(e.resources.length,history[t]),{x:a,y:o,r:l}=n,{x:s,y:r}=x(a,o);m(s,r,l*G_SCALE,"white")}},w=e=>{for(let t=0;t<e.length;t++){const{x:n,y:a,r:o,color:l,target:s,dead:r}=e[t],{x:i,y:c}=x(n,a),d=2*o*G_SCALE-10,p=d/2,[y,u]=l===he()?fe():s,{x:f,y:b}=x(y,u),G=v("pl-"+l);G.style.left=i-100+"px",G.style.top=c-75+"px",r?G.style.opacity=0:(m(i,c,o*G_SCALE,_("dark",l)),g(i-p,c-p,d,d,_("",l)),g(i-5,c-30,10,60,"white",h(i,c,f,b)),m(i,c,p/1.5,_("light",l)))}},$=t=>{const a=120/G_SCALE,o=840/G_SCALE;for(let e=0;e<t.length;e++){const{px:n,py:l,mass:s}=t[e],{x:r,y:i}=x(n,l),c=G_normalize(s,G_MASS_MIN,G_MASS_MAX,a,o),p=d().createRadialGradient(r,i,20,r,i,c*G_SCALE);p.addColorStop(0,"#0d0d0d"),p.addColorStop(1,"transparent"),m(r,i,800,p)}for(let a=0;a<t.length;a++){const{px:o,py:l,r:r,color:i}=t[a],{x:c,y:d}=x(o,l),p=Math.min(Math.max(G_normalize(n,s,s+9e3,0,1),0),1);m(c,d,r*G_SCALE,e(i,"0.9")),m(c,d,r*G_SCALE*(1-p),_("dark",i))}},A=(e,t)=>{for(let n=0;n<e.length;n++){const{meta:a,px:o,py:l,r:s}=e[n],{x:r,y:i}=x(o,l);m(r,i,s*G_SCALE,se(a.player,t).color),u(r,i,s*G_SCALE,_("light",se(a.player,t).color))}};let C=null,k=null,T=null,L=null,D=null,F=null,I=0,R=[],N=[],j=!1,O="menu",B=null,P=!1,Y=G_action_shoot,X="Normal",U=!1,H=[0,0],J=null,q=null,W="blue",z="",V=!1,Z=null,K=null,Q=null,ee=!1,te=0,ne=!0,ae=1,oe=0,le=["dialog","game","lobby","menu"];const se=(e,t)=>G_getEntityFromEntMap(e,t),re=e=>{const{players:t}=e||{};for(let n=0;n<t.length;n++){const a=G_getEntityFromEntMap(t[n],e);if(a.id===_e())return a}return t[0]},ie=()=>U,ce=()=>P,de=()=>V,pe=()=>F,ye=()=>R,me=()=>N,ue=()=>X,ge=()=>Y,he=()=>W,_e=()=>C,fe=()=>H,be=()=>J,Ge=()=>z,Ee=()=>I,xe=()=>Z,ve=()=>ee,Me=()=>K,Se=()=>te,we=()=>ne,$e=()=>{const e=ge(),t=Kt[e];return t?t.getArgs():{}},Ae=()=>ae,Ce=()=>oe,ke=e=>j=e,Te=e=>U=e,Le=e=>P=e,De=e=>V=e,Fe=e=>D=e,Ie=e=>F=e,Re=e=>R=e,Ne=e=>N=e,je=e=>X=e,Oe=e=>Y=e,Be=e=>k=e,Pe=e=>T=e,Ye=e=>C=e,Xe=e=>L=e,Ue=e=>H=e,He=e=>J=e,Je=e=>q=e,qe=e=>Z=e,We=e=>{Q=e;const t=JSON.stringify(Q);try{localStorage.setItem("js13k2020_orbital_forts_replay",t)}catch(e){}},ze=e=>ee=e,Ve=e=>te=e,Ze=e=>{ne=e,localStorage.setItem("js13k2020_orbital_forts_sound",e)},Ke=localStorage.getItem("js13k2020_orbital_forts_replay");if(Ke)try{We(JSON.parse(Ke))}catch(e){}const Qe=localStorage.getItem("js13k2020_orbital_forts_sound");null!==Qe&&Ze("true"===Qe),window.events={async create(e){rt("button"),Mt(v("player-name-input").value.trim()||"Player");const{result:n,err:a}=await t(G_R_CREATE,`${_e()}/${encodeURIComponent(Ge())||_e()}/${!!e}`);if(!a){const{id:t,name:a}=n;Be(t),Pe(t),Xe(a||"Game Name"),e||(Et("lobby"),qt(n.lobbyData)),e&&await window.events.start()}},async join(e){rt("button"),Mt(v("player-name-input").value.trim()||"Player");const{result:n,err:a}=await t(G_R_JOIN,`${_e()}/${e},${encodeURIComponent(Ge())}`);if(a)wt("Could not join game.");else{const{id:e,name:t,lobbyData:a}=n;Be(e),Xe(t),Pe(e),Et("lobby"),qt(a)}},async leave(){rt("button");try{await t(G_R_LEAVE,""+_e())}catch(e){}Be(null),Pe(null),Et("menu")},async start(){await t(G_R_START,`${_e()}/${Ee()}`)},async setMapIndex(e){let t=v(e).value;I=parseInt(t),"lobby-map-select"===e&&await window.events.updateLobby()},async confirmAction(){rt("button3");const e=ge();let n=[...fe(),ue(),JSON.stringify($e())].join(",");const a=G_getActionCost(e),o=re(be()),{x:l,y:s}=x(o.x,o.y);Yt(l,s-30,"-$"+a,_("light",he())),ft(!0),Te(!0);const{err:r}=await t(G_R_CONFIRM_ACTION,`${_e()}/${e}/${n}`);r&&Te(!1),ft(!1)},setAction(e){rt("button2"),Oe(e),Ut(be())},setSpeed(e){rt("button2"),je(e),Ut(be())},setTarget(e){e.preventDefault(),e.stopPropagation(),!D||ie()||ce()||ve()||$t(e)},centerCam(){Gt()},async returnToMenu(){rt("button"),ft(!0),ve()?(kt(),Ct()):(ht(),ut()),await window.events.leave(),He(null),Be(null),Et("menu")},hideDialog(){Et(B)},async updateLobby(){const e=""+Ee();await t(G_R_UPDATE_LOBBY,`${_e()}/${e}`)},viewLastReplay(){rt("button");const e=JSON.parse(JSON.stringify(Q));e?At(e):wt("No recent replay found.")},replayNextRound(){rt("button"),Tt()},toggleSound(){const e=we();Ze(!e),Zt()}};let et,tt,nt,at=v("c"),ot=0;at.addEventListener("touchend",e=>{if(Ft)return;let t=+new Date;t-ot<500&&(window.events.setTarget(e),e.preventDefault()),ot=t}),at.addEventListener("contextmenu",window.events.setTarget),tt=.3,et=(e=1,t=.05,n=220,a=0,o=0,l=.1,s=0,r=1,i=0,c=0,d=0,p=0,y=0,m=0,u=0,g=0,h=0,_=2*Math.PI,f=44100,b=(e=>2*e*Math.random()-e),G=(e=>0<e?1:-1),E=(i*=500*_/f**2),x=(n*=(1+b(t))*_/f),v=G(u)*_/4,M=[],S=0,w=0,$=0,A=1,C=0,k=0,T=0,L,D,F,I=nt.createBufferSource())=>{for(c*=500*_/f**3,D=(a=99+a*f|0)+(o=o*f|0)+(l=l*f|0)+(h=h*f|0),u*=_/f,d*=_/f,p*=f,y*=f;$<D;M[$++]=T)++k>100*g&&(k=0,T=S*n*Math.sin(w*u-v),T=G(T=s?1<s?2<s?3<s?Math.sin((T%_)**3):Math.max(Math.min(Math.tan(T),1),-1):1-(2*T/_%2+2)%2:1-4*Math.abs(Math.round(T/_)-T/_):Math.sin(T))*Math.abs(T)**r,T*=e*tt*($<a?$/a:$<a+o?1:$<D-h?1-($-a-o)/l:0),T=h?T/2+(h>$?0:($<D-h?1:($-D)/h)*M[$-h]/2):T),S+=1+b(m),w+=1+b(m),n+=i+=c,A&&++A>p&&(x+=d,n+=d,A=0),y&&++C>y&&(n=x,i=E,C=1,A=A||1);(F=nt.createBuffer(1,M.length,f)).getChannelData(0).set(M),I.buffer=F,I.connect(nt.destination),I.start()},nt=new AudioContext;const lt={button:[,,204,,,.06,,1.39,64,-17,,,,,-17,.2,.26],button2:[,,1107,.01,,.01,1,.14,,,,,,.5,31,.1,.44],button3:[,,313,,,.08,1,1.74,,,322,.66,,.1,-20,.1,.44],expl:[,,366,,.06,.28,3,2.51,-4.7,-.5,,,,.1,.1,.3,.06],getSpreadFire:[,,252,,,.23,2,.65,,,,,,1.6,-7.5,,.04],getCluster:[,,80,,,.41,2,2.53,1.3,-.8,,,,.7,.4,.1,.17],getPC:[,,1343,,.02,.23,1,.98,,,928,.06,.01],lobby:[,,531,.05,,.05,3,,,-.1,783,1.22,,1.4,,,.12],wormhole:[,,192,.01,.26,.01,,.56,,28,,,,.7,,,.16],playerDead:[,,385,,.1,.45,4,1.32,,,,,,.9,,.1,.11],playerDead2:[,,378,,.06,.97,1,3.63,.4,,,,,.5,-.4,.6],explPlanet:[,,814,.04,.23,1.86,4,1.78,,.3,,,,.9,-.9,.4],shootNorm:[,,528,.02,,.25,3,1.62,,-.6,,,,3.6,,.1,.01],shootNorm2:[,,223,,.07,.16,3,.92,,,,,,1.6,-.9,.3,.07],shootPC:[,,254,,,.48,3,.13,-1.1,,,,,2,,.1,.07],explLarge2:[,,997,.04,.06,.87,3,1.23,,100,,,,1.8,1,.8],explCluster:[,,273,,,.36,3,.01,,,,,,.2,.6,.3,.04],coin:[,,1250,,.04,.21,,1.56,,,706,.04,,,,,.05],start:[,,427,.01,.37,1.55,1,3.3,.4,.5,,,,.2,.2,.1,.36],win:[,,10,.22,.18,.93,2,.9,,-.9,150,.06,.09],lose:[,,31,.03,.24,.95,3,2.76,.1,,,,,.7,,.7],tie:[,,393,.03,.57,.11,1,1.65,,,4,.58,,.5,,.6],idk:[,,35,.5,.42,.34,,.49,,,258,.05,.25,,,,.13]},st={},rt=e=>{we()&&(tt=st[e]||.3,et(...lt[e]||lt.idk))};let it={},ct={};const dt=()=>{let e=v("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),Mt(St()),t(),it=function(e,t){let n=(t=t||{}).minScale?t.minScale:.1,a=t.maxScale?t.maxScale:1,o=t.increment?t.increment:.2,l=!!t.liner&&t.liner;return function(e,t,n,a,o){const l=a,s=t,r=n,i=o;let c=!1,d=!1,p=0,y=0,m=0;e.style.transform="matrix(1, 0, 0, 1, 0, 0)";const u=()=>{let t=e.style.transform,n=t.indexOf("(")+1,a=t.indexOf(")"),o=t.slice(n,a).split(",");return{scale:+o[0],transX:+o[4],transY:+o[5]}},g=t=>{e.style.transform="matrix("+t.scale+", 0, 0, "+t.scale+", "+t.transX+", "+t.transY+")"},h=(e,t)=>{let n=u();n.transX+=e,n.transY+=t,g(n)},_=(t,n,a,o)=>{let l=o||u(),c=n-(e.width?e.width:e.offsetWidth)/2,d=a-(e.height?e.height:e.offsetHeight)/2;l.scale+=t=i?t:t*l.scale;let p=l.scale<=s||l.scale>=r;l.scale<s&&(l.scale=s),l.scale>r&&(l.scale=r),p||(h(c,d),g(l),h(-c*t,-d*t))},f=(e,t,n,a)=>Math.round(Math.sqrt(Math.pow(n-e,2)+Math.pow(a-t,2))),b=(e,t,n,a)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,a)+Math.abs(a-t)/2}),G=e=>{const{clientX:t,clientY:n}=e[1],{clientX:a,clientY:o}=e[0];return{center:b(t,n,a,o),d:f(t,n,a,o)}};e.addEventListener("mousedown",e=>{0===e.button&&(e.preventDefault(),c=!0,p=e.clientX,y=e.clientY)}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(c=!0,n>=2){d=!0,Ft=!0;const{center:{x:e,y:n},d:a}=G(t);m=a,p=e,y=n}else p=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",e=>{0===e.button&&(c=!1,d=!1,Ft=!1)}),e.addEventListener("mouseleave",()=>{d=!1,c=!1,Ft=!1}),e.addEventListener("touchend",e=>{0===e.touches.length&&(c=!1,d=!1,Ft=!1)}),e.addEventListener("mousemove",e=>{c&&(h(e.clientX-p,e.clientY-y),p=e.clientX,y=e.clientY)}),e.addEventListener("touchmove",t=>{const n=t.touches;if(c||d){let a=0,o=0;if(n.length>=2){const{center:{x:t,y:l},d:s}=G(n);if(a=t-p,o=l-y,h(a,o),p=t,y=l,Math.abs(s-m)>2){const n=u(),a=e.getBoundingClientRect();_(s>m?.042:-.042,Math.round((t-a.left)/n.scale),Math.round((l-a.top)/n.scale)),m=s}}else if(!d){const e=t.touches[0];a=e.clientX-p,o=e.clientY-y,h(a,o),p=e.clientX,y=e.clientY}}});const E=e=>{_(Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))<0?-l:l,e.offsetX,e.offsetY)};return e.addEventListener("DOMMouseScroll",E,!1),e.addEventListener("mousewheel",E,!1),{translateZoom:({x:t,y:n,scale:a})=>{_(a-1,t,n,{scale:1,transX:-(t-e.offsetWidth/2),transY:-(n-e.offsetWidth/2)}),p=t,y=n}}}(document.getElementById("cc"),n,a,o,l)}(0,[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},pt=e=>{He(e),Je({}),Re([]),Ne([]),Et("game"),Pe(null);const{players:t,width:n,height:a}=e;((e,t)=>{const n=v("c");n.width=e,n.height=t})(2*n*G_SCALE,2*a*G_SCALE);const o=re(e);je("Normal"),Oe(G_action_shoot),W=o.color,ct={};const l=v("players");p(l,"");for(let n=0;n<t.length;n++){const a=G_getEntityFromEntMap(t[n],e),{x:o,y:s,name:r,color:i}=a,c=document.createElement("div");p(c,r),c.className="player-name",c.id="pl-"+i;const{x:d,y:y}=x(o,s);c.style.left=d-100+"px",c.style.top=y-75+"px",c.style.color=_("light",i),l.appendChild(c)}Te(!1),Le(!1),De(!1),Ot(e.resources.map(t=>G_getEntityFromEntMap(t,e))),b(()=>{S(e)})},yt=e=>{const{resources:t}=e;for(let n=0;n<t;n++){const a=G_getEntityFromEntMap(t[n],e);v("res-"+a.id)||jt(a)}[...v("res").children].map(e=>{const t=e.children;return{resourceId:t[t.length-1].id.slice(4),child:e}}).forEach(({resourceId:e,child:n})=>{t.find(t=>t===e)||n.remove()})},mt=e=>{Fe(!0),ze(!1),pt(e);const t=re(e);v("particles").innerHTML="",Ue([t.x,t.y+100]),Gt(),Ut(e)},ut=()=>{ht(be()),Et("menu"),Be(null),He(null),Fe(!1)},gt=(e,t)=>{let n;He(e),Te(!1),Le(!0),v("particles").innerHTML="",M(e),Ne([]),setTimeout(()=>{rt("shootNorm")},G_GAME_TIME_BUFFER_MS);let o=+new Date,l=0,s=0;setTimeout(()=>{b(()=>{n=+new Date;let r=n-G_GAME_TIME_BUFFER_MS-o;const i=ye();if(i.length){let n=!1,a=i[s],o=i[s+1];for(;o&&o.timestamp<=r;)a=o,s+=1,o=i[s+1],n=!0;if(n){const n=e.entMap;for(let e in a.dynamicGameData.partialEntMap)n[e]=a.dynamicGameData.partialEntMap[e];if(He({...be(),...a.dynamicGameData,entMap:n}),a.last){Lt(a.dynamicGameData);const e=be();return void(t?t(e):ht(e))}Lt(a.dynamicGameData)}}let c=be(),{projectiles:d,planets:p,players:y,resources:m}=c;const u=d.map(e=>G_getEntityFromEntMap(e,c)),g=u.concat(p.map(e=>G_getEntityFromEntMap(e,c))),h=y.map(e=>G_getEntityFromEntMap(e,c)).concat(m.map(e=>G_getEntityFromEntMap(e,c)));G_applyGravity(u,g,h,a),M(c),en(c),_t(c,r),l++,l%10==0&&Dt(c)})},G_GAME_TIME_BUFFER_MS)},ht=e=>{if(clearInterval(-1),b(()=>{const e=be();S(e)}),Le(!1),je("Normal"),Oe(G_action_shoot),Re([]),e){He(e),en(e),yt(e);const t=re(e);t.actions[ge()]||Oe(G_action_shoot),Ut(e);for(let t=0;t<e.projectiles.length;t++){const n=G_getEntityFromEntMap(e.projectiles[t],e),{x:a,y:o,meta:l}=x(n.px,n.py);Pt(a,o,l&&"Move"===l.type?"mv":"sm"),rt("expl")}e.projectiles=[],M(e),en(e);const{x:n,y:a}=x(t.x,t.y);if(!t.dead){const t=e.baseFundsPerRound;p(v("banner-message3"),`All players granted $${t}.`),setTimeout(()=>{Yt(n,a-30,"+$"+t,_("light",he()))},500),setTimeout(()=>{p(v("banner-message3"),"")},3e3)}}},_t=(e,t)=>{const n=e.projectiles;for(let a=0;a<n.length;a++){const o=G_getEntityFromEntMap(n[a],e),{meta:l,px:s,py:r}=o;if(l.player&&l.type===G_action_move&&t<=o.t){const t=se(l.player,e);t.x=s,t.y=r}}},ft=e=>{ke(e)};let bt=-1;const Gt=()=>{const e=re(be()),{x:t,y:n}=x(e.x,e.y),a=v("cc").style;a.transition="transform 0.5s",it.translateZoom({x:t,y:n,scale:.65}),clearTimeout(bt),bt=setTimeout(()=>{a.transition=""},500)},Et=(e,t)=>{O=e,le.forEach(n=>{const a=v(n);let o="none";e===n&&(o="flex",t&&t()),a.style.display=o})},xt=e=>{B=O,Et("dialog"),v("dialog-text").innerHTML=e},vt=e=>{if(be()&&e.result){const t=G_getEntityFromEntMap(e.result,e);t?t===re(e)?rt("win"):rt("lose"):rt("tie"),Fe(!1),De(!0),He(e),Ut(e),M(e)}},Mt=e=>{v("player-name-input").value=e,z=e,localStorage.setItem("js13k2020_orbital_forts_u",e)},St=()=>Ge()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",wt=e=>{ut(),Jt([]),Et("menu"),xt(e)},$t=e=>{let t=v("c");if(e.changedTouches){const n=e.changedTouches[0],a=t.parentElement.style.transform,{left:o,top:l}=t.getBoundingClientRect(),s=parseFloat(a.slice(7,a.indexOf(",")));let{x:r,y:i}=E((n.clientX-o)/s,(n.clientY-l)/s);Ue([r,i])}else{const{offsetX:t,offsetY:n}=e;let{x:a,y:o}=E(t,n);Ue([a,o])}ve()?(Vt(be()),M(be())):(Ut(be()),M(be()))},At=e=>{if(!e)throw Error("no replay provided to start");const{initialGameData:t}=e;ze(!0),De(!1),Ve(0),K=e,Vt(e,t),pt(t);const n=re(t);Ue([n.x,n.y+100]),Gt()},Ct=()=>{const e=Me(),t=be();e&&t&&(De(!0),Vt(e,t))},kt=()=>{const e=Me(),t=be();if(clearInterval(-1),b(()=>{const e=be();S(e)}),Le(!1),t){Vt(e,t);for(let e=0;e<t.projectiles.length;e++){const n=t.projectiles[e],{x:a,y:o,meta:l}=x(n.px,n.py);Pt(a,o,l&&"Move"===l.type?"mv":"sm"),rt("expl")}t.projectiles=[],M(t),en(t);const n=Se();if(n+1>e.rounds.length)t.result=e.result,Ct();else{const a=e.rounds[n];if(a.dynamicGameData){const e={...t,...a.dynamicGameData};He(e),yt(e)}}}},Tt=()=>{if(!ve())return;const e=Me(),t=Se(),n=e.rounds[t];n&&(((e,t)=>{let n=be();e.dynamicGameData&&(He({...n,...e.dynamicGameData}),n=be()),Te(!1),Le(!0),v("particles").innerHTML="",Vt(t,n),M(n),Re([n]),setTimeout(()=>{rt("shootNorm")},G_GAME_TIME_BUFFER_MS);const a=re(n);a&&e.actions[a.id]&&Ue(e.actions[a.id].target);for(let t in e.actions){const a=e.actions[t],o=se(t,n);G_applyAction(n,o,a)}Re(e.snapshots.map((t,n)=>({timestamp:t.timestamp,dynamicGameData:t.dynamicGameData,last:n===e.snapshots.length-1}))),gt(n,kt)})(n,e),Ve(t+1))},Lt=e=>JSON.parse(JSON.stringify(e)),Dt=e=>{const t=me();t.push(Lt(e)),t.length>500&&t.shift()};let Ft=!1;document.addEventListener("touchmove",(function(e){void 0!==(e=e.originalEvent||e).scale&&1!==e.scale&&e.preventDefault()}),!1);const It={0:"#00f",1:"#00f",2:"red",3:"red",4:"yellow",5:"yellow",6:"cyan",7:"cyan",8:"orange",9:"orange",10:"green",11:"green"};let Rt=0;const Nt=(e,t,n,a,o,l,s)=>{s=s||{};const r={position:"absolute",left:a+"px",top:o+"px",...s},i=document.createElement("div");i.className=n,"string"==typeof t?p(i,t):i.appendChild(t),i.id=l;for(let e in r)i.style[e]=r[e];return e.appendChild(i),i},jt=e=>{const t=v("res"),{x:n,y:a,id:o,type:l}=e;let{label:s,content:r,offsetTop:i,elem:c}=G_res_sprites[l]||{};const d=l===G_res_wormhole;let p="",y="";const{x:m,y:u}=x(n,a),g=document.createElement(c);g.innerHTML=s||"";const h=Nt(g,r||"","resource "+l,m-100,u-i,"res-"+o);if(d){const e=It[Rt];p=e,y=`radial-gradient(circle at 50% 120%, ${e}, ${e} 10%, rgb(75, 26, 63) 80%, #062745 100%)`,h.children[0].style.background=`radial-gradient(circle at 50% 0px, ${e}, rgba(255, 255, 255, 0) 58%)`,Rt++}p&&(h.style.color=p),y&&(h.style.background=y),g.style.left=h.style.left,g.style.top=h.style.top,g.className="res2 centered",h.style.position="unset",t.appendChild(g)},Ot=e=>{const t=v("res");p(t,""),Rt=0;for(let t=0;t<e.length;t++)jt(e[t])},Bt=(e,t,n,a)=>{for(let o=0;o<a;o++){const{x:l,y:s}=G_getRandomLocInCircle(e,t,n),{x:r,y:i}=x(l,s);setTimeout(()=>{Pt(r,i)},o/a*800)}},Pt=(e,t)=>{const n=e+","+t;v(n)||Nt(v("particles"),"","expl",e-50,t-50,n)},Yt=(e,t,n,a)=>{const o="text,"+e+","+t;v(o)||Nt(v("particles"),n,"text-particle",e-100,t,o,{color:a})},Xt=(e,t)=>{for(let n=0;n<10;n++){const a=G_normalize(n,0,10,0,360),o=`worm${n},${e},${t}`;if(v(o))return;Nt(v("particles"),'<div class="worm"></div>',"",e,t,o,{transform:`rotateZ(${a}deg)`})}},Ut=e=>{if(!e)return;const t=re(e),n=j,a=de(),o=t.dead,l=ie();v("controls").style.display=ce()||l||a||o?"none":"flex",v("center-self").style.display="block",v("confirm-button").style.display="block",v("control-panel").style.display="flex",v("leave-game").style.display=a||o?"block":"none",v("view-last-replay").style.display=a?"block":"none";let s="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],a=e===ue()?f(he()):"";s+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${t}</div>\n<div class="action" style="${a}" id="${e}" onclick="events.setSpeed('${e}')" onmousedown="events.setSpeed('${e}')">${e}\n</div>\n</div>`}),p(v("speed-buttons"),s),v("back-practice").style.display=1===be().players.length?"block":"none";let r="";G_actions.forEach(([e,n],a)=>{const o=t.actions[e];o&&(r=Wt(e+(o<99?` (${o})`:""),"$"+n,e,a>1)+r)}),p(v("action-buttons"),r);const i=G_getActionCost(ge())+G_getSpeedCost(ue());v("confirm-button").disabled=i>t.funds,p(v("funds"),"Funds: $"+t.funds);let c=v("target");const d=fe(),{x:y,y:m}=x(d[0],d[1]);c.style.display=ce()||a||o?"none":"flex",c.style.left=y-30+"px",c.style.top=m-30+"px",c.style.stroke=_("",he()),c.className="target";const u=v("x").cloneNode(!0);u.id="x2",u.style.display="block",p(c,""),c.appendChild(u),Ht(e),Qt()},Ht=(e,t,n)=>{const a=re(e),o=de(),l=a.dead,s=ie(),r=v("banner-message"),i=v("banner-message2");if(p(r,""),p(i,""),o){const t=se(e.result,e);return p(r,"The Game is Over!"),void p(i,t?`The Victor is <span style="${f(t.color)}">${t.name}</span>!`:"The result is a DRAW!")}if(n)p(r,"Viewing replay: "+n.name);else if(l)p(r,"You have been eliminated!");else if(!ce())if(s){const e=(t=t||q).playersNotReady||[];if(0===e.length)return;p(r,"Waiting for other players: "+e.map(({playerName:e,color:t})=>`<span style="${f(t)}">${e}</span>`).join(", "))}else p(r,`You are the <span style="${f(a.color)}border:1px solid;padding:2px;">${a.color}</span> player.`),p(i,`<span style="color:${_("light",a.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${_("light",a.color)}">[Left Click/Tap]</span> to pan.`)},Jt=e=>{const t=v("games");p(t,"");for(let n=0;n<e.length;n++){const{id:a,name:o}=e[n];t.innerHTML+=`<button class="join-button" onclick="events.join('${a}')">${n+1}. Join Game: ${o}</button>`}e.length||p(t,'<span style="color:lightblue"> There are no joinable games at the moment.</span>'),p(v("map-select-practice"),zt({ownerId:_e()},"menu-map-select"))},qt=e=>{const{players:t}=e,n=v("players-lobby");p(n,"");for(let e=0;e<t.length;e++){const{id:a,userName:o}=t[e];n.innerHTML+=`<div class="lobby-player">${e+1}. ${a===_e()?`<a class="lobby-name">${o}</a>`:o}</div>`}const a=t[0].id===_e(),o=t.length>1&&t.length<=4,l=v("map-select");l.parentElement.style.padding=a?"":"0.5rem 0",p(l,zt(e,"lobby-map-select")),p(v("lobby-title"),L),p(v("player-count"),`<a style="color:${o?"#12a012":"red"}">${t.length} of 4</a> joined (at least 2 required to start)`);const s=v("start");s.style.display=a?"block":"none",s.disabled=!o},Wt=(e,t,n,a)=>`<div class="h-button-list">\n<button class="action" onclick="events.setAction('${n}')" onmousedown="events.setAction('${n}')"\nstyle="${ge()===n?f(he()):""};width:80%;margin:2px;animation:${a?"2s linear infinite border-color;":""}">${e}</button>\n<div>${t}</div>\n</div>`,zt=(e,t)=>{const n=_e()===e.ownerId,a=n?Ee():e.mapIndex,o=xe(),l=a>-1&&a<o.length?o[a].name:"Custom Map",s=xe().reduce((e,t,n)=>e+`<option ${a===n?"selected":""} value=${n}>${t.name}</option>`,"");return n?`<select id="${t}" value="${a}" onchange="events.setMapIndex(this.id)">${s}</select>`:`<span style="color:lightblue;">${l}</span>`},Vt=(e,t)=>{if(!e)return;const n=de();v("controls").style.display=ce()?"none":"flex",v("control-panel").style.display="none",v("center-self").style.display="none",v("leave-game").style.display="none",v("view-last-replay").style.display="none",v("back-practice").style.display="block",v("confirm-button").style.display="none",v("controls-additional").style.display="none",p(v("speed-buttons"),""),p(v("action-buttons"),n?'\n<button onclick="events.viewLastReplay()">Restart Replay</button>\n    ':'\n  <button onclick="events.replayNextRound()">Simulate Round</button>\n    ');const a=Se();p(v("funds"),"Current Round: "+Math.min(a+1,e.rounds.length)+"/"+e.rounds.length),v("target").style.display="none",Ht(t,null,e)},Zt=()=>{const e=we(),t=v("sound");t.style.background="white",t.src=e?"sound.svg":"no-sound.svg"},Kt={[G_action_cluster]:{render:()=>{const e=Ae(),t=v("controls-slider-input");t.value=e,t.min=.25,t.max=2,t.step=.25;const n=e=>{p(v("controls-slider-input-label"),"Lifetime: x"+e)};t.onchange=e=>{ae=e.target.value,Kt[G_action_cluster].render()},t.oninput=e=>{n(e.target.value)},v("controls-slider").style.display="block",n(e)},getArgs:()=>({lifetimeMultiplier:Ae()})},[G_action_boomerang]:{render:()=>{const e=Ce(),t=v("controls-slider-input");t.value=e,t.min=0,t.max=360,t.step=1;const n=e=>{let t=+e-135;p(v("controls-slider-input-label"),`<div style="margin:0.5rem; text-align:center"><div class="arrow" style="transform: rotate(${t}deg)"></div></div>\n          <div>Accel. Angle: ${e} deg</div>`)};t.onchange=e=>{oe=e.target.value,Kt[G_action_boomerang].render()},t.oninput=e=>{n(e.target.value)},v("controls-slider").style.display="block",n(e)},getArgs:()=>({accelerationAngle:Ce()})}},Qt=()=>{const e=v("controls-additional");e.style.display=null,Array.prototype.forEach.call(e.children,e=>{"confirm-button"!==e.id&&(e.style.display="none")});const t=ge(),n=Kt[t];n&&n.render()},en=e=>{let t=e.collisions,n=t.length;const a=e=>{const t=(v("res-"+e)||{}).parentElement;return!!t&&(t.remove(),!0)};if(n)for(let o=0;o<n;o++){const[n,l,,s]=t[o];if(ct[s])continue;ct[s]=!0;const r=G_getEntityFromEntMap(n,e);if(!r)continue;const i=G_getEntityFromEntMap(l,e);if(!r)return;const{x:c,y:d}=x(r.px,r.py),p=G_getEntityFromEntMap(r.meta.player,e),y=_("light",p.color);switch(G_getEntityType(i)){case G_entity.player:{if(r.meta.player===i.id)continue;rt("playerDead");const t=G_getEntityFromEntMap(i.id,e),{x:n,y:a}=x(i.x,i.y);t.dead=!0,Yt(n,a,"Eliminated!",y),Bt(t.x,t.y,G_AU/2,7);break}case G_entity.projectile:rt("expl"),Pt(c,d);break;case G_entity.coin:{rt("coin"),Pt(c,d),a(i.id);const{x:e,y:t}=x(i.x,i.y);Yt(e,t,"+$"+i.value,y);break}case G_entity.spray:{rt("getSpreadFire"),Pt(c,d),a(i.id);const{x:e,y:t}=x(i.x,i.y);Yt(e,t,"+2 SpreadFire",y);break}case G_entity.planetCracker:{rt("getPC"),Pt(c,d),a(i.id);const{x:e,y:t}=x(i.x,i.y);Yt(e,t,"+2 PlanetCracker",y);break}case G_entity.cluster:{rt("getCluster"),Pt(c,d),a(i.id);const{x:e,y:t}=x(i.x,i.y);Yt(e,t,"+2 ClusterBomb",y);break}case G_entity.boomerang:{rt("getSpreadFire"),Pt(c,d),a(i.id);const{x:e,y:t}=x(i.x,i.y);Yt(e,t,"+2 Boomerang",y);break}case G_entity.planet:r.meta.type===G_action_planetCracker?(rt("explLarge2"),Bt(i.px,i.py,G_AU,30)):r.meta.type===G_action_move?(rt("playerDead2"),p.dead=!0,Yt(c,d,"Eliminated!",y),Bt(p.x,p.y,G_AU/2,10)):(rt("expl"),Pt(c,d));break;case G_entity.wormhole:{rt("wormhole");const{x:e,y:t}=x(r.meta.prevX,r.meta.prevY);Xt(c,d),Xt(e,t);break}case G_entity.nothing:default:rt("expl"),Pt(c,d)}}}})();