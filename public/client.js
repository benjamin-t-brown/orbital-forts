(()=>{function e(e,t){const n=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),l=parseInt(e.slice(5,7),16);return void 0!==t?"rgba("+n+", "+o+", "+l+", "+t+")":"rgb("+n+", "+o+", "+l+")"}const t=async(e,t,n)=>{ve(!0);const o=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:{key:ae()}}),l=await o.json();if(l[1])throw Error("[FETCH-ERROR] "+l[1]);return ve(!1),{result:l[0],err:l[1]}};let n,o;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on(G_S_CONNECTED,([{games:e,maps:t,id:n,key:o}])=>{Ae(n),je(t),Ee(o),Ct(e)}),e.on(G_S_LIST_UPDATED,([e])=>{Ct(e)}),e.on(G_S_LOBBY_DATA,([e])=>{Mt(e)}),e.on(G_S_GAME_METADATA,([e])=>{Ie(e),kt(ue(),e)}),e.on(G_S_START,([{gameData:e}])=>{tt(e),e.isPractice||Ze("start")}),e.on(G_S_STOP,([e])=>{ct("menu"),dt(e),Ne(null)}),e.on(G_S_START_SIMULATION,([e])=>{ke([e]),nt(e)}),e.on(G_S_STOP_SIMULATION,([e])=>{ke([]),ot(e)}),e.on(G_S_BROADCAST,([{gameData:e,col:t}])=>{Ne(e);const n=re();t||(n.push(e),n.length>500&&n.shift())}),e.on(G_S_FINISHED,([{gameData:e,replay:t}])=>{pt(e),Oe(t)}),e.on("connect",()=>{}),e.on("disconnect",e=>{ht("You disconnected from the game server!")}),e.on("error",e=>{console.error("socket-error",e),ht("An error occurred with the connection to the game server!")}),Qe(),i()},!1)})();let l=!1,s=null,a=+new Date,r=Math.PI;const i=()=>{Dt()},c=()=>{n-a>9e3&&(a=+new Date)},d=()=>w("c").getContext("2d"),p=(e,t)=>{e.innerHTML=t},y=()=>{const e=d(),t=e.canvas;e.clearRect(0,0,t.width,t.height)},u=(e,t,n,o)=>{const l=d();l.beginPath(),l.arc(e,t,n,0,2*r,!1),l.fillStyle=o,l.fill()},h=(e,t,n,o,l,s)=>{const a=d();if(a.save(),a.beginPath(),a.translate(e,t),a.fillStyle=l,void 0!==s){const e=n/2;a.translate(e,o/2),a.rotate(s*r/180),a.fillRect(-e,-o/1.5,n,o)}else a.fillRect(0,0,n,o);a.restore()},m=(e,t,n,o)=>{let l=o-t,s=n-e;const{sqrt:a,asin:i}=Math;let c=a(s*s+l*l),d=0;return d=o>=t&&n>=e?180*i(l/c)/r+90:o>=t&&n<e?180*i(l/-c)/r-90:o<t&&n>e?180*i(l/c)/r+90:180*i(-l/c)/r-90,d>=360&&(d=360-d),d<0&&(d=360+d),isNaN(d)?0:d},g=(e,t)=>({"":{blue:"#44F",yellow:"#cac200"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#FFF60B"}}[e][t]||e+t),f=e=>`background-color:${g("dark",e)};color:${g("light",e)};`,b=e=>{n=+new Date,o=0,s=e;const t=()=>{let e=+new Date;o=e-n,n=e,s(),requestAnimationFrame(t)};l||requestAnimationFrame(t),l=!0},_=()=>{const e=d().canvas,{left:t,top:n}=e.getBoundingClientRect();return{left:t,top:n,width:e.width,height:e.height}},x=(e,t)=>{const{width:n,height:o}=_();return{x:(e-n/2)/G_SCALE,y:-(t-o/2)/G_SCALE}},v=(e,t)=>{const{width:n,height:o}=_();return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+o/2)}},w=e=>document.getElementById(e),G=e=>{const{players:t,planets:n,projectiles:o}=e,l=re();y(),c();for(let t=0;t<l.length;t++){const{projectiles:n}=l[t];for(let t=0;t<n.length;t++){const{px:o,py:l,r:s,meta:a}=n[t],{x:r,y:i}=v(o,l),c=te(a.player,e);u(r,i,s*G_SCALE,g("light",c.color))}}E(n,e),E(o,e),S(t)},$=e=>{if(!e)return;const{planets:t,players:n}=e;y(),c(),S(n),E(t,e)},S=e=>{for(let t=0;t<e.length;t++){const{x:n,y:o,r:l,color:s,target:a,dead:r}=e[t],{x:i,y:c}=v(n,o),d=2*l*G_SCALE-10,p=d/2,[y,f]=s===de()?ye():a,{x:b,y:_}=v(y,f),x=w("pl-"+s);x.style.left=i-100+"px",x.style.top=c-75+"px",r?x.style.opacity=0:(u(i,c,l*G_SCALE,g("dark",s)),h(i-p,c-p,d,d,g("",s)),h(i-5,c-30,10,60,"white",m(i,c,b,_)),u(i,c,p/1.5,g("light",s)))}},E=(t,o)=>{for(let l=0;l<t.length;l++){const{meta:s,px:r,py:i,r:c,color:d}=t[l],{x:p,y:y}=v(r,i);if("planet"===s.type){const t=Math.min(Math.max(G_normalize(n,a,a+9e3,0,1),0),1);u(p,y,c*G_SCALE,e(d,"0.9")),u(p,y,c*G_SCALE*(1-t),g("dark",d))}else u(p,y,c*G_SCALE,te(s.player,o).color)}};let k=null,C=null,M=null,T=null,L=null,A=null,D=0,R=[],N=!1,I="menu",j=null,O=!1,P=G_action_shoot,Y="Normal",B=!1,F=[0,0],X=null,H=null,U="blue",J="",q=!1,W=null,z=null,V=null,Z=!1,K=0,Q=!0,ee=["dialog","game","lobby","menu"];const te=(e,t)=>t.players.reduce((t,n)=>n.id===e?n:t,null),ne=e=>{const{players:t}=e||{};for(let e=0;e<t.length;e++){const n=t[e];if(n.id===pe())return n}return t[0]},oe=()=>B,le=()=>O,se=()=>q,ae=()=>A,re=()=>R,ie=()=>Y,ce=()=>P,de=()=>U,pe=()=>k,ye=()=>F,ue=()=>X,he=()=>J,me=()=>D,ge=()=>W,fe=()=>Z,be=()=>z,_e=()=>K,xe=()=>Q,ve=e=>N=e,we=e=>B=e,Ge=e=>O=e,$e=e=>q=e,Se=e=>L=e,Ee=e=>A=e,ke=e=>R=e,Ce=e=>Y=e,Me=e=>P=e,Te=e=>C=e,Le=e=>M=e,Ae=e=>k=e,De=e=>T=e,Re=e=>F=e,Ne=e=>X=e,Ie=e=>H=e,je=e=>W=e,Oe=e=>{V=e,localStorage.setItem("js13k2020_orbital_forts_replay",JSON.stringify(V))},Pe=e=>Z=e,Ye=e=>K=e,Be=e=>{Q=e,localStorage.setItem("js13k2020_orbital_forts_sound",e)},Fe=localStorage.getItem("js13k2020_orbital_forts_replay");if(Fe)try{Oe(JSON.parse(Fe))}catch(e){}const Xe=localStorage.getItem("js13k2020_orbital_forts_sound");null!==Xe&&Be("true"===Xe),window.events={async create(e){Ze("button"),yt(w("player-name-input").value.trim()||"Player");const{result:n,err:o}=await t(G_R_CREATE,`${pe()}/${encodeURIComponent(he())||pe()}/${!!e}`);if(!o){const{id:t,name:o}=n;Te(t),Le(t),De(o||"Game Name"),e||(ct("lobby"),Mt(n.lobbyData)),e&&await window.events.start()}},async join(e){Ze("button"),yt(w("player-name-input").value.trim()||"Player");const{result:n,err:o}=await t(G_R_JOIN,`${pe()}/${e},${encodeURIComponent(he())}`);if(o)ht("Could not join game.");else{const{id:e,name:t,lobbyData:o}=n;Te(e),De(t),Le(e),ct("lobby"),Mt(o)}},async leave(){if(Ze("button"),!se()||M)try{await t(G_R_LEAVE,""+pe())}catch(e){}Te(null),Le(null),ct("menu")},async start(){await t(G_R_START,`${pe()}/${me()}`)},async setMapIndex(e){let t=w(e).value;D=parseInt(t),"lobby-map-select"===e&&await window.events.updateLobby()},async confirmAction(){Ze("button3");const e=ce();let n=[...ye(),ie()].join(",");const o=G_getActionCost(e),l=ne(ue()),{x:s,y:a}=v(l.x,l.y);$t(s,a-30,"-$"+o,g("light",de())),at(!0),we(!0);const{err:r}=await t(G_R_CONFIRM_ACTION,`${pe()}/${e}/${n}`);r&&we(!1),at(!1)},setAction(e){Ze("button2"),Me(e),Et(ue())},setSpeed(e){Ze("button2"),Ce(e),Et(ue())},setTarget(e){e.preventDefault(),e.stopPropagation(),!L||oe()||le()||mt(e)},centerCam(){it()},async returnToMenu(){Ze("button"),at(!0),C&&await window.events.leave(),Ne(null),Te(null),ct("menu")},hideDialog(){ct(j)},async updateLobby(){const e=""+me();await t(G_R_UPDATE_LOBBY,`${pe()}/${e}`)},viewLastReplay(){Ze("button");const e=JSON.parse(JSON.stringify(V));e?gt(e):ht("No recent replay found.")},replayNextRound(){Ze("button"),ft()},toggleSound(){const e=xe();Be(!e),Dt()}};let He,Ue,Je,qe=w("c"),We=0;qe.addEventListener("touchend",e=>{if(_t)return;let t=+new Date;t-We<500&&(window.events.setTarget(e),e.preventDefault()),We=t}),qe.addEventListener("contextmenu",window.events.setTarget),Ue=.3,He=(e=1,t=.05,n=220,o=0,l=0,s=.1,a=0,r=1,i=0,c=0,d=0,p=0,y=0,u=0,h=0,m=0,g=0,f=2*Math.PI,b=44100,_=(e=>2*e*Math.random()-e),x=(e=>0<e?1:-1),v=(i*=500*f/b**2),w=(n*=(1+_(t))*f/b),G=x(h)*f/4,$=[],S=0,E=0,k=0,C=1,M=0,T=0,L=0,A,D,R,N=Je.createBufferSource())=>{for(c*=500*f/b**3,D=(o=99+o*b|0)+(l=l*b|0)+(s=s*b|0)+(g=g*b|0),h*=f/b,d*=f/b,p*=b,y*=b;k<D;$[k++]=L)++T>100*m&&(T=0,L=S*n*Math.sin(E*h-G),L=x(L=a?1<a?2<a?3<a?Math.sin((L%f)**3):Math.max(Math.min(Math.tan(L),1),-1):1-(2*L/f%2+2)%2:1-4*Math.abs(Math.round(L/f)-L/f):Math.sin(L))*Math.abs(L)**r,L*=e*Ue*(k<o?k/o:k<o+l?1:k<D-g?1-(k-o-l)/s:0),L=g?L/2+(g>k?0:(k<D-g?1:(k-D)/g)*$[k-g]/2):L),S+=1+_(u),E+=1+_(u),n+=i+=c,C&&++C>p&&(w+=d,n+=d,C=0),y&&++M>y&&(n=w,i=v,M=1,C=C||1);(R=Je.createBuffer(1,$.length,b)).getChannelData(0).set($),N.buffer=R,N.connect(Je.destination),N.start()},Je=new AudioContext;const ze={button:[,,204,,,.06,,1.39,64,-17,,,,,-17,.2,.26],button2:[,,1107,.01,,.01,1,.14,,,,,,.5,31,.1,.44],button3:[,,313,,,.08,1,1.74,,,322,.66,,.1,-20,.1,.44],expl:[,,366,,.06,.28,3,2.51,-4.7,-.5,,,,.1,.1,.3,.06],getSpreadFire:[,,252,,,.23,2,.65,,,,,,1.6,-7.5,,.04],getCluster:[,,80,,,.41,2,2.53,1.3,-.8,,,,.7,.4,.1,.17],getPC:[,,1343,,.02,.23,1,.98,,,928,.06,.01],lobby:[,,531,.05,,.05,3,,,-.1,783,1.22,,1.4,,,.12],wormhole:[,,192,.01,.26,.01,,.56,,28,,,,.7,,,.16],playerDead:[,,385,,.1,.45,4,1.32,,,,,,.9,,.1,.11],playerDead2:[,,378,,.06,.97,1,3.63,.4,,,,,.5,-.4,.6],explPlanet:[,,814,.04,.23,1.86,4,1.78,,.3,,,,.9,-.9,.4],shootNorm:[,,528,.02,,.25,3,1.62,,-.6,,,,3.6,,.1,.01],shootNorm2:[,,223,,.07,.16,3,.92,,,,,,1.6,-.9,.3,.07],shootPC:[,,254,,,.48,3,.13,-1.1,,,,,2,,.1,.07],explLarge2:[,,997,.04,.06,.87,3,1.23,,100,,,,1.8,1,.8],explCluster:[,,273,,,.36,3,.01,,,,,,.2,.6,.3,.04],coin:[,,1250,,.04,.21,,1.56,,,706,.04,,,,,.05],start:[,,427,.01,.37,1.55,1,3.3,.4,.5,,,,.2,.2,.1,.36],win:[,,10,.22,.18,.93,2,.9,,-.9,150,.06,.09],lose:[,,31,.03,.24,.95,3,2.76,.1,,,,,.7,,.7],tie:[,,393,.03,.57,.11,1,1.65,,,4,.58,,.5,,.6],idk:[,,35,.5,.42,.34,,.49,,,258,.05,.25,,,,.13]},Ve={},Ze=e=>{xe()&&(Ue=Ve[e]||.3,He(...ze[e]||ze.idk))};let Ke={};const Qe=()=>{let e=w("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),yt(ut()),t(),Ke=function(e,t){let n=(t=t||{}).minScale?t.minScale:.1,o=t.maxScale?t.maxScale:1,l=t.increment?t.increment:.2,s=!!t.liner&&t.liner;return function(e,t,n,o,l){const s=o,a=t,r=n,i=l;let c=!1,d=!1,p=0,y=0,u=0;e.style.transform="matrix(1, 0, 0, 1, 0, 0)";const h=()=>{let t=e.style.transform,n=t.indexOf("(")+1,o=t.indexOf(")"),l=t.slice(n,o).split(",");return{scale:+l[0],transX:+l[4],transY:+l[5]}},m=t=>{e.style.transform="matrix("+t.scale+", 0, 0, "+t.scale+", "+t.transX+", "+t.transY+")"},g=(e,t)=>{let n=h();n.transX+=e,n.transY+=t,m(n)},f=(t,n,o,l)=>{let s=l||h(),c=n-(e.width?e.width:e.offsetWidth)/2,d=o-(e.height?e.height:e.offsetHeight)/2;s.scale+=t=i?t:t*s.scale;let p=s.scale<=a||s.scale>=r;s.scale<a&&(s.scale=a),s.scale>r&&(s.scale=r),p||(g(c,d),m(s),g(-c*t,-d*t))},b=(e,t,n,o)=>Math.round(Math.sqrt(Math.pow(n-e,2)+Math.pow(o-t,2))),_=(e,t,n,o)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,o)+Math.abs(o-t)/2}),x=e=>{const{clientX:t,clientY:n}=e[1],{clientX:o,clientY:l}=e[0];return{center:_(t,n,o,l),d:b(t,n,o,l)}};e.addEventListener("mousedown",e=>{0===e.button&&(e.preventDefault(),c=!0,p=e.clientX,y=e.clientY)}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(c=!0,n>=2){d=!0,_t=!0;const{center:{x:e,y:n},d:o}=x(t);u=o,p=e,y=n}else p=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",e=>{0===e.button&&(c=!1,d=!1,_t=!1)}),e.addEventListener("mouseleave",()=>{d=!1,c=!1,_t=!1}),e.addEventListener("touchend",e=>{0===e.touches.length&&(c=!1,d=!1,_t=!1)}),e.addEventListener("mousemove",e=>{c&&(g(e.clientX-p,e.clientY-y),p=e.clientX,y=e.clientY)}),e.addEventListener("touchmove",t=>{const n=t.touches;if(c||d){let o=0,l=0;if(n.length>=2){const{center:{x:t,y:s},d:a}=x(n);if(o=t-p,l=s-y,g(o,l),p=t,y=s,Math.abs(a-u)>2){const n=h(),o=e.getBoundingClientRect();f(a>u?.042:-.042,Math.round((t-o.left)/n.scale),Math.round((s-o.top)/n.scale)),u=a}}else if(!d){const e=t.touches[0];o=e.clientX-p,l=e.clientY-y,g(o,l),p=e.clientX,y=e.clientY}}});const v=e=>{f(Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))<0?-s:s,e.offsetX,e.offsetY)};return e.addEventListener("DOMMouseScroll",v,!1),e.addEventListener("mousewheel",v,!1),{translateZoom:({x:t,y:n,scale:o})=>{f(o-1,t,n,{scale:1,transX:-(t-e.offsetWidth/2),transY:-(n-e.offsetWidth/2)}),p=t,y=n}}}(document.getElementById("cc"),n,o,l,s)}(0,[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},et=e=>{Ne(e),Ie({}),ke([]),ct("game"),Le(null);const{players:t,width:n,height:o}=e;((e,t)=>{const n=w("c");n.width=e,n.height=t})(2*n*G_SCALE,2*o*G_SCALE);const l=ne(e);Ce("Normal"),Me(G_action_shoot),U=l.color;const s=w("players");p(s,"");for(let e=0;e<t.length;e++){const{x:n,y:o,name:l,color:a}=t[e],r=document.createElement("div");p(r,l),r.className="player-name",r.id="pl-"+a;const{x:i,y:c}=v(n,o);r.style.left=i-100+"px",r.style.top=c-75+"px",r.style.color=g("light",a),s.appendChild(r)}Re([l.x,l.y+100]),it(),we(!1),Ge(!1),$e(!1),w("particles").innerHTML="",vt(e.resources),b(()=>{$(e)})},tt=e=>{Se(!0),Pe(!1),et(e),Et(e)},nt=e=>{Ne(e),we(!1),Ge(!0),w("particles").innerHTML="",Et(e),G(e),Ze("shootNorm"),b(()=>{let e=ue();G_applyGravity(e.projectiles,e.planets,e.players.concat(e.resources),o),G(e),lt(e),st(e)})},ot=e=>{if(b(()=>{$(e)}),Ge(!1),e){Ne(e);const t=ne(e);t.actions[ce()]||Me(G_action_shoot),Et(e);for(let t=0;t<e.projectiles.length;t++){const n=e.projectiles[t],{x:o,y:l,meta:s}=v(n.px,n.py);Gt(o,l,s&&"Move"===s.type?"mv":"sm")}e.projectiles=[],G(e),lt(e);const{x:n,y:o}=v(t.x,t.y);if(!t.dead){const t=e.baseFundsPerRound;p(w("banner-message3"),`All players granted $${t} at completion of the round.`),setTimeout(()=>{$t(n,o-30,"+$"+t,g("light",de()))},500),setTimeout(()=>{p(w("banner-message3"),"")},3e3)}}},lt=e=>{let t=e.collisions,n=t.length;const o=e=>{const t=(w("res-"+e)||{}).parentElement;return!!t&&(t.remove(),!0)};if(n)for(let l=0;l<n;l++){const[n,s]=t[l],{x:a,y:r}=v(n.px,n.py),i=te(n.meta.player,e),c=g("light",i.color);switch(G_getEntityType(s)){case G_entity.player:{if(n.meta.player===s.id)continue;Ze("playerDead");const t=te(s.id,e),{x:o,y:l}=v(s.x,s.y);t.dead=!0,$t(o,l,"Eliminated!",c),wt(t.x,t.y,G_AU/2,7);break}case G_entity.projectile:Ze("expl"),Gt(a,r);break;case G_entity.coin:{Ze("coin"),Gt(a,r),o(s.id);const{x:e,y:t}=v(s.x,s.y);$t(e,t,"+$"+s.value,c);break}case G_entity.spray:{Ze("getSpreadFire"),Gt(a,r),o(s.id);const{x:e,y:t}=v(s.x,s.y);$t(e,t,"+2 SpreadFire",c);break}case G_entity.planetCracker:{Ze("getPC"),Gt(a,r),o(s.id);const{x:e,y:t}=v(s.x,s.y);$t(e,t,"+2 PlanetCracker",c);break}case G_entity.cluster:{Ze("getCluster"),Gt(a,r),o(s.id);const{x:e,y:t}=v(s.x,s.y);$t(e,t,"+2 ClusterBomb",c);break}case G_entity.planet:n.meta.type===G_action_planetCracker?(Ze("explLarge2"),wt(s.px,s.py,G_AU,30)):n.meta.type===G_action_move?(Ze("playerDead2"),i.dead=!0,$t(a,r,"Eliminated!",c),wt(i.x,i.y,G_AU/2,10)):(Ze("expl"),Gt(a,r));break;case G_entity.wormhole:{Ze("wormhole");const{x:e,y:t}=v(n.meta.prevX,n.meta.prevY);St(a,r),St(e,t);break}case G_entity.nothing:Ze("expl"),Gt(a,r)}}e.collisions=[]},st=e=>{const t=e.projectiles;for(let n=0;n<t.length;n++){const{meta:o,px:l,py:s}=t[n];if(o.player&&o.type===G_action_move){const t=te(o.player,e);t.x=l,t.y=s}}},at=e=>{ve(e),Et(ue())};let rt=-1;const it=()=>{const e=ne(ue()),{x:t,y:n}=v(e.x,e.y),o=w("cc").style;o.transition="transform 0.5s",Ke.translateZoom({x:t,y:n,scale:.65}),clearTimeout(rt),rt=setTimeout(()=>{o.transition=""},500)},ct=(e,t)=>{I=e,ee.forEach(n=>{const o=w(n);let l="none";e===n&&(l="flex",t&&t()),o.style.display=l})},dt=e=>{j=I,ct("dialog"),w("dialog-text").innerHTML=e},pt=e=>{if(ue()&&e.result){const t=te(e.result,e);t?t===ne(e)?Ze("win"):Ze("lose"):Ze("tie"),Se(!1),$e(!0),Ne(e),Et(e),G(e)}},yt=e=>{w("player-name-input").value=e,J=e,localStorage.setItem("js13k2020_orbital_forts_u",e)},ut=()=>he()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",ht=e=>{ot(ue()),ct("menu"),Te(null),Ne(null),Se(!1),Ct([]),ct("menu"),dt(e)},mt=e=>{let t=w("c");if(e.changedTouches){const n=e.changedTouches[0],o=t.parentElement.style.transform,{left:l,top:s}=t.getBoundingClientRect(),a=parseFloat(o.slice(7,o.indexOf(",")));let{x:r,y:i}=x((n.clientX-l)/a,(n.clientY-s)/a);Re([r,i])}else{const{offsetX:t,offsetY:n}=e;let{x:o,y:l}=x(t,n);Re([o,l])}fe()?(At(ue()),G(ue())):(Et(ue()),G(ue()))},gt=e=>{if(!e)throw Error("no replay provided to start");const{initialGameData:t}=e;Pe(!0),$e(!1),Ye(0),z=e,At(e,t),et(t)},ft=()=>{if(!fe())return;const e=be(),t=_e(),n=e.rounds[t];n&&(((e,t)=>{let n=ue();e.partialGameData&&(Ne({...n,...e.partialGameData}),n=ue()),we(!1),Ge(!0),w("particles").innerHTML="",At(t,n),G(n),ke([n]),Ze("shootNorm");const o=ne(n);o&&e.actions[o.id]&&Re(e.actions[o.id].target);for(let t in e.actions){const o=e.actions[t],l=te(t,n);G_applyAction(n,l,o)}let l,s=+new Date,a=+new Date,r=0,i=0;b(()=>{let t=ue(),n=+new Date;l=n-s,s=n,G_simulate(t,{startTime:a,nowDt:l,now:s});let o,c=s-a;if(e.snapshots){let n=!1;o=e.snapshots[i];let l=e.snapshots[i+1];for(;l&&l.timestamp<=c;)o=l,l=e.snapshots[i+1],i+=1,n=!0;n&&(t.projectiles=o.snapshot.projectiles,t.collisions=o.snapshot.collisions)}let{projectiles:d,collisions:p}=t;if(r++,r>=10||p.length){r=0;const e=re();e.push(bt(t)),e.length>500&&e.shift()}G(t),lt(t),st(t),Ne(t),0===d.length&&(()=>{const e=be(),t=ue();if(b(()=>{const e=ue();$(e)}),Ge(!1),t){At(e,t);for(let e=0;e<t.projectiles.length;e++){const n=t.projectiles[e],{x:o,y:l,meta:s}=v(n.px,n.py);Gt(o,l,s&&"Move"===s.type?"mv":"sm")}t.projectiles=[];const n=_e();if(n+1>e.rounds.length)t.result=e.result,(()=>{const e=be(),t=ue();e&&t&&($e(!0),At(e,t))})();else{const o=e.rounds[n];o.partialGameData&&Ne({...t,...o.partialGameData})}}})()})})(n,e),Ye(t+1))},bt=e=>JSON.parse(JSON.stringify(e));let _t=!1;const xt=(e,t,n,o,l,s,a)=>{a=a||{};const r={position:"absolute",left:o+"px",top:l+"px",...a},i=document.createElement("div");i.className=n,"string"==typeof t?p(i,t):i.appendChild(t),i.id=s;for(let e in r)i.style[e]=r[e];return e.appendChild(i),i},vt=e=>{const t=w("res");p(t,"");const n={0:"#00f",1:"#00f",2:"red",3:"red",4:"yellow",5:"yellow",6:"cyan",7:"cyan",8:"orange",9:"orange",10:"green",11:"green"};let o=0;for(let l=0;l<e.length;l++){const{x:s,y:a,id:r,type:i}=e[l];let{label:c,content:d,offsetTop:p,elem:y}=G_res_sprites[i]||{};const u=i===G_res_wormhole;let h="",m="";const{x:g,y:f}=v(s,a),b=document.createElement(y);b.innerHTML=c||"";const _=xt(b,d||"","resource "+i,g-100,f-p,"res-"+r);if(u){const e=n[o];h=e,m=`radial-gradient(circle at 50% 120%, ${e}, ${e} 10%, rgb(75, 26, 63) 80%, #062745 100%)`,_.children[0].style.background=`radial-gradient(circle at 50% 0px, ${e}, rgba(255, 255, 255, 0) 58%)`,o++}h&&(_.style.color=h),m&&(_.style.background=m),b.style.left=_.style.left,b.style.top=_.style.top,b.className="res2 centered",_.style.position="unset",t.appendChild(b)}},wt=(e,t,n,o)=>{for(let l=0;l<o;l++){const{x:s,y:a}=G_getRandomLocInCircle(e,t,n),{x:r,y:i}=v(s,a);setTimeout(()=>{Gt(r,i)},l/o*800)}},Gt=(e,t)=>{const n=e+","+t;w(n)||xt(w("particles"),"","expl",e-50,t-50,n)},$t=(e,t,n,o)=>{const l="text,"+e+","+t;w(l)||xt(w("particles"),n,"text-particle",e-100,t,l,{color:o})},St=(e,t)=>{for(let n=0;n<10;n++){const o=G_normalize(n,0,10,0,360),l=`worm${n},${e},${t}`;if(w(l))return;xt(w("particles"),'<div class="worm"></div>',"",e,t,l,{transform:`rotateZ(${o}deg)`})}},Et=e=>{if(!e)return;const t=ne(e),n=N,o=se(),l=t.dead,s=oe();w("controls").style.display=le()||s||o||l?"none":"flex",w("center-self").style.display="block",w("confirm-button").style.display="block",w("control-panel").style.display="flex",w("leave-game").style.display=o||l?"block":"none",w("view-last-replay").style.display=o?"block":"none";let a="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],o=e===ie()?f(de()):"";a+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${t}</div>\n<div class="action" style="${o}" id="${e}" onclick="events.setSpeed('${e}')">${e}\n</div>\n</div>`}),p(w("speed-buttons"),a),w("back-practice").style.display=1===ue().players.length?"block":"none";let r="";G_actions.forEach(([e,n],o)=>{const l=t.actions[e];l&&(r=Tt(e+(l<99?` (${l})`:""),"$"+n,e,o>1)+r)}),p(w("action-buttons"),r);const i=G_getActionCost(ce())+G_getSpeedCost(ie());w("confirm-button").disabled=i>t.funds,p(w("funds"),"Funds: $"+t.funds);let c=w("target");const d=ye(),{x:y,y:u}=v(d[0],d[1]);c.style.display=le()||o||l?"none":"flex",c.style.left=y-30+"px",c.style.top=u-30+"px",c.style.stroke=g("",de()),c.className="target";const h=w("x").cloneNode(!0);h.id="x2",h.style.display="block",p(c,""),c.appendChild(h),kt(e)},kt=(e,t,n)=>{const o=ne(e),l=se(),s=o.dead,a=oe(),r=w("banner-message"),i=w("banner-message2");if(p(r,""),p(i,""),l){const t=te(e.result,e);return p(r,"The Game is Over!"),void p(i,t?`The Victor is <span style="${f(t.color)}">${t.name}</span>!`:"The result is a DRAW!")}if(n)p(r,"Viewing replay: "+n.name);else if(s)p(r,"You have been eliminated!");else if(!le())if(a){const e=(t=t||H).playersNotReady||[];if(0===e.length)return;p(r,"Waiting for other players: "+e.map(({playerName:e,color:t})=>`<span style="${f(t)}">${e}</span>`).join(", "))}else p(r,`You are the <span style="${f(o.color)}border:1px solid;padding:2px;">${o.color}</span> player.`),p(i,`<span style="color:${g("light",o.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${g("light",o.color)}">[Left Click/Tap]</span> to pan.`)},Ct=e=>{const t=w("games");p(t,"");for(let n=0;n<e.length;n++){const{id:o,name:l}=e[n];t.innerHTML+=`<button class="join-button" onclick="events.join('${o}')">${n+1}. Join Game: ${l}</button>`}e.length||p(t,'<span style="color:lightblue"> There are no joinable games at the moment.</span>'),p(w("map-select-practice"),Lt({ownerId:pe()},"menu-map-select"))},Mt=e=>{const{players:t}=e,n=w("players-lobby");p(n,"");for(let e=0;e<t.length;e++){const{id:o,userName:l}=t[e];n.innerHTML+=`<div class="lobby-player">${e+1}. ${o===pe()?`<a class="lobby-name">${l}</a>`:l}</div>`}const o=t[0].id===pe(),l=t.length>1&&t.length<=4,s=w("map-select");s.parentElement.style.padding=o?"":"0.5rem 0",p(s,Lt(e,"lobby-map-select")),p(w("lobby-title"),T),p(w("player-count"),`<a style="color:${l?"#12a012":"red"}">${t.length} of 4</a> joined (at least 2 required to start)`);const a=w("start");a.style.display=o?"block":"none",a.disabled=!l},Tt=(e,t,n,o)=>`<div class="h-button-list">\n<button class="action" onclick="events.setAction('${n}')" style="${ce()===n?f(de()):""};width:80%;margin:2px;animation:${o?"2s linear infinite border-color;":""}">${e}</button>\n<div>${t}</div>\n</div>`,Lt=(e,t)=>{const n=pe()===e.ownerId,o=n?me():e.mapIndex,l=ge(),s=o>-1&&o<l.length?l[o].name:"Custom Map",a=ge().reduce((e,t,n)=>e+`<option ${o===n?"selected":""} value=${n}>${t.name}</option>`,"");return n?`<select id="${t}" value="${o}" onchange="events.setMapIndex(this.id)">${a}</select>`:`<span style="color:lightblue;">${s}</span>`},At=(e,t)=>{if(!e)return;const n=se();w("controls").style.display=le()?"none":"flex",w("control-panel").style.display="none",w("center-self").style.display="none",w("leave-game").style.display="none",w("view-last-replay").style.display="none",w("back-practice").style.display="block",w("confirm-button").style.display="none",p(w("speed-buttons"),""),p(w("action-buttons"),n?'\n<button onclick="events.viewLastReplay()">Restart Replay</button>\n    ':'\n  <button onclick="events.replayNextRound()">Simulate Round</button>\n    ');const o=_e();p(w("funds"),"Current Round: "+Math.min(o+1,e.rounds.length)+"/"+e.rounds.length),w("target").style.display="none",kt(t,null,e)},Dt=()=>{const e=xe(),t=w("sound");t.style.background="white",t.src=e?"sound.svg":"no-sound.svg"}})();