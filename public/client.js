(()=>{const e=async(e,t,n)=>{me(!0);const l=new Headers;l.key=ne();const s=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:l}),o=await s.json();return o[1],me(!1),{result:o[0],err:o[1]}};let t,n;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on(G_S_CONNECTED,([{games:e,maps:t,id:n}])=>{$e(n),Te(t),E(e)}),e.on(G_S_LIST_UPDATED,([e])=>{E(e)}),e.on(G_S_LOBBY_LIST_UPDATED,([e])=>{T(e)}),e.on(G_S_START,([{startTime:e,gameData:t}])=>{Ae(t)}),e.on(G_S_STOP,([e])=>{Ne("menu"),Ie(e),Ee(null)}),e.on(G_S_START_SIMULATION,([e])=>{ve([e]),Me(e)}),e.on(G_S_STOP_SIMULATION,([e])=>{ve([]),De(e)}),e.on(G_S_BROADCAST,([{gameData:e}])=>{Ee(e);const t=le();t.push(e),t.length>500&&t.shift()}),e.on(G_S_FINISHED,([e])=>{Oe(e)}),e.on("connect",()=>{}),e.on("disconnect",e=>{Pe("You disconnected from the game server!")}),e.on("error",e=>{Pe("An error occurred with the connection to the game server!")}),ke()},!1)})();let l=!1,s=null,o=Math.PI;const a=()=>f("c").getContext("2d"),r=(e,t)=>{e.innerHTML=t},i=(e,t,n,l)=>{const s=a();s.beginPath(),s.arc(e,t,n,0,2*o,!1),s.fillStyle=l,s.fill()},c=(e,t,n,l,s,r)=>{const i=a();if(i.save(),i.beginPath(),i.translate(e,t),i.fillStyle=s,void 0!==r){const e=n/2,t=l/2;i.translate(e,t),i.rotate(r*o/180),i.fillRect(-e,-l/1.5,n,l)}else i.fillRect(0,0,n,l);i.restore()},d=(e,t,n,l)=>{let s=l-t,a=n-e;const{sqrt:r,asin:i}=Math;let c=r(a*a+s*s),d=0;return d=l>=t&&n>=e?180*i(s/c)/o+90:l>=t&&n<e?180*i(s/-c)/o-90:l<t&&n>e?180*i(s/c)/o+90:180*i(-s/c)/o-90,d>=360&&(d=360-d),d<0&&(d=360+d),isNaN(d)?0:d},p=e=>`background-color:${h("dark",e)};color:${h("light",e)};`,y=e=>{t=+new Date,n=0,s=e;const o=()=>{let e=+new Date;n=e-t,t=e,s(),requestAnimationFrame(o)};l||requestAnimationFrame(o),l=!0},u=()=>{const e=a().canvas,{left:t,top:n}=e.getBoundingClientRect();return{left:t,top:n,width:e.width,height:e.height}},h=(e,t)=>({"":{blue:"#44F"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#B8860B"}}[e][t]||e+t),m=(e,t)=>{const{width:n,height:l}=u();return{x:(e-n/2)/G_SCALE,y:-(t-l/2)/G_SCALE}},g=(e,t)=>{const{width:n,height:l}=u();return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+l/2)}},f=e=>document.getElementById(e),_=e=>{const{players:t,planets:n,projectiles:l}=e,s=le();(()=>{const e=a(),t=e.canvas;e.fillStyle="#222",e.fillRect(0,0,t.width,t.height)})();for(let t=0;t<s.length;t++){const{projectiles:n}=s[t];for(let t=0;t<n.length;t++){const{px:l,py:s,r:o,meta:a}=n[t],{x:r,y:c}=g(l,s),d=z(a.player,e);i(r,c,o*G_SCALE,h("light",d.color))}}$(t),w(n,e),w(l,e);let o=e.collisions,r=o.length;if(r)for(let t=0;t<r;t++){const[n,l]=o[t],{x:s,y:a}=g(n.px,n.py);if((l&&l.meta||{}).player===n.meta.player)continue;n.meta.type!==G_action_move&&b(s,a);let r=e.projectiles.indexOf(n);if(r>-1&&e.projectiles.splice(r,1),J(l)){const t=z(n.meta.player,e);f("res-"+l.id).remove();let s="";switch(l.type){case G_res_coin:s="+$"+l.value;break;case G_res_spray:s="+2 Spreadfire";break;case G_res_planetCracker:s="+2 PlanetCracker"}const{x:o,y:a}=g(l.x,l.y);S(o,a,s,h("light",t.color))}else l&&l.meta&&"planet"===l.meta.type&&n.meta.type===G_action_planetCracker&&v(l.px,l.py,G_AU,30);const i=l&&V(l,e),c=l&&n.meta.type===G_action_move&&!!l.color;let d=null;if(i?d=z(l.id,e):c&&(d=z(n.meta.player,e)),d){d.dead=!0;const{x:e,y:t}=g(d.x,d.y);S(e,t,"Eliminated!",h("light",d.color)),v(d.x,d.y,G_AU/2,12)}}e.collisions=[]},x=(e,t,n,l,s,o,a)=>{a=a||{};const i={position:"absolute",left:l+"px",top:s+"px",...a},c=document.createElement("div");c.className=n,r(c,t),c.id=o;for(let e in i)c.style[e]=i[e];e.appendChild(c)},v=(e,t,n,l)=>{for(let s=0;s<l;s++){const{x:o,y:a}=G_getRandomLocInCircle(e,t,n),{x:r,y:i}=g(o,a);setTimeout(()=>{b(r,i)},s/l*2e3)}},b=(e,t)=>{const n=e+","+t;f(n)||x(f("particles"),"","expl",e-50,t-50,n)},S=(e,t,n,l)=>{const s="text,"+e+","+t;f(s)||x(f("particles"),n,"text-particle",e-100,t,s,{color:l})},$=e=>{for(let t=0;t<e.length;t++){const{x:n,y:l,r:s,color:o,target:a,dead:r}=e[t],{x:p,y:y}=g(n,l),u=2*s*G_SCALE-10,m=u/2,[_,x]=o===oe()?ie():a,{x:v,y:b}=g(_,x),S=f("pl-"+o);S.style.left=p-100+"px",S.style.top=y-75+"px",r?S.style.opacity=0:(i(p,y,s*G_SCALE,h("dark",o)),c(p-m,y-m,u,u,h("",o)),c(p-5,y-30,10,60,"white",d(p,y,v,b)),i(p,y,m/1.5,h("light",o)))}},w=(e,t)=>{for(let n=0;n<e.length;n++){const{meta:l,px:s,py:o,r:a,color:r}=e[n],{x:c,y:d}=g(s,o),p="planet"===l.type;let y;p||(y=z(l.player,t),!l.player||l.type!==G_action_move)?i(c,d,a*G_SCALE,p?r:y.color):(y.x=s,y.y=o)}},G=e=>{if(!e)return;const t=K(e),n=Q(),l=te(),s=t.dead,o=Z();f("controls").style.display=ee()||o||l||s?"none":"flex",f("leave-game").style.display=l||s?"block":"none";let a="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],l=e===se()?p(oe()):"";a+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${t}</div>\n<div class="action" style="${l}" id="${e}" onclick="events.setSpeed('${e}')">${e}\n</div>\n</div>`}),r(f("speed-buttons"),a),f("back-practice").style.display=he()?"block":"none";let i="";G_actions.forEach(([e,n],l)=>{const s=t.actions[e];s&&(i=((e,t,n,l,s)=>`<div class="h-button-list">\n<button ${l?"disabled":""} onclick="events.confirmAction('${n}')" style="width:136px;margin:2px;animation:${s?"2s linear infinite border-color;":""}">${e}</button>\n<div>${t}</div>\n</div>`)(e+(s<99?` (${s})`:""),"$"+n,e,G_getSpeedCost(se())+n>t.funds,l>1)+i)}),r(f("action-buttons"),i),f("funds").innerHTML="Funds: $"+t.funds;let c=f("target");const d=ie(),{x:y,y:u}=g(d[0],d[1]);c.style.display=ee()||l||s?"none":"flex",c.style.left=y-30+"px",c.style.top=u-30+"px",c.style.stroke=h("",oe()),c.className="target";const m=f("x").cloneNode(!0);m.id="x2",m.style.display="block",r(c,""),c.appendChild(m);const _=f("banner-message"),x=f("banner-message2");if(r(_,o?"Waiting for other players...":l?"The Game is Over!":s?"You have been destroyed!":`You are the <span style="${p(t.color)}border:1px solid;padding:2px;">${t.color}</span> player.`),l){const t=z(e.result,e);r(x,t?`The Victor is <span style="${p(t.color)}">${t.name}</span>!`:"The result is a DRAW!")}else o||ee()||s?r(x,""):r(x,`<span style="color:${h("light",t.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${h("light",t.color)}">[Left Click/Tap]</span> to pan.`)},E=e=>{const t=f("games");r(t,"");for(let n=0;n<e.length;n++){const{id:l,name:s}=e[n];let o=n+1;t.innerHTML+=`<button style="background-color:#225;" onclick="events.join('${l}')">${o}. Join Game: ${s}</button>`}},T=e=>{const t=f("players-lobby");r(t,"");for(let n=0;n<e.length;n++){const{id:l,userName:s}=e[n];let o=n+1;t.innerHTML+=`<div class="lobby-player">${o}. ${l===ae()?`<span class="lobby-name">${s}</span>`:s}</div>`}const n=ue(),l=e[0].id===ae(),s=e.length>1&&e.length<=n.maxPlayers,o=f("lobby-map-select");o.innerHTML=ye().reduce((e,t,n)=>e+`<option value=${n}>${t.name}</option>`,""),o.value=pe(),o.style.display=l?"block":"none",r(f("lobby-title"),re());const a=f("start");a.style.display=l?"block":"none",a.disabled=!s};let L=null,C=null,k=null,A=null,M=null,D=0,Y=[],R=!1,N="menu",I=null,O=!1,X="Normal",j=!1,P=[0,0],H=null,B="blue",F="",U=!1,q=null,W=["dialog","game","lobby","menu"];const J=e=>!!e&&[G_res_coin,G_res_spray,G_res_planetCracker].includes(e.type),V=e=>!(!e.color||!e.target),z=(e,t)=>t.players.reduce((t,n)=>n.id===e?n:t,null),K=e=>{const{players:t}=e||{};for(let e=0;e<t.length;e++){const n=t[e];if(n.id===ae())return n}return null},Q=()=>R,Z=()=>j,ee=()=>O,te=()=>U,ne=()=>M,le=()=>Y,se=()=>X,oe=()=>B,ae=()=>L,re=()=>k,ie=()=>P,ce=()=>H,de=()=>F,pe=()=>D,ye=()=>q,ue=()=>q[D],he=()=>1===ce().players.length,me=e=>R=e,ge=e=>j=e,fe=e=>O=e,_e=e=>U=e,xe=e=>A=e,ve=e=>Y=e,be=e=>X=e,Se=e=>C=e,$e=e=>L=e,we=e=>k=e,Ge=e=>P=e,Ee=e=>H=e,Te=e=>q=e;window.events={async create(t){Xe(f("player-name-input").value);const{result:n,err:l}=await e(G_R_CREATE,`${ae()}/${de()||ae()}/${!!t}`);if(!l){const{id:e,name:l}=n;Se(e),we(l||"Game Name"),Ne("lobby"),T([{id:ae(),userName:de()}]),t&&await window.events.start()}},async join(t){Xe(f("player-name-input").value);const{result:n,err:l}=await e(G_R_JOIN,`${ae()}/${t},${de()||ae()}`);if(l)Pe("Could not join game.");else{const{id:e,name:t,players:l}=n;Se(e),we(t),Ne("lobby"),T(l)}},async leave(){const{err:t}=await e(G_R_LEAVE,""+ae());t||(Se(null),Ne("menu"))},async start(){await e(G_R_START,`${ae()}/${pe()}`)},async setMapIndex(e){void 0===e&&(e=f("lobby-map-select").value),D=e},async confirmAction(t){let n=[...ie(),se()].join(",");const l=G_getActionCost(t),s=K(ce()),{x:o,y:a}=g(s.x,s.y);S(o,a-30,"-$"+l,h("light",oe())),Ye(!0),ge(!0);const{err:r}=await e(G_R_CONFIRM_ACTION,`${ae()}/${t}/${n}`);r&&ge(!1),Ye(!1)},setSpeed(e){be(e),G(ce())},setTarget(e){e.preventDefault(),e.stopPropagation(),!A||Z()||ee()||He(e)},centerCam(){Re()},async returnToMenu(){C&&await window.events.leave(),Ee(null),Se(null),Ne("menu")},hideDialog(){Ne(I)}};let Le=f("c"),Ce=0;Le.addEventListener("touchend",e=>{if(Be)return;let t=+new Date;t-Ce<500&&(window.events.setTarget(e),e.preventDefault()),Ce=t}),Le.addEventListener("contextmenu",window.events.setTarget);const ke=()=>{let e=f("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),Xe(je()),t(),function(e,t){function n(e,t,n,l,s){const o=l,a=t,r=n,i=s;let c=!1,d=!1,p=0,y=0,u=0;e.style.transform="matrix(1, 0, 0, 1, 0, 0)";const h=()=>{let t=e.style.transform,n=t.indexOf("(")+1,l=t.indexOf(")"),s=t.slice(n,l).split(",");return{scale:+s[0],transX:+s[4],transY:+s[5]}},m=t=>{e.style.transform="matrix("+t.scale+", 0, 0, "+t.scale+", "+t.transX+", "+t.transY+")"},g=(e,t)=>{let n=h();n.transX+=e,n.transY+=t,m(n)},f=(t,n,l)=>{let s=h(),o=n-(e.width?e.width:e.offsetWidth)/2,c=l-(e.height?e.height:e.offsetHeight)/2;t=i?t:t*s.scale,s.scale+=t;let d=s.scale<=a||s.scale>=r;s.scale<a&&(s.scale=a),s.scale>r&&(s.scale=r),d||(g(o,c),m(s),g(-o*t,-c*t))},_=(e,t,n,l)=>Math.sqrt(Math.pow(n-e,2)+Math.pow(l-t,2)),x=(e,t,n,l)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,l)+Math.abs(l-t)/2});e.addEventListener("mousedown",e=>{0===e.button&&(e.preventDefault(),c=!0,p=e.clientX,y=e.clientY)}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(c=!0,n>=2){const{clientX:e,clientY:n}=t[1],{clientX:l,clientY:s}=t[0];u=_(e,n,l,s),d=!0,Be=!0;const{x:o,y:a}=x(e,n,l,s);p=o,y=a}else p=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",e=>{0===e.button&&(c=!1,Be=!1)}),e.addEventListener("mouseleave",()=>{c=!1,Be=!1}),e.addEventListener("touchend",e=>{0===e.touches.length&&(c=!1,d=!1,Be=!1)}),e.addEventListener("mousemove",e=>{if(c){let t=e.clientX-p,n=e.clientY-y;g(t,n),p=e.clientX,y=e.clientY}}),e.addEventListener("touchmove",e=>{const t=e.touches,n=t.length;if(c||d){let l=0,s=0;if(n>=2){const{clientX:e,clientY:n}=t[1],{clientX:o,clientY:a}=t[0],r=_(e,n,o,a),{x:i,y:c}=x(e,n,o,a);l=i-p,s=c-y,g(l,s),p=i,y=c;const d=h();f(r>u?.018:-.018,d.tranX,d.transY),u=r}else{const t=e.touches[0];l=t.clientX-p,s=t.clientY-y,g(l,s),p=t.clientX,y=t.clientY}}});const v=e=>{let t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));f(t<0?-o:o,e.offsetX,e.offsetY)};e.addEventListener("DOMMouseScroll",v,!1),e.addEventListener("mousewheel",v,!1)}let l=[],s=(t=t||{}).minScale?t.minScale:.1,o=t.maxScale?t.maxScale:1,a=t.increment?t.increment:.2,r=!!t.liner&&t.liner;document.querySelectorAll(e).forEach((function(e){l.push(new n(e,s,o,a,r))})),1==l.length&&l[0]}("#cc",[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},Ae=e=>{xe(!0),Ee(e),ve([]),Ne("game");const{players:t,width:n,height:l}=e;((e,t)=>{const n=f("c");n.width=e,n.height=t})(2*n*G_SCALE,2*l*G_SCALE);const s=K(e);var o;be("Normal"),o=s.color,B=o;const a=f("players");r(a,"");for(let e=0;e<t.length;e++){const{x:n,y:l,name:s,color:o}=t[e],i=document.createElement("div");r(i,s),i.className="player-name",i.id="pl-"+o;const{x:c,y:d}=g(n,l);i.style.left=c-100+"px",i.style.top=d-75+"px",i.style.color=h("light",o),a.appendChild(i)}Ge([s.x,s.y+100]),Re(),ge(!1),fe(!1),_e(!1),f("particles").innerHTML="",Ne("game"),G(e),(e=>{const t=f("res");r(t,"");for(let n=0;n<e.length;n++){const{x:l,y:s,id:o,type:a}=e[n],{x:r,y:i}=g(l,s),c={[G_res_planetCracker]:"Ck",[G_res_spray]:"Sp",[G_res_coin]:"$"};x(t,c[a],"resource "+a,r-25,i-25,"res-"+o)}})(e.resources),_(e)},Me=e=>{Ee(e),ge(!1),fe(!0),f("particles").innerHTML="",G(e),_(e),y(()=>{let e=ce();G_applyGravity(e.projectiles,e.planets,e.players.concat(e.resources),n),_(e)})},De=e=>{if(y((function(){})),fe(!1),e){Ee(e),G(e);for(let t=0;t<e.projectiles.length;t++){const n=e.projectiles[t],{x:l,y:s,meta:o}=g(n.px,n.py);b(l,s,o&&"Move"===o.type?"mv":"sm")}e.projectiles=[],_(e);const t=K(e),{x:n,y:l}=g(t.x,t.y);t.dead||setTimeout(()=>S(n,l-30,"+$"+e.baseFundsPerRound,h("light",oe())),500)}},Ye=e=>{me(e),G(ce())},Re=()=>{const e=K(ce()),{width:t,height:n}=u(),{x:l,y:s}=g(e.x,e.y),o=f("cc").style;o.transition="transform 0.5s",o.transform=`matrix(1, 0, 0, 1, ${-(l-t/2)}, ${-(s-n/2-2)})`,setTimeout(()=>{o.transition=""},500)},Ne=(e,t)=>{N=e,W.forEach(n=>{const l=f(n);let s="none";e===n&&(s="flex",t&&t()),l.style.display=s})},Ie=e=>{I=N,Ne("dialog"),f("dialog-text").innerHTML=e},Oe=e=>{ce()&&e.result&&(xe(!1),_e(!0),Ee(e),G(e),_(e))},Xe=e=>{f("player-name-input").value=e,F=e,localStorage.setItem("js13k2020_orbital_forts_u",e)},je=()=>de()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",Pe=e=>{De(ce()),Ne("menu"),Se(null),Ee(null),xe(!1),E([]),Ne("menu"),Ie(e)},He=e=>{let t=f("c");if(e.changedTouches){const n=e.changedTouches[0],l=t.parentElement.style.transform,{left:s,top:o}=t.getBoundingClientRect(),a=parseFloat(l.slice(7,l.indexOf(",")));let{x:r,y:i}=m((n.clientX-s)/a,(n.clientY-o)/a);Ge([r,i])}else{const{offsetX:t,offsetY:n}=e;let{x:l,y:s}=m(t,n);Ge([l,s])}G(ce()),_(ce())};let Be=!1})();