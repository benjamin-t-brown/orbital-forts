(()=>{const e=async(e,t,n)=>{xe(!0);const l=new Headers;l.key=se();const o=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:l}),s=await o.json();return s[1]&&console.error("[FETCH-ERROR]",s[1]),xe(!1),console.log("fetch",e,t,s),{result:s[0],err:s[1]}};let t,n;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on(G_S_CONNECTED,([{games:e,maps:t,id:n}])=>{console.log("connected load",{games:e,maps:t,id:n}),Ce(n),Me(t),T(e)}),e.on(G_S_LIST_UPDATED,([e])=>{console.log("game list updated",e),T(e)}),e.on(G_S_LOBBY_LIST_UPDATED,([e])=>{console.log("lobby list updated",e),C(e)}),e.on(G_S_START,([{startTime:e,gameData:t}])=>{console.log("start",e,t),Ne(t)}),e.on(G_S_STOP,([e])=>{console.log("stop",e),Pe("menu"),Fe(e),ke(null)}),e.on(G_S_START_SIMULATION,([e])=>{console.log("begin simulation",e),we([e]),Ie(e)}),e.on(G_S_STOP_SIMULATION,([e])=>{console.log("stop simulation"),we([]),Oe(e)}),e.on(G_S_BROADCAST,([{gameData:e}])=>{ke(e);const t=ae();t.push(e),t.length>500&&t.shift()}),e.on(G_S_FINISHED,([e])=>{console.log("game over",e),He(e)}),e.on("connect",()=>{console.log("connected")}),e.on("disconnect",e=>{console.warn("disconnect",e),Ue("You disconnected from the game server!")}),e.on("error",e=>{console.error("socket-error",e),Ue("An error occurred with the connection to the game server!")}),Ye(),a()},!1)})();let l=!1,o=null,s=Math.PI;const a=()=>{},r=()=>_("c").getContext("2d"),c=(e,t)=>{e.innerHTML=t},i=(e,t,n,l)=>{const o=r();o.beginPath(),o.arc(e,t,n,0,2*s,!1),o.fillStyle=l,o.fill()},d=(e,t,n,l,o,a)=>{const c=r();if(c.save(),c.beginPath(),c.translate(e,t),c.fillStyle=o,void 0!==a){const e=n/2;c.translate(e,l/2),c.rotate(a*s/180),c.fillRect(-e,-l/1.5,n,l)}else c.fillRect(0,0,n,l);c.restore()},p=(e,t,n,l)=>{let o=l-t,a=n-e;const{sqrt:r,asin:c}=Math;let i=r(a*a+o*o),d=0;return d=l>=t&&n>=e?180*c(o/i)/s+90:l>=t&&n<e?180*c(o/-i)/s-90:l<t&&n>e?180*c(o/i)/s+90:180*c(-o/i)/s-90,d>=360&&(d=360-d),d<0&&(d=360+d),isNaN(d)?0:d},y=e=>`background-color:${h("dark",e)};color:${h("light",e)};`,u=e=>{t=+new Date,n=0,o=e;const s=()=>{let e=+new Date;n=e-t,t=e,o(),requestAnimationFrame(s)};l||requestAnimationFrame(s),l=!0},m=()=>{const e=r().canvas,{left:t,top:n}=e.getBoundingClientRect();return{left:t,top:n,width:e.width,height:e.height}},h=(e,t)=>({"":{blue:"#44F",yellow:"#cac200"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#FFF60B"}}[e][t]||e+t),g=(e,t)=>{const{width:n,height:l}=m();return{x:(e-n/2)/G_SCALE,y:-(t-l/2)/G_SCALE}},f=(e,t)=>{const{width:n,height:l}=m();return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+l/2)}},_=e=>document.getElementById(e),x=e=>{const{players:t,planets:n,projectiles:l}=e,o=ae();(()=>{const e=r(),t=e.canvas;e.fillStyle="#222",e.fillRect(0,0,t.width,t.height)})();for(let t=0;t<o.length;t++){const{projectiles:n}=o[t];for(let t=0;t<n.length;t++){const{px:l,py:o,r:s,meta:a}=n[t],{x:r,y:c}=f(l,o),d=Z(a.player,e);i(r,c,s*G_SCALE,h("light",d.color))}}w(t),S(n,e),S(l,e);let s=e.collisions,a=s.length;if(a)for(let t=0;t<a;t++){const[n,l]=s[t],{x:o,y:a}=f(n.px,n.py);if((l&&l.meta||{}).player===n.meta.player)continue;n.meta.type!==G_action_move&&$(o,a);let r=e.projectiles.indexOf(n);if(r>-1&&e.projectiles.splice(r,1),K(l)){const t=Z(n.meta.player,e),o=(_("res-"+l.id)||{}).parentElement;if(!o)continue;o.remove();let s="";switch(l.type){case G_res_coin:s="+$"+l.value;break;case G_res_spray:s="+2 Spreadfire";break;case G_res_planetCracker:s="+2 PlanetCracker"}const{x:a,y:r}=f(l.x,l.y);G(a,r,s,h("light",t.color))}else l&&l.meta&&"planet"===l.meta.type&&n.meta.type===G_action_planetCracker&&b(l.px,l.py,G_AU,30);const c=l&&Q(l,e),i=l&&n.meta.type===G_action_move&&!!l.color;let d=null;if(c?d=Z(l.id,e):i&&(d=Z(n.meta.player,e)),d){d.dead=!0;const{x:e,y:t}=f(d.x,d.y);G(e,t,"Eliminated!",h("light",d.color)),b(d.x,d.y,G_AU/2,12)}}e.collisions=[]},v=(e,t,n,l,o,s,a)=>{a=a||{};const r={position:"absolute",left:l+"px",top:o+"px",...a},i=document.createElement("div");i.className=n,"string"==typeof t?c(i,t):i.appendChild(t),i.id=s;for(let e in r)i.style[e]=r[e];return e.appendChild(i),i},b=(e,t,n,l)=>{for(let o=0;o<l;o++){const{x:s,y:a}=G_getRandomLocInCircle(e,t,n),{x:r,y:c}=f(s,a);setTimeout(()=>{$(r,c)},o/l*2e3)}},$=(e,t)=>{const n=e+","+t;_(n)||v(_("particles"),"","expl",e-50,t-50,n)},G=(e,t,n,l)=>{const o="text,"+e+","+t;_(o)||v(_("particles"),n,"text-particle",e-100,t,o,{color:l})},w=e=>{for(let t=0;t<e.length;t++){const{x:n,y:l,r:o,color:s,target:a,dead:r}=e[t],{x:c,y:y}=f(n,l),u=2*o*G_SCALE-10,m=u/2,[g,x]=s===ie()?ye():a,{x:v,y:b}=f(g,x),$=_("pl-"+s);$.style.left=c-100+"px",$.style.top=y-75+"px",r?$.style.opacity=0:(i(c,y,o*G_SCALE,h("dark",s)),d(c-m,y-m,u,u,h("",s)),d(c-5,y-30,10,60,"white",p(c,y,v,b)),i(c,y,m/1.5,h("light",s)))}},S=(e,t)=>{for(let n=0;n<e.length;n++){const{meta:l,px:o,py:s,r:a,color:r}=e[n],{x:c,y:d}=f(o,s),p="planet"===l.type;let y;p||(y=Z(l.player,t),!l.player||l.type!==G_action_move)?i(c,d,a*G_SCALE,p?r:y.color):(y.x=o,y.y=s)}},E=e=>{if(!e)return;const t=ee(e),n=te(),l=oe(),o=t.dead,s=ne();_("controls").style.display=le()||s||l||o?"none":"flex",_("leave-game").style.display=l||o?"block":"none";let a="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],l=e===re()?y(ie()):"";a+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${t}</div>\n<div class="action" style="${l}" id="${e}" onclick="events.setSpeed('${e}')">${e}\n</div>\n</div>`}),c(_("speed-buttons"),a),_("back-practice").style.display=_e()?"block":"none";let r="";G_actions.forEach(([e,n],l)=>{const o=t.actions[e];o&&(r=L(e+(o<99?` (${o})`:""),"$"+n,e,l>1)+r)}),c(_("action-buttons"),r);const i=G_getActionCost(ce())+G_getSpeedCost(re());_("confirm-button").disabled=i>t.funds,c(_("funds"),"Funds: $"+t.funds);let d=_("target");const p=ye(),{x:u,y:m}=f(p[0],p[1]);d.style.display=le()||l||o?"none":"flex",d.style.left=u-30+"px",d.style.top=m-30+"px",d.style.stroke=h("",ie()),d.className="target";const g=_("x").cloneNode(!0);g.id="x2",g.style.display="block",c(d,""),d.appendChild(g);const x=_("banner-message"),v=_("banner-message2");if(c(x,s?"Waiting for other players...":l?"The Game is Over!":o?"You have been destroyed!":`You are the <span style="${y(t.color)}border:1px solid;padding:2px;">${t.color}</span> player.`),l){const t=Z(e.result,e);c(v,t?`The Victor is <span style="${y(t.color)}">${t.name}</span>!`:"The result is a DRAW!")}else s||le()||o?c(v,""):c(v,`<span style="color:${h("light",t.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${h("light",t.color)}">[Left Click/Tap]</span> to pan.`)},T=e=>{const t=_("games");c(t,"");for(let n=0;n<e.length;n++){const{id:l,name:o}=e[n];t.innerHTML+=`<button style="background-color:#225;" onclick="events.join('${l}')">${n+1}. Join Game: ${o}</button>`}c(_("map-select-practice"),A())},C=e=>{const t=_("players-lobby");c(t,"");for(let n=0;n<e.length;n++){const{id:l,userName:o}=e[n];t.innerHTML+=`<div class="lobby-player">${n+1}. ${l===de()?`<a class="lobby-name">${o}</a>`:o}</div>`}const n=fe(),l=e[0].id===de(),o=e.length>1&&e.length<=n.maxPlayers;c(_("map-select"),A(!l)),c(_("lobby-title"),pe()),c(_("player-count"),e.length+" of 4 joined (at least 2 required to start)");const s=_("start");s.style.display=l?"block":"none",s.disabled=!o},L=(e,t,n,l)=>`<div class="h-button-list">\n<button class="action" onclick="events.setAction('${n}')" style="${ce()===n?y(ie()):""};width:136px;margin:2px;animation:${l?"2s linear infinite border-color;":""}">${e}</button>\n<div>${t}</div>\n</div>`,A=e=>`<select style="display:${e?"none":"block"}" id="lobby-map-select" class="centered" onchange="events.setMapIndex()">${ge().reduce((e,t,n)=>e+`<option ${he()===n?"selected":""} value=${n}>${t.name}</option>`,"")}</select>`;let k=null,M=null,R=null,D=null,Y=0,N=[],I=!1,O="menu",j=null,X=!1,P=G_action_shoot,F="Normal",H=!1,B=[0,0],q=null,U="blue",W="",J=!1,V=null,z=["dialog","game","lobby","menu"];const K=e=>!!e&&[G_res_coin,G_res_spray,G_res_planetCracker].includes(e.type),Q=e=>!(!e.color||!e.target),Z=(e,t)=>t.players.reduce((t,n)=>n.id===e?n:t,null),ee=e=>{const{players:t}=e||{};for(let e=0;e<t.length;e++){const n=t[e];if(n.id===de())return n}return null},te=()=>I,ne=()=>H,le=()=>X,oe=()=>J,se=()=>null,ae=()=>N,re=()=>F,ce=()=>P,ie=()=>U,de=()=>k,pe=()=>R,ye=()=>B,ue=()=>q,me=()=>W||"Player",he=()=>Y,ge=()=>V,fe=()=>V[Y],_e=()=>1===ue().players.length,xe=e=>I=e,ve=e=>H=e,be=e=>X=e,$e=e=>J=e,Ge=e=>D=e,we=e=>N=e,Se=e=>F=e,Ee=e=>P=e,Te=e=>M=e,Ce=e=>k=e,Le=e=>R=e,Ae=e=>B=e,ke=e=>q=e,Me=e=>V=e;window.events={async create(t){Be(_("player-name-input").value),console.log("CREATE",me());const{result:n,err:l}=await e(G_R_CREATE,`${de()}/${me()||de()}/${!!t}`);if(!l){const{id:e,name:l}=n;Te(e),Le(l||"Game Name"),t||(Pe("lobby"),C([{id:de(),userName:me()}])),t&&await window.events.start()}},async join(t){Be(_("player-name-input").value);const{result:n,err:l}=await e(G_R_JOIN,`${de()}/${t},${me()||de()}`);if(l)Ue("Could not join game.");else{const{id:e,name:t,players:l}=n;Te(e),Le(t),Pe("lobby"),C(l)}},async leave(){const{err:t}=await e(G_R_LEAVE,""+de());t||(Te(null),Pe("menu"))},async start(){await e(G_R_START,`${de()}/${he()}`)},async setMapIndex(e){void 0===e&&(e=_("lobby-map-select").value),Y=parseInt(e)},async confirmAction(){const t=ce();let n=[...ye(),re()].join(",");const l=G_getActionCost(t),o=ee(ue()),{x:s,y:a}=f(o.x,o.y);G(s,a-30,"-$"+l,h("light",ie())),je(!0),ve(!0);const{err:r}=await e(G_R_CONFIRM_ACTION,`${de()}/${t}/${n}`);r&&ve(!1),je(!1)},setAction(e){Ee(e),E(ue())},setSpeed(e){Se(e),E(ue())},setTarget(e){e.preventDefault(),e.stopPropagation(),!D||ne()||le()||We(e)},centerCam(){Xe()},async returnToMenu(){M&&await window.events.leave(),ke(null),Te(null),Pe("menu")},hideDialog(){Pe(j)}};let Re=_("c"),De=0;Re.addEventListener("touchend",e=>{if(Je)return;let t=+new Date;t-De<500&&(window.events.setTarget(e),e.preventDefault()),De=t}),Re.addEventListener("contextmenu",window.events.setTarget);const Ye=()=>{let e=_("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),Be(qe()),t(),function(e,t){function n(e,t,n,l,o){const s=l,a=t,r=n,c=o;let i=!1,d=!1,p=0,y=0,u=0;e.style.transform="matrix(1, 0, 0, 1, 0, 0)";const m=()=>{let t=e.style.transform,n=t.indexOf("(")+1,l=t.indexOf(")"),o=t.slice(n,l).split(",");return{scale:+o[0],transX:+o[4],transY:+o[5]}},h=t=>{e.style.transform="matrix("+t.scale+", 0, 0, "+t.scale+", "+t.transX+", "+t.transY+")"},g=(e,t)=>{let n=m();n.transX+=e,n.transY+=t,h(n)},f=(t,n,l)=>{let o=m(),s=n-(e.width?e.width:e.offsetWidth)/2,i=l-(e.height?e.height:e.offsetHeight)/2;o.scale+=t=c?t:t*o.scale;let d=o.scale<=a||o.scale>=r;o.scale<a&&(o.scale=a),o.scale>r&&(o.scale=r),d||(g(s,i),h(o),g(-s*t,-i*t))},_=(e,t,n,l)=>Math.sqrt(Math.pow(n-e,2)+Math.pow(l-t,2)),x=(e,t,n,l)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,l)+Math.abs(l-t)/2});e.addEventListener("mousedown",e=>{0===e.button&&(e.preventDefault(),i=!0,p=e.clientX,y=e.clientY)}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(i=!0,n>=2){const{clientX:e,clientY:n}=t[1],{clientX:l,clientY:o}=t[0];u=_(e,n,l,o),d=!0,Je=!0;const{x:s,y:a}=x(e,n,l,o);p=s,y=a}else p=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",e=>{0===e.button&&(i=!1,Je=!1)}),e.addEventListener("mouseleave",()=>{i=!1,Je=!1}),e.addEventListener("touchend",e=>{0===e.touches.length&&(i=!1,d=!1,Je=!1)}),e.addEventListener("mousemove",e=>{i&&(g(e.clientX-p,e.clientY-y),p=e.clientX,y=e.clientY)}),e.addEventListener("touchmove",e=>{const t=e.touches;if(i||d){let n=0,l=0;if(t.length>=2){const{clientX:e,clientY:o}=t[1],{clientX:s,clientY:a}=t[0],r=_(e,o,s,a),{x:c,y:i}=x(e,o,s,a);n=c-p,l=i-y,g(n,l),p=c,y=i;const d=m();f(r>u?.018:-.018,d.tranX,d.transY),u=r}else{const t=e.touches[0];n=t.clientX-p,l=t.clientY-y,g(n,l),p=t.clientX,y=t.clientY}}});const v=e=>{f(Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))<0?-s:s,e.offsetX,e.offsetY)};e.addEventListener("DOMMouseScroll",v,!1),e.addEventListener("mousewheel",v,!1)}let l=[],o=(t=t||{}).minScale?t.minScale:.1,s=t.maxScale?t.maxScale:1,a=t.increment?t.increment:.2,r=!!t.liner&&t.liner;document.querySelectorAll("#cc").forEach((function(e){l.push(new n(e,o,s,a,r))}))}(0,[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},Ne=e=>{Ge(!0),ke(e),we([]),Pe("game");const{players:t,width:n,height:l}=e;((e,t)=>{const n=_("c");n.width=e,n.height=t})(2*n*G_SCALE,2*l*G_SCALE);const o=ee(e);Se("Normal"),U=o.color;const s=_("players");c(s,"");for(let e=0;e<t.length;e++){const{x:n,y:l,name:o,color:a}=t[e],r=document.createElement("div");c(r,o),r.className="player-name",r.id="pl-"+a;const{x:i,y:d}=f(n,l);r.style.left=i-100+"px",r.style.top=d-75+"px",r.style.color=h("light",a),s.appendChild(r)}Ae([o.x,o.y+100]),Xe(),ve(!1),be(!1),$e(!1),_("particles").innerHTML="",Pe("game"),E(e),(e=>{const t=_("res");c(t,"");for(let n=0;n<e.length;n++){const{x:l,y:o,id:s,type:a}=e[n],{x:r,y:c}=f(l,o),i=document.createElement("div"),d={[G_res_planetCracker]:"PlanetCracker",[G_res_spray]:"Spreadfire",[G_res_coin]:""};i.innerHTML=d[a];const p=v(i,a===G_res_coin?"$":"!","resource "+a,r-100,c-(a===G_res_coin?25:45),"res-"+s);i.style.left=p.style.left,i.style.top=p.style.top,i.className="res2 centered",p.style.position="unset",t.appendChild(i)}})(e.resources),x(e)},Ie=e=>{ke(e),ve(!1),be(!0),_("particles").innerHTML="",E(e),x(e),console.log("Begin simulation",e),u(()=>{let e=ue();G_applyGravity(e.projectiles,e.planets,e.players.concat(e.resources),n),x(e)})},Oe=e=>{if(u((function(){})),be(!1),e){ke(e);const t=ee(e);t.actions[ce()]||Ee(G_action_shoot),E(e);for(let t=0;t<e.projectiles.length;t++){const n=e.projectiles[t],{x:l,y:o,meta:s}=f(n.px,n.py);$(l,o,s&&"Move"===s.type?"mv":"sm")}e.projectiles=[],x(e);const{x:n,y:l}=f(t.x,t.y);if(!t.dead){const t=e.baseFundsPerRound;c(_("banner-message3"),`All players granted $${t} at completion of the round.`),setTimeout(()=>{G(n,l-30,"+$"+t,h("light",ie()))},500),setTimeout(()=>{c(_("banner-message3"),"")},3e3)}}},je=e=>{xe(e),E(ue())},Xe=()=>{const e=ee(ue()),{width:t,height:n}=m(),{x:l,y:o}=f(e.x,e.y),s=_("cc").style;s.transition="transform 0.5s",s.transform=`matrix(1, 0, 0, 1, ${-(l-t/2)}, ${-(o-n/2-2)})`,setTimeout(()=>{s.transition=""},500)},Pe=(e,t)=>{O=e,z.forEach(n=>{const l=_(n);let o="none";e===n&&(o="flex",t&&t()),l.style.display=o})},Fe=e=>{j=O,Pe("dialog"),_("dialog-text").innerHTML=e},He=e=>{ue()&&e.result&&(Ge(!1),$e(!0),ke(e),E(e),x(e))},Be=e=>{_("player-name-input").value=e,W=e,localStorage.setItem("js13k2020_orbital_forts_u",e)},qe=()=>me()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",Ue=e=>{Oe(ue()),Pe("menu"),Te(null),ke(null),Ge(!1),T([]),Pe("menu"),Fe(e)},We=e=>{let t=_("c");if(e.changedTouches){const n=e.changedTouches[0],l=t.parentElement.style.transform,{left:o,top:s}=t.getBoundingClientRect(),a=parseFloat(l.slice(7,l.indexOf(",")));let{x:r,y:c}=g((n.clientX-o)/a,(n.clientY-s)/a);Ae([r,c])}else{const{offsetX:t,offsetY:n}=e;let{x:l,y:o}=g(t,n);Ae([l,o])}E(ue()),x(ue())};let Je=!1})();