(()=>{const e=async(e,t,n)=>{const l=new Headers;l.key=ne();const o=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:l}),s=await o.json();return s[1]&&console.error("[FETCH-ERROR]",s[1]),console.log("fetch",e,t,s),{result:s[0],err:s[1]}};let t,n;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on(G_SOCKET_CONNECTED,([{games:e,maps:t,id:n}])=>{console.log("connected load",e,n),_e(n),$e(t),_(e)}),e.on(G_SOCKET_GAME_LIST_UPDATED,([e])=>{console.log("game list updated",e),_(e)}),e.on(G_SOCKET_LOBBY_LIST_UPDATED,([e])=>{console.log("lobby list updated",e),S(e)}),e.on(G_SOCKET_START_GAME,([{startTime:e,gameData:t}])=>{console.log("start",e,t),we(t)}),e.on(G_SOCKET_STOP_GAME,([e])=>{console.log("stop",e),Ne("menu"),ke(e),Le(null)}),e.on(G_SOCKET_START_SIMULATION,([e])=>{console.log("begin simulation",e),ve([e]),Ae(e)}),e.on(G_SOCKET_STOP_SIMULATION,([e])=>{console.log("stop simulation"),ve([]),Ce(e)}),e.on(G_SOCKET_BROADCAST_GAME,([{gameData:e}])=>{Le(e);const t=le();t.push(e),t.length>200&&t.shift()}),e.on(G_SOCKET_GAME_FINISHED,([e])=>{console.log("GAME OVER",e),Re(e)}),e.on("connect",()=>{console.log("connected")}),e.on("disconnect",e=>{console.warn("disconnect",e),De("You disconnected from the game server!")}),e.on("error",e=>{console.error("socket-error",e),De("An error occurred with the connection to the game server!")}),Ge()},!1)})();let l=!1,o=null,s=Math.PI;const a=()=>g("c").getContext("2d"),i=(e,t,n,l)=>{const o=a();o.beginPath(),o.arc(e,t,n,0,2*s,!1),o.fillStyle=l,o.fill()},r=(e,t,n,l,o,i)=>{const r=a();if(r.save(),r.beginPath(),r.translate(e,t),r.fillStyle=o,void 0!==i){const e=n/2,t=l/2;r.translate(e,t),r.rotate(i*s/180),r.fillRect(-e,-l/1.5,n,l)}else r.fillRect(0,0,n,l);r.restore()},c=(e,t,n,l)=>{let o=l-t,a=n-e,i=Math.sqrt(a*a+o*o),r=0;return r=l>=t&&n>=e?180*Math.asin(o/i)/s+90:l>=t&&n<e?180*Math.asin(o/-i)/s-90:l<t&&n>e?180*Math.asin(o/i)/s+90:180*Math.asin(-o/i)/s-90,r>=360&&(r=360-r),r<0&&(r=360+r),isNaN(r)?0:r},d=e=>`background-color:${u("dark",e)};color:${u("light",e)};`,p=e=>{t=+new Date,n=0,o=e;const s=()=>{let e=+new Date;n=e-t,t=e,o(),requestAnimationFrame(s)};l||requestAnimationFrame(s),l=!0},y=()=>{const e=a().canvas,{left:t,top:n}=e.getBoundingClientRect();return{left:t,top:n,width:e.width,height:e.height}},u=(e,t)=>({"":{blue:"#44F"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#B8860B"}}[e][t]||e+t),h=(e,t)=>{const{width:n,height:l}=y();return{x:(e-n/2)/G_SCALE,y:-(t-l/2)/G_SCALE}},m=(e,t)=>{const{width:n,height:l}=y();return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+l/2)}},g=e=>document.getElementById(e),f=e=>{const{players:t,planets:n,projectiles:l}=e,o=le();(()=>{const e=a(),t=e.canvas;e.fillStyle="#222",e.fillRect(0,0,t.width,t.height)})();for(let t=0;t<o.length;t++){const{projectiles:n}=o[t];for(let t=0;t<n.length;t++){const{px:l,py:o,r:s,meta:a}=n[t],{x:r,y:c}=m(l,o),d=W(a.player,e);i(r,c,s*G_SCALE,u("light",d.color))}}E(t),T(n,e),T(l,e);let s=e.collisions,r=s.length;if(r)for(let t=0;t<r;t++){const[n,l]=s[t],{x:o,y:a}=m(n.px,n.py);v(o,a,"Move"===n.meta.type?"mv":void 0);let i=e.projectiles.indexOf(n);if(i>-1&&e.projectiles.splice(i,1),U(l)){const t=W(n.meta.player,e);g("res-"+l.id).remove();const{x:o,y:s}=m(l.x,l.y);x(o,s,"+$"+l.value,u("light",t.color))}if(l&&q(l,e)){W(l.id,e).dead=!0;for(let e=0;e<15;e++){const{x:t,y:n}=G_getRandomLocInCircle(l.x,l.y,G_AU/2),{x:o,y:s}=m(t,n);setTimeout(()=>{v(o,s)},e/12*2e3)}}}e.collisions=[]},v=(e,t,n)=>{const l=e+","+t;if(g(l))return;const o=document.createElement("div");o.id=l;const s={position:"absolute",left:e-50+"px",top:t-50+"px"};for(let e in s)o.style[e]=s[e];o.className="expl"+(n?` expl-${n}`:""),o.innerHTML=`<div class="expl2 ${n?` expl2-${n}`:""}" />`,g("particles").appendChild(o)},x=(e,t,n,l)=>{const o="text,"+e+","+t;if(g(o))return;const s=document.createElement("div");s.id=o;const a={position:"absolute",left:e-100+"px",top:t+"px",color:l};for(let e in a)s.style[e]=a[e];s.className="text-particle",s.innerHTML=n,g("particles").appendChild(s)},E=e=>{for(let t=0;t<e.length;t++){const{x:n,y:l,r:o,color:s,target:a,dead:d}=e[t],{x:p,y:y}=m(n,l),h=2*o*G_SCALE-10,f=h/2,[v,x]=s===ae()?ce():a,{x:E,y:T}=m(v,x),M=g("player-name-"+s);M.style.left=p-100+"px",M.style.top=y-75+"px",d?M.style.opacity=0:(i(p,y,o*G_SCALE,u("dark",s)),r(p-f,y-f,h,h,u("",s)),r(p-5,y-30,10,60,"white",c(p,y,E,T)),i(p,y,f/1.5,u("light",s)))}},T=(e,t)=>{for(let n=0;n<e.length;n++){const{meta:l,px:o,py:s,r:a,color:r}=e[n],{x:c,y:d}=m(o,s);if("object"==typeof l){const e=W(l.player,t);if(l.player&&"Move"===l.type){e.x=o,e.y=s;continue}}i(c,d,a*G_SCALE,"object"==typeof l?W(l.player,t).color:r)}},M=e=>{if(!e)return;const t=J(e),n=z(),l=te(),o=t.dead;g("controls").style.display=Z()||l||o?"none":"flex",g("leave-game").style.display=l||o?"block":"none";let s="";G_actions.forEach(([e,t])=>{let l=e===oe()?`${d(ae())}`:"";s+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost +$${t}</div>\n<div class="action" style="${l}" id="${e}" onclick="events.setAction('${e}')">${e}\n</div>\n</div>`}),g("control-buttons").innerHTML=s;let a="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],l=e===se(),o=V()?"color: grey":l?d(ae()):"";a+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost +$${t}</div>\n<div class="action" style="${o}" id="${e}" onclick="events.setSpeed('${e}')">${e}\n</div>\n</div>`});let i=G_getActionCost(oe())+(V()?0:G_getSpeedCost(se()));g("speed-buttons").innerHTML=a,g("set-target").disabled=n||Q()||ee(),g("confirm").disabled=n||Q()||i>t.funds;let r=g("cost");g("funds").innerHTML="Funds: $"+t.funds+(Q()?`<span style="color:pink"> - $${i}</span>`:""),r.innerHTML="Current Cost: $"+i,r.style.color=i>t.funds?"red":"white";let c=g("target");const p=ce(),{x:y,y:h}=m(p[0],p[1]);c.style.display=V()||Z()||l||o?"none":"flex",c.style.left=y-30+"px",c.style.top=h-30+"px",c.style.stroke=u("",ae()),c.className="target";const f=g("x").cloneNode(!0);f.id="x2",f.style.display="block",c.innerHTML="",c.appendChild(f),"Move"===oe()&&(c.className="target-m");const v=g("banner-message"),x=g("banner-message2");if(Q()?v.innerHTML="Waiting for other players...":v.innerHTML=l?"The Game is Over!":o?"You have been destroyed!":`You are the <span style="${d(t.color)}border:1px solid;padding:2px;">${t.color}</span> player.`,ee())x.innerHTML="Select location to place target.";else if(l){const t=W(e.result,e);x.innerHTML=t?`The Victor is <span style="${d(t.color)}">${t.name}</span>!`:"The result is a DRAW!"}else x.innerHTML=""},_=e=>{const t=g("games");t.innerHTML="";for(let n=0;n<e.length;n++){const{id:l,name:o}=e[n];let s=n+1;t.innerHTML+=`<button style="background-color:#225;box-shadow:none" onclick="events.join('${l}')">${s}. Join Game: ${o}</button>`}},S=e=>{const t=g("players-lobby");t.innerHTML="";for(let n=0;n<e.length;n++){const{id:l,userName:o}=e[n];let s=n+1;t.innerHTML+=`<div class="player">${s}. ${l===ie()?`<span class="lobby-name">${o}</span>`:o}</div>`}const n=he(),l=e[0].id===ie(),o=e.length>1&&e.length<=n.maxPlayers,s=g("lobby-map-select");s.innerHTML=ue().reduce((e,t,n)=>e+`<option value=${n}>${t.name}</option>`,""),s.value=ye(),s.style.display=l?"block":"none",g("lobby-title").innerHTML=re();const a=g("start");a.style.display=l?"block":"none",a.disabled=!o};let b=null,L=null,$=null,G=null,w=0,A=[],C=!1,O="menu",H=null,N="Wait",k=!1,R="Normal",I=!1,Y=[0,0],D=null,X="blue",j=!1,P="",B=!1,F=null,K=["dialog","game","lobby","menu"];const U=e=>e&&"coin"===e.type,q=e=>!(!e.color||!e.target),W=(e,t)=>t.players.reduce((t,n)=>n.id===e?n:t,null),J=e=>{const{players:t}=e||{};for(let e=0;e<t.length;e++){const n=t[e];if(n.id===ie())return n}return null},V=()=>"Wait"===N,z=()=>C,Q=()=>I,Z=()=>k,ee=()=>j,te=()=>B,ne=()=>G,le=()=>A,oe=()=>N,se=()=>R,ae=()=>X,ie=()=>b,re=()=>$,ce=()=>Y,de=()=>D,pe=()=>P,ye=()=>w,ue=()=>F,he=()=>F[w],me=e=>I=e,ge=e=>k=e,fe=e=>B=e,ve=e=>A=e,xe=e=>j=e,Ee=e=>N=e,Te=e=>R=e,Me=e=>L=e,_e=e=>b=e,Se=e=>$=e,be=e=>Y=e,Le=e=>D=e,$e=e=>F=e;window.events={async create(t){Oe(!0),Ie(g("player-name-input").value);const{result:n,err:l}=await e(G_REST_CREATE_GAME,`${ie()}/${pe()||ie()}/${!!t}`);if(!l){const{id:e,name:l}=n;Me(e),Se(l||"Game Name"),Ne("lobby"),S([{id:ie(),userName:pe()}]),t&&await window.events.start()}Oe(!1)},async join(t){Oe(!0),Ie(g("player-name-input").value);const{result:n,err:l}=await e(G_REST_JOIN_GAME,`${ie()}/${t},${pe()||ie()}`);if(l)De("Could not join game.");else{const{id:e,name:t,players:l}=n;console.log("ON JOIN",n),Me(e),Se(t),Ne("lobby"),S(l)}Oe(!1)},async leave(){Oe(!0);const{err:t}=await e(G_REST_LEAVE_GAME,`${ie()}`);t||(Me(null),Ne("menu")),Oe(!1)},async start(){Oe(!0),await e(G_REST_START_GAME,`${ie()}/${ye()}`),Oe(!1)},async setMapIndex(e){void 0===e&&(e=g("lobby-map-select").value),w=e},async confirmAction(){let t;const n=oe();switch(n){case"Shoot":case"Move":const[e,n]=ce();t=[e,n,se()].join(",");break;default:t=null}const l=G_getActionCost(n),o=J(de()),{x:s,y:a}=m(o.x,o.y);x(s,a-30,"-$"+l,u("light",ae())),Oe(!0),me(!0);const{err:i}=await e(G_REST_GAME_CONFIRM_ACTION,`${ie()}/${n}/${t}`);i&&me(!1),Oe(!1)},setAction(e){Ee(e),M(de())},setSpeed(e){Te(e),M(de())},setTarget(){xe(!0),M(de());let e=g("c"),t=n=>{if(n.touches){const t=n.touches[0],l=e.parentElement.style.transform,{left:o,top:s}=e.getBoundingClientRect(),a=parseFloat(l.slice(7,l.indexOf(",")));let{x:i,y:r}=h((t.clientX-o)/a,(t.clientY-s)/a);be([i,r])}else{const{offsetX:e,offsetY:t}=n;let{x:l,y:o}=h(e,t);be([l,o])}xe(!1),M(de()),f(de()),e.removeEventListener("click",t),e.removeEventListener("touchstart",t)};e.addEventListener("click",t),e.addEventListener("touchstart",t)},centerCam(){He()},async returnToMenu(){L?await window.events.leave():(Le(null),Le(null),Ne("menu"))},hideDialog(){Ne(H)}};const Ge=()=>{let e=g("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),Ie(Ye()),t(),function(e,t){function n(e,t,n,l,o){const s=l,a=t,i=n,r=o;let c=!1,d=!1,p=0,y=0,u=0;e.style.transform="matrix(1, 0, 0, 1, 0, 0)";const h=()=>{let t=e.style.transform,n=t.indexOf("(")+1,l=t.indexOf(")"),o=t.slice(n,l).split(",");return{scale:+o[0],transX:+o[4],transY:+o[5]}},m=t=>{e.style.transform="matrix("+t.scale+", 0, 0, "+t.scale+", "+t.transX+", "+t.transY+")"},g=(e,t)=>{let n=h();n.transX+=e,n.transY+=t,m(n)},f=(t,n,l)=>{let o=h(),s=n-(e.width?e.width:e.offsetWidth)/2,c=l-(e.height?e.height:e.offsetHeight)/2;t=r?t:t*o.scale,o.scale+=t;let d=o.scale<=a||o.scale>=i;o.scale<a&&(o.scale=a),o.scale>i&&(o.scale=i),d||(g(s,c),m(o),g(-s*t,-c*t))},v=(e,t,n,l)=>Math.sqrt(Math.pow(n-e,2)+Math.pow(l-t,2)),x=(e,t,n,l)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,l)+Math.abs(l-t)/2});e.addEventListener("mousedown",e=>{e.preventDefault(),c=!0,p=e.clientX,y=e.clientY}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(c=!0,n>=2){const{clientX:e,clientY:n}=t[1],{clientX:l,clientY:o}=t[0];u=v(e,n,l,o),d=!0;const{x:s,y:a}=x(e,n,l,o);p=s,y=a}else p=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",()=>{c=!1}),e.addEventListener("mouseleave",()=>{c=!1}),e.addEventListener("touchend",()=>{c=!1,d=!1}),e.addEventListener("mousemove",e=>{if(c){let t=e.clientX-p,n=e.clientY-y;g(t,n),p=e.clientX,y=e.clientY}}),e.addEventListener("touchmove",e=>{const t=e.touches,n=t.length;if(c||d){let l=0,o=0;if(n>=2){const{clientX:e,clientY:n}=t[1],{clientX:s,clientY:a}=t[0],i=v(e,n,s,a),{x:r,y:c}=x(e,n,s,a);l=r-p,o=c-y,g(l,o),p=r,y=c;const d=h();f(i>u?.018:-.018,d.tranX,d.transY),u=i}else{const t=e.touches[0];l=t.clientX-p,o=t.clientY-y,g(l,o),p=t.clientX,y=t.clientY}}});const E=e=>{let t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));f(t<0?-s:s,e.offsetX,e.offsetY)};e.addEventListener("DOMMouseScroll",E,!1),e.addEventListener("mousewheel",E,!1)}let l=[],o=(t=t||{}).minScale?t.minScale:.1,s=t.maxScale?t.maxScale:1,a=t.increment?t.increment:.2,i=!!t.liner&&t.liner;document.querySelectorAll(e).forEach((function(e){l.push(new n(e,o,s,a,i))})),1==l.length&&l[0]}("#cc",[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},we=e=>{Le(e),Ne("game");const{players:t,width:n,height:l}=e;((e,t)=>{const n=g("c");n.width=e,n.height=t})(2*n*G_SCALE,2*l*G_SCALE);const o=J(e);var s;Ee("Shoot"),Te("Normal"),s=o.color,X=s;const a=g("players");a.innerHTML="";for(let e=0;e<t.length;e++){const{x:n,y:l,name:o,color:s}=t[e],i=document.createElement("div");i.innerHTML=o,i.className="player-name",i.id="player-name-"+s;const{x:r,y:c}=m(n,l);i.style.left=r-100+"px",i.style.top=c-75+"px",i.style.color=u("light",s),a.appendChild(i)}be([o.x,o.y]),He(),me(!1),ge(!1),fe(!1),g("particles").innerHTML="",Ne("game"),M(e),(e=>{const t=g("res");t.innerHTML="";for(let n=0;n<e.length;n++){const{x:l,y:o,id:s}=e[n],{x:a,y:i}=m(l,o),r={position:"absolute",left:a-25+"px",top:i-25+"px"},c=document.createElement("div");c.className="coin",c.innerHTML="$",c.id="res-"+s;for(let e in r)c.style[e]=r[e];t.appendChild(c)}})(e.resources),f(e)},Ae=e=>{Le(e),me(!1),ge(!0),g("particles").innerHTML="",M(),f(e),console.log("BEGIN SIMULATION"),p(()=>{let e=de();G_applyGravity(e.projectiles,e.planets,e.players.concat(e.resources),n),f(e)})},Ce=e=>{if(p((function(){})),ge(!1),e){Le(e),M(e);for(let t=0;t<e.projectiles.length;t++){const n=e.projectiles[t],{x:l,y:o,meta:s}=m(n.px,n.py);v(l,o,s&&"Move"===s.type?"mv":"sm")}e.projectiles=[],f(e);const t=J(e),{x:n,y:l}=m(t.x,t.y);t.dead||setTimeout(()=>x(n,l-30,"+$"+e.baseFundsPerRound,u("light",ae())),500)}},Oe=e=>{(e=>{C=e})(e),M(de())},He=()=>{const e=J(de()),{width:t,height:n}=y(),{x:l,y:o}=m(e.x,e.y),s=g("cc").style;s.transition="transform 0.5s",s.transform=`matrix(1, 0, 0, 1, ${-(l-t/2)}, ${-(o-n/2-2)})`,setTimeout(()=>{s.transition=""},500)},Ne=(e,t)=>{O=e,K.forEach(n=>{const l=g(n);let o="none";e===n&&(o="flex",t&&t()),l.style.display=o})},ke=e=>{H=O,Ne("dialog"),g("dialog-text").innerHTML=e},Re=e=>{de()&&e.result&&(fe(!0),Le(e),M(e),f(e))},Ie=e=>{g("player-name-input").value=e,P=e,localStorage.setItem("u",e)},Ye=()=>pe()||localStorage.getItem("u")||"Player",De=e=>{Ce(de()),Ne("menu"),Me(null),Le(null),_([]),Ne("menu"),ke(e)}})();