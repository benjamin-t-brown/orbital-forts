(()=>{function t(t,e){const n=parseInt(t.slice(1,3),16),a=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16);return void 0!==e?"rgba("+n+", "+a+", "+o+", "+e+")":"rgb("+n+", "+a+", "+o+")"}const e=async(t,e,n)=>{vt(!0);const a=await fetch(`/${t}/${e}${n?"/"+n:""}`,{headers:{key:it()}}),o=await a.json();if(o[1])throw Error("[FETCH-ERROR] "+o[1]);return vt(!1),{result:o[0],err:o[1]}};let n,a;(()=>{let t;window.addEventListener("load",()=>{t=io({upgrade:!1,transports:["websocket"]}),t.on(G_S_CONNECTED,([{games:t,maps:e,id:n,key:a}])=>{Rt(n),Pt(e),At(a),Pe(t),i()}),t.on(G_S_LIST_UPDATED,([t])=>{Pe(t)}),t.on(G_S_LOBBY_DATA,([t])=>{Ye(t)}),t.on(G_S_GAME_METADATA,([t])=>{Bt(t),Be(gt(),t)}),t.on(G_S_START,([{gameData:t}])=>{re(t),t.isPractice||ee("start")}),t.on(G_S_STOP,([t])=>{ge("menu"),fe(t),Ot(null)}),t.on(G_S_START_SIMULATION,([t])=>{Tt([t]),ce(t)}),t.on(G_S_STOP_SIMULATION,([{dynamicGameData:t,timestamp:e}])=>{const n=ct();n.push({timestamp:e,dynamicGameData:t,last:!0}),n.length>500&&n.shift()}),t.on(G_S_BROADCAST,([{dynamicGameData:t,timestamp:e}])=>{const n=ct();n.push({timestamp:e,dynamicGameData:t}),n.length>500&&n.shift()}),t.on(G_S_FINISHED,([{gameData:t,replay:e}])=>{setTimeout(()=>{_e(t),Yt(e)},G_GAME_TIME_BUFFER_MS)}),t.on("connect",()=>{}),t.on("disconnect",t=>{be("You disconnected from the game server!")}),t.on("error",t=>{console.error("socket-error",t),be("An error occurred with the connection to the game server!")}),oe()},!1)})();let o=!1,s=null,l=+new Date,r=Math.PI;const i=()=>{Je(),x("practice").disabled=!1,x("create-game").disabled=!1},c=()=>{n-l>9e3&&(l=+new Date)},p=()=>x("c").getContext("2d"),d=(t,e)=>{t.innerHTML=e},y=()=>{const t=p(),e=t.canvas;t.clearRect(0,0,e.width,e.height)},m=(t,e,n,a)=>{const o=p();o.beginPath(),o.arc(t,e,n,0,2*r,!1),o.fillStyle=a,o.fill()},u=(t,e,n,a,o,s)=>{const l=p();if(l.save(),l.beginPath(),l.translate(t,e),l.fillStyle=o,void 0!==s){const t=n/2;l.translate(t,a/2),l.rotate(s*r/180),l.fillRect(-t,-a/1.5,n,a)}else l.fillRect(0,0,n,a);l.restore()},h=(t,e,n,a)=>{let o=a-e,s=n-t;const{sqrt:l,asin:i}=Math;let c=l(s*s+o*o),p=0;return p=a>=e&&n>=t?180*i(o/c)/r+90:a>=e&&n<t?180*i(o/-c)/r-90:a<e&&n>t?180*i(o/c)/r+90:180*i(-o/c)/r-90,p>=360&&(p=360-p),p<0&&(p=360+p),isNaN(p)?0:p},g=(t,e)=>({"":{blue:"#44F",yellow:"#cac200"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#FFF60B"}}[t][e]||t+e),f=t=>`background-color:${g("dark",t)};color:${g("light",t)};`,_=t=>{n=+new Date,a=0,s=t;const e=()=>{let t=+new Date;a=t-n,n=t,s(),requestAnimationFrame(e)};o||requestAnimationFrame(e),o=!0},E=()=>{const t=p().canvas,{left:e,top:n}=t.getBoundingClientRect();return{left:e,top:n,width:t.width,height:t.height}},G=(t,e)=>{const{width:n,height:a}=E();return{x:(t-n/2)/G_SCALE,y:-(e-a/2)/G_SCALE}},b=(t,e)=>{const{width:n,height:a}=E();return{x:Math.round(t*G_SCALE+n/2),y:Math.round(-e*G_SCALE+a/2)}},x=t=>document.getElementById(t),M=t=>{const{players:e,planets:n,projectiles:a}=t,o=pt();y(),c(),w(n.map(e=>G_getEntityFromEntMap(e,t)),t);for(let e=0;e<o.length;e++){const n=o[e],{projectiles:a}=o[e];for(let e=0;e<a.length;e++){const o=G_getEntityFromEntMap(a[e],n);if(o.meta.type===G_action_move)continue;const{px:s,py:l,r:r,meta:i}=o,{x:c,y:p}=b(s,l),d=at(i.player,t);m(c,p,r*G_SCALE,g("light",d.color))}}if($(a.map(e=>G_getEntityFromEntMap(e,t)),t),S(e.map(e=>G_getEntityFromEntMap(e,t))),G_DEBUG)for(let e=0;e<t.resources.length;e++){const e=G_getEntityFromEntMap(t.resources.length,t),{x:n,y:a,r:o}=e,{x:s,y:l}=b(n,a);m(s,l,o*G_SCALE,"white")}},v=t=>{if(!t)return;const{planets:e,players:n}=t;if(y(),c(),S(n.map(e=>G_getEntityFromEntMap(e,t))),w(e.map(e=>G_getEntityFromEntMap(e,t))),G_DEBUG)for(let e=0;e<t.resources.length;e++){const n=G_getEntityFromEntMap(t.resources.length,history[e]),{x:a,y:o,r:s}=n,{x:l,y:r}=b(a,o);m(l,r,s*G_SCALE,"white")}},S=t=>{for(let e=0;e<t.length;e++){const{x:n,y:a,r:o,color:s,target:l,dead:r}=t[e],{x:i,y:c}=b(n,a),p=2*o*G_SCALE-10,d=p/2,[y,f]=s===mt()?ht():l,{x:_,y:E}=b(y,f),G=x("pl-"+s);G.style.left=i-100+"px",G.style.top=c-75+"px",r?G.style.opacity=0:(m(i,c,o*G_SCALE,g("dark",s)),u(i-d,c-d,p,p,g("",s)),u(i-5,c-30,10,60,"white",h(i,c,_,E)),m(i,c,d/1.5,g("light",s)))}},w=e=>{const a=120/G_SCALE,o=840/G_SCALE;for(let t=0;t<e.length;t++){const{px:n,py:s,mass:l}=e[t],{x:r,y:i}=b(n,s),c=G_normalize(l,G_MASS_MIN,G_MASS_MAX,a,o),d=p().createRadialGradient(r,i,20,r,i,c*G_SCALE);d.addColorStop(0,"#0f0f0f"),d.addColorStop(1,"transparent"),m(r,i,800,d)}for(let a=0;a<e.length;a++){const{px:o,py:s,r:r,color:i}=e[a],{x:c,y:p}=b(o,s),d=Math.min(Math.max(G_normalize(n,l,l+9e3,0,1),0),1);m(c,p,r*G_SCALE,t(i,"0.9")),m(c,p,r*G_SCALE*(1-d),g("dark",i))}},$=(t,e)=>{for(let n=0;n<t.length;n++){const{meta:a,px:o,py:s,r:l}=t[n],{x:r,y:i}=b(o,s);m(r,i,l*G_SCALE,at(a.player,e).color)}};let C=null,A=null,T=null,k=null,D=null,L=null,F=0,I=[],R=[],N=!1,j="menu",O=null,B=!1,P=G_action_shoot,Y="Normal",X=!1,U=[0,0],H=null,J=null,q="blue",W="",z=!1,V=null,Z=null,K=null,Q=!1,tt=0,et=!0,nt=["dialog","game","lobby","menu"];const at=(t,e)=>G_getEntityFromEntMap(t,e),ot=t=>{const{players:e}=t||{};for(let n=0;n<e.length;n++){const a=G_getEntityFromEntMap(e[n],t);if(a.id===ut())return a}return e[0]},st=()=>X,lt=()=>B,rt=()=>z,it=()=>L,ct=()=>I,pt=()=>R,dt=()=>Y,yt=()=>P,mt=()=>q,ut=()=>C,ht=()=>U,gt=()=>H,ft=()=>W,_t=()=>F,Et=()=>V,Gt=()=>Q,bt=()=>Z,xt=()=>tt,Mt=()=>et,vt=t=>N=t,St=t=>X=t,wt=t=>B=t,$t=t=>z=t,Ct=t=>D=t,At=t=>L=t,Tt=t=>I=t,kt=t=>R=t,Dt=t=>Y=t,Lt=t=>P=t,Ft=t=>A=t,It=t=>T=t,Rt=t=>C=t,Nt=t=>k=t,jt=t=>U=t,Ot=t=>H=t,Bt=t=>J=t,Pt=t=>V=t,Yt=t=>{K=t;const e=JSON.stringify(K);try{localStorage.setItem("js13k2020_orbital_forts_replay",e)}catch(t){}},Xt=t=>Q=t,Ut=t=>tt=t,Ht=t=>{et=t,localStorage.setItem("js13k2020_orbital_forts_sound",t)},Jt=localStorage.getItem("js13k2020_orbital_forts_replay");if(Jt)try{Yt(JSON.parse(Jt))}catch(t){}const qt=localStorage.getItem("js13k2020_orbital_forts_sound");null!==qt&&Ht("true"===qt),window.events={async create(t){ee("button"),Ee(x("player-name-input").value.trim()||"Player");const{result:n,err:a}=await e(G_R_CREATE,`${ut()}/${encodeURIComponent(ft())||ut()}/${!!t}`);if(!a){const{id:e,name:a}=n;Ft(e),It(e),Nt(a||"Game Name"),t||(ge("lobby"),Ye(n.lobbyData)),t&&await window.events.start()}},async join(t){ee("button"),Ee(x("player-name-input").value.trim()||"Player");const{result:n,err:a}=await e(G_R_JOIN,`${ut()}/${t},${encodeURIComponent(ft())}`);if(a)be("Could not join game.");else{const{id:t,name:e,lobbyData:a}=n;Ft(t),Nt(e),It(t),ge("lobby"),Ye(a)}},async leave(){ee("button");try{await e(G_R_LEAVE,""+ut())}catch(t){}Ft(null),It(null),ge("menu")},async start(){await e(G_R_START,`${ut()}/${_t()}`)},async setMapIndex(t){let e=x(t).value;F=parseInt(e),"lobby-map-select"===t&&await window.events.updateLobby()},async confirmAction(){ee("button3");const t=yt();let n=[...ht(),dt()].join(",");const a=G_getActionCost(t),o=ot(gt()),{x:s,y:l}=b(o.x,o.y);Ne(s,l-30,"-$"+a,g("light",mt())),me(!0),St(!0);const{err:r}=await e(G_R_CONFIRM_ACTION,`${ut()}/${t}/${n}`);r&&St(!1),me(!1)},setAction(t){ee("button2"),Lt(t),Oe(gt())},setSpeed(t){ee("button2"),Dt(t),Oe(gt())},setTarget(t){t.preventDefault(),t.stopPropagation(),!D||st()||lt()||Gt()||xe(t)},centerCam(){he()},async returnToMenu(){ee("button"),me(!0),Gt()?(Se(),ve()):(pe(),ie()),await window.events.leave(),Ot(null),Ft(null),ge("menu")},hideDialog(){ge(O)},async updateLobby(){const t=""+_t();await e(G_R_UPDATE_LOBBY,`${ut()}/${t}`)},viewLastReplay(){ee("button");const t=JSON.parse(JSON.stringify(K));t?Me(t):be("No recent replay found.")},replayNextRound(){ee("button"),we()},toggleSound(){const t=Mt();Ht(!t),Je()}};let Wt,zt,Vt,Zt=x("c"),Kt=0;Zt.addEventListener("touchend",t=>{if(Ae)return;let e=+new Date;e-Kt<500&&(window.events.setTarget(t),t.preventDefault()),Kt=e}),Zt.addEventListener("contextmenu",window.events.setTarget),zt=.3,Wt=(t=1,e=.05,n=220,a=0,o=0,s=.1,l=0,r=1,i=0,c=0,p=0,d=0,y=0,m=0,u=0,h=0,g=0,f=2*Math.PI,_=44100,E=(t=>2*t*Math.random()-t),G=(t=>0<t?1:-1),b=(i*=500*f/_**2),x=(n*=(1+E(e))*f/_),M=G(u)*f/4,v=[],S=0,w=0,$=0,C=1,A=0,T=0,k=0,D,L,F,I=Vt.createBufferSource())=>{for(c*=500*f/_**3,L=(a=99+a*_|0)+(o=o*_|0)+(s=s*_|0)+(g=g*_|0),u*=f/_,p*=f/_,d*=_,y*=_;$<L;v[$++]=k)++T>100*h&&(T=0,k=S*n*Math.sin(w*u-M),k=G(k=l?1<l?2<l?3<l?Math.sin((k%f)**3):Math.max(Math.min(Math.tan(k),1),-1):1-(2*k/f%2+2)%2:1-4*Math.abs(Math.round(k/f)-k/f):Math.sin(k))*Math.abs(k)**r,k*=t*zt*($<a?$/a:$<a+o?1:$<L-g?1-($-a-o)/s:0),k=g?k/2+(g>$?0:($<L-g?1:($-L)/g)*v[$-g]/2):k),S+=1+E(m),w+=1+E(m),n+=i+=c,C&&++C>d&&(x+=p,n+=p,C=0),y&&++A>y&&(n=x,i=b,A=1,C=C||1);(F=Vt.createBuffer(1,v.length,_)).getChannelData(0).set(v),I.buffer=F,I.connect(Vt.destination),I.start()},Vt=new AudioContext;const Qt={button:[,,204,,,.06,,1.39,64,-17,,,,,-17,.2,.26],button2:[,,1107,.01,,.01,1,.14,,,,,,.5,31,.1,.44],button3:[,,313,,,.08,1,1.74,,,322,.66,,.1,-20,.1,.44],expl:[,,366,,.06,.28,3,2.51,-4.7,-.5,,,,.1,.1,.3,.06],getSpreadFire:[,,252,,,.23,2,.65,,,,,,1.6,-7.5,,.04],getCluster:[,,80,,,.41,2,2.53,1.3,-.8,,,,.7,.4,.1,.17],getPC:[,,1343,,.02,.23,1,.98,,,928,.06,.01],lobby:[,,531,.05,,.05,3,,,-.1,783,1.22,,1.4,,,.12],wormhole:[,,192,.01,.26,.01,,.56,,28,,,,.7,,,.16],playerDead:[,,385,,.1,.45,4,1.32,,,,,,.9,,.1,.11],playerDead2:[,,378,,.06,.97,1,3.63,.4,,,,,.5,-.4,.6],explPlanet:[,,814,.04,.23,1.86,4,1.78,,.3,,,,.9,-.9,.4],shootNorm:[,,528,.02,,.25,3,1.62,,-.6,,,,3.6,,.1,.01],shootNorm2:[,,223,,.07,.16,3,.92,,,,,,1.6,-.9,.3,.07],shootPC:[,,254,,,.48,3,.13,-1.1,,,,,2,,.1,.07],explLarge2:[,,997,.04,.06,.87,3,1.23,,100,,,,1.8,1,.8],explCluster:[,,273,,,.36,3,.01,,,,,,.2,.6,.3,.04],coin:[,,1250,,.04,.21,,1.56,,,706,.04,,,,,.05],start:[,,427,.01,.37,1.55,1,3.3,.4,.5,,,,.2,.2,.1,.36],win:[,,10,.22,.18,.93,2,.9,,-.9,150,.06,.09],lose:[,,31,.03,.24,.95,3,2.76,.1,,,,,.7,,.7],tie:[,,393,.03,.57,.11,1,1.65,,,4,.58,,.5,,.6],idk:[,,35,.5,.42,.34,,.49,,,258,.05,.25,,,,.13]},te={},ee=t=>{Mt()&&(zt=te[t]||.3,Wt(...Qt[t]||Qt.idk))};let ne={},ae={};const oe=()=>{let t=x("main").style,e=()=>{const{innerHeight:e}=window;t.height=e+"px"};addEventListener("resize",e),Ee(Ge()),e(),ne=function(t,e){let n=(e=e||{}).minScale?e.minScale:.1,a=e.maxScale?e.maxScale:1,o=e.increment?e.increment:.2,s=!!e.liner&&e.liner;return function(t,e,n,a,o){const s=a,l=e,r=n,i=o;let c=!1,p=!1,d=0,y=0,m=0;t.style.transform="matrix(1, 0, 0, 1, 0, 0)";const u=()=>{let e=t.style.transform,n=e.indexOf("(")+1,a=e.indexOf(")"),o=e.slice(n,a).split(",");return{scale:+o[0],transX:+o[4],transY:+o[5]}},h=e=>{t.style.transform="matrix("+e.scale+", 0, 0, "+e.scale+", "+e.transX+", "+e.transY+")"},g=(t,e)=>{let n=u();n.transX+=t,n.transY+=e,h(n)},f=(e,n,a,o)=>{let s=o||u(),c=n-(t.width?t.width:t.offsetWidth)/2,p=a-(t.height?t.height:t.offsetHeight)/2;s.scale+=e=i?e:e*s.scale;let d=s.scale<=l||s.scale>=r;s.scale<l&&(s.scale=l),s.scale>r&&(s.scale=r),d||(g(c,p),h(s),g(-c*e,-p*e))},_=(t,e,n,a)=>Math.round(Math.sqrt(Math.pow(n-t,2)+Math.pow(a-e,2))),E=(t,e,n,a)=>({x:Math.min(t,n)+Math.abs(n-t)/2,y:Math.min(e,a)+Math.abs(a-e)/2}),G=t=>{const{clientX:e,clientY:n}=t[1],{clientX:a,clientY:o}=t[0];return{center:E(e,n,a,o),d:_(e,n,a,o)}};t.addEventListener("mousedown",t=>{0===t.button&&(t.preventDefault(),c=!0,d=t.clientX,y=t.clientY)}),t.addEventListener("touchstart",t=>{t.preventDefault();const e=t.touches,n=e.length;if(n)if(c=!0,n>=2){p=!0,Ae=!0;const{center:{x:t,y:n},d:a}=G(e);m=a,d=t,y=n}else d=e[0].clientX,y=e[0].clientY}),t.addEventListener("mouseup",t=>{0===t.button&&(c=!1,p=!1,Ae=!1)}),t.addEventListener("mouseleave",()=>{p=!1,c=!1,Ae=!1}),t.addEventListener("touchend",t=>{0===t.touches.length&&(c=!1,p=!1,Ae=!1)}),t.addEventListener("mousemove",t=>{c&&(g(t.clientX-d,t.clientY-y),d=t.clientX,y=t.clientY)}),t.addEventListener("touchmove",e=>{const n=e.touches;if(c||p){let a=0,o=0;if(n.length>=2){const{center:{x:e,y:s},d:l}=G(n);if(a=e-d,o=s-y,g(a,o),d=e,y=s,Math.abs(l-m)>2){const n=u(),a=t.getBoundingClientRect();f(l>m?.042:-.042,Math.round((e-a.left)/n.scale),Math.round((s-a.top)/n.scale)),m=l}}else if(!p){const t=e.touches[0];a=t.clientX-d,o=t.clientY-y,g(a,o),d=t.clientX,y=t.clientY}}});const b=t=>{f(Math.max(-1,Math.min(1,t.wheelDelta||-t.detail))<0?-s:s,t.offsetX,t.offsetY)};return t.addEventListener("DOMMouseScroll",b,!1),t.addEventListener("mousewheel",b,!1),{translateZoom:({x:e,y:n,scale:a})=>{f(a-1,e,n,{scale:1,transX:-(e-t.offsetWidth/2),transY:-(n-t.offsetWidth/2)}),d=e,y=n}}}(document.getElementById("cc"),n,a,o,s)}(0,[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},se=t=>{Ot(t),Bt({}),Tt([]),kt([]),ge("game"),It(null);const{players:e,width:n,height:a}=t;((t,e)=>{const n=x("c");n.width=t,n.height=e})(2*n*G_SCALE,2*a*G_SCALE);const o=ot(t);Dt("Normal"),Lt(G_action_shoot),q=o.color,ae={};const s=x("players");d(s,"");for(let n=0;n<e.length;n++){const a=G_getEntityFromEntMap(e[n],t),{x:o,y:l,name:r,color:i}=a,c=document.createElement("div");d(c,r),c.className="player-name",c.id="pl-"+i;const{x:p,y:y}=b(o,l);c.style.left=p-100+"px",c.style.top=y-75+"px",c.style.color=g("light",i),s.appendChild(c)}St(!1),wt(!1),$t(!1),Fe(t.resources.map(e=>G_getEntityFromEntMap(e,t))),_(()=>{v(t)})},le=t=>{const{resources:e}=t;for(let n=0;n<e;n++){const a=G_getEntityFromEntMap(e[n],t);x("res-"+a.id)||Le(a)}[...x("res").children].map(t=>{const e=t.children;return{resourceId:e[e.length-1].id.slice(4),child:t}}).forEach(({resourceId:t,child:n})=>{e.find(e=>e===t)||n.remove()})},re=t=>{Ct(!0),Xt(!1),se(t);const e=ot(t);x("particles").innerHTML="",jt([e.x,e.y+100]),he(),Oe(t)},ie=()=>{pe(gt()),ge("menu"),Ft(null),Ot(null),Ct(!1)},ce=(t,e)=>{let n;Ot(t),St(!1),wt(!0),x("particles").innerHTML="",Oe(t),M(t),kt([]),setTimeout(()=>{ee("shootNorm")},G_GAME_TIME_BUFFER_MS);let o=+new Date,s=0,l=0;setTimeout(()=>{_(()=>{n=+new Date;let r=n-G_GAME_TIME_BUFFER_MS-o;const i=ct();if(i.length){let n=!1,a=i[l],o=i[l+1];for(;o&&o.timestamp<=r;)a=o,l+=1,o=i[l+1],n=!0;if(n){const n=t.entMap;for(let t in a.dynamicGameData.partialEntMap)n[t]=a.dynamicGameData.partialEntMap[t];if(Ot({...gt(),...a.dynamicGameData,entMap:n}),a.last){$e(a.dynamicGameData);const t=gt();return void(e?e(t):pe(t))}$e(a.dynamicGameData)}}let c=gt(),{projectiles:p,planets:d,players:y,resources:m}=c;const u=p.map(t=>G_getEntityFromEntMap(t,c)),h=u.concat(d.map(t=>G_getEntityFromEntMap(t,c))),g=y.map(t=>G_getEntityFromEntMap(t,c)).concat(m.map(t=>G_getEntityFromEntMap(t,c)));G_applyGravity(u,h,g,a),M(c),de(c),ye(c,r),s++,s%10==0&&Ce(c)})},G_GAME_TIME_BUFFER_MS)},pe=t=>{if(clearInterval(-1),_(()=>{const t=gt();v(t)}),wt(!1),Dt("Normal"),Lt(G_action_shoot),Tt([]),t){Ot(t),de(t),le(t);const e=ot(t);e.actions[yt()]||Lt(G_action_shoot),Oe(t);for(let e=0;e<t.projectiles.length;e++){const n=G_getEntityFromEntMap(t.projectiles[e],t),{x:a,y:o,meta:s}=b(n.px,n.py);Re(a,o,s&&"Move"===s.type?"mv":"sm"),ee("expl")}t.projectiles=[],M(t),de(t);const{x:n,y:a}=b(e.x,e.y);if(!e.dead){const e=t.baseFundsPerRound;d(x("banner-message3"),`All players granted $${e} at completion of the round.`),setTimeout(()=>{Ne(n,a-30,"+$"+e,g("light",mt()))},500),setTimeout(()=>{d(x("banner-message3"),"")},3e3)}}},de=t=>{let e=t.collisions,n=e.length;const a=t=>{const e=(x("res-"+t)||{}).parentElement;return!!e&&(e.remove(),!0)};if(n)for(let o=0;o<n;o++){const[n,s,,l]=e[o];if(ae[l])continue;ae[l]=!0;const r=G_getEntityFromEntMap(n,t);if(!r)continue;const i=G_getEntityFromEntMap(s,t);if(!r)return;const{x:c,y:p}=b(r.px,r.py),d=G_getEntityFromEntMap(r.meta.player,t),y=g("light",d.color);switch(G_getEntityType(i)){case G_entity.player:{if(r.meta.player===i.id)continue;ee("playerDead");const e=G_getEntityFromEntMap(i.id,t),{x:n,y:a}=b(i.x,i.y);e.dead=!0,Ne(n,a,"Eliminated!",y),Ie(e.x,e.y,G_AU/2,7);break}case G_entity.projectile:ee("expl"),Re(c,p);break;case G_entity.coin:{ee("coin"),Re(c,p),a(i.id);const{x:t,y:e}=b(i.x,i.y);Ne(t,e,"+$"+i.value,y);break}case G_entity.spray:{ee("getSpreadFire"),Re(c,p),a(i.id);const{x:t,y:e}=b(i.x,i.y);Ne(t,e,"+2 SpreadFire",y);break}case G_entity.planetCracker:{ee("getPC"),Re(c,p),a(i.id);const{x:t,y:e}=b(i.x,i.y);Ne(t,e,"+2 PlanetCracker",y);break}case G_entity.cluster:{ee("getCluster"),Re(c,p),a(i.id);const{x:t,y:e}=b(i.x,i.y);Ne(t,e,"+2 ClusterBomb",y);break}case G_entity.planet:r.meta.type===G_action_planetCracker?(ee("explLarge2"),Ie(i.px,i.py,G_AU,30)):r.meta.type===G_action_move?(ee("playerDead2"),d.dead=!0,Ne(c,p,"Eliminated!",y),Ie(d.x,d.y,G_AU/2,10)):(ee("expl"),Re(c,p));break;case G_entity.wormhole:{ee("wormhole");const{x:t,y:e}=b(r.meta.prevX,r.meta.prevY);je(c,p),je(t,e);break}case G_entity.nothing:default:ee("expl"),Re(c,p)}}},ye=(t,e)=>{const n=t.projectiles;for(let a=0;a<n.length;a++){const o=G_getEntityFromEntMap(n[a],t),{meta:s,px:l,py:r}=o;if(s.player&&s.type===G_action_move&&e<=o.t){const e=at(s.player,t);e.x=l,e.y=r}}},me=t=>{vt(t),Oe(gt())};let ue=-1;const he=()=>{const t=ot(gt()),{x:e,y:n}=b(t.x,t.y),a=x("cc").style;a.transition="transform 0.5s",ne.translateZoom({x:e,y:n,scale:.65}),clearTimeout(ue),ue=setTimeout(()=>{a.transition=""},500)},ge=(t,e)=>{j=t,nt.forEach(n=>{const a=x(n);let o="none";t===n&&(o="flex",e&&e()),a.style.display=o})},fe=t=>{O=j,ge("dialog"),x("dialog-text").innerHTML=t},_e=t=>{if(gt()&&t.result){const e=G_getEntityFromEntMap(t.result,t);e?e===ot(t)?ee("win"):ee("lose"):ee("tie"),Ct(!1),$t(!0),Ot(t),Oe(t),M(t)}},Ee=t=>{x("player-name-input").value=t,W=t,localStorage.setItem("js13k2020_orbital_forts_u",t)},Ge=()=>ft()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",be=t=>{ie(),Pe([]),ge("menu"),fe(t)},xe=t=>{let e=x("c");if(t.changedTouches){const n=t.changedTouches[0],a=e.parentElement.style.transform,{left:o,top:s}=e.getBoundingClientRect(),l=parseFloat(a.slice(7,a.indexOf(",")));let{x:r,y:i}=G((n.clientX-o)/l,(n.clientY-s)/l);jt([r,i])}else{const{offsetX:e,offsetY:n}=t;let{x:a,y:o}=G(e,n);jt([a,o])}Gt()?(He(gt()),M(gt())):(Oe(gt()),M(gt()))},Me=t=>{if(!t)throw Error("no replay provided to start");const{initialGameData:e}=t;Xt(!0),$t(!1),Ut(0),Z=t,He(t,e),se(e);const n=ot(e);jt([n.x,n.y+100]),he()},ve=()=>{const t=bt(),e=gt();t&&e&&($t(!0),He(t,e))},Se=()=>{const t=bt(),e=gt();if(clearInterval(-1),_(()=>{const t=gt();v(t)}),wt(!1),e){He(t,e);for(let t=0;t<e.projectiles.length;t++){const n=e.projectiles[t],{x:a,y:o,meta:s}=b(n.px,n.py);Re(a,o,s&&"Move"===s.type?"mv":"sm"),ee("expl")}e.projectiles=[],M(e),de(e);const n=xt();if(n+1>t.rounds.length)e.result=t.result,ve();else{const a=t.rounds[n];if(a.dynamicGameData){const t={...e,...a.dynamicGameData};Ot(t),le(t)}}}},we=()=>{if(!Gt())return;const t=bt(),e=xt(),n=t.rounds[e];n&&(((t,e)=>{let n=gt();t.dynamicGameData&&(Ot({...n,...t.dynamicGameData}),n=gt()),St(!1),wt(!0),x("particles").innerHTML="",He(e,n),M(n),Tt([n]),setTimeout(()=>{ee("shootNorm")},G_GAME_TIME_BUFFER_MS);const a=ot(n);a&&t.actions[a.id]&&jt(t.actions[a.id].target);for(let e in t.actions){const a=t.actions[e],o=at(e,n);G_applyAction(n,o,a)}Tt(t.snapshots.map((e,n)=>({timestamp:e.timestamp,dynamicGameData:e.dynamicGameData,last:n===t.snapshots.length-1}))),ce(n,Se)})(n,t),Ut(e+1))},$e=t=>JSON.parse(JSON.stringify(t)),Ce=t=>{const e=pt();e.push($e(t)),e.length>500&&e.shift()};let Ae=!1;const Te={0:"#00f",1:"#00f",2:"red",3:"red",4:"yellow",5:"yellow",6:"cyan",7:"cyan",8:"orange",9:"orange",10:"green",11:"green"};let ke=0;const De=(t,e,n,a,o,s,l)=>{l=l||{};const r={position:"absolute",left:a+"px",top:o+"px",...l},i=document.createElement("div");i.className=n,"string"==typeof e?d(i,e):i.appendChild(e),i.id=s;for(let t in r)i.style[t]=r[t];return t.appendChild(i),i},Le=t=>{const e=x("res"),{x:n,y:a,id:o,type:s}=t;let{label:l,content:r,offsetTop:i,elem:c}=G_res_sprites[s]||{};const p=s===G_res_wormhole;let d="",y="";const{x:m,y:u}=b(n,a),h=document.createElement(c);h.innerHTML=l||"";const g=De(h,r||"","resource "+s,m-100,u-i,"res-"+o);if(p){const t=Te[ke];d=t,y=`radial-gradient(circle at 50% 120%, ${t}, ${t} 10%, rgb(75, 26, 63) 80%, #062745 100%)`,g.children[0].style.background=`radial-gradient(circle at 50% 0px, ${t}, rgba(255, 255, 255, 0) 58%)`,ke++}d&&(g.style.color=d),y&&(g.style.background=y),h.style.left=g.style.left,h.style.top=g.style.top,h.className="res2 centered",g.style.position="unset",e.appendChild(h)},Fe=t=>{const e=x("res");d(e,""),ke=0;for(let e=0;e<t.length;e++)Le(t[e])},Ie=(t,e,n,a)=>{for(let o=0;o<a;o++){const{x:s,y:l}=G_getRandomLocInCircle(t,e,n),{x:r,y:i}=b(s,l);setTimeout(()=>{Re(r,i)},o/a*800)}},Re=(t,e)=>{const n=t+","+e;x(n)||De(x("particles"),"","expl",t-50,e-50,n)},Ne=(t,e,n,a)=>{const o="text,"+t+","+e;x(o)||De(x("particles"),n,"text-particle",t-100,e,o,{color:a})},je=(t,e)=>{for(let n=0;n<10;n++){const a=G_normalize(n,0,10,0,360),o=`worm${n},${t},${e}`;if(x(o))return;De(x("particles"),'<div class="worm"></div>',"",t,e,o,{transform:`rotateZ(${a}deg)`})}},Oe=t=>{if(!t)return;const e=ot(t),n=N,a=rt(),o=e.dead,s=st();x("controls").style.display=lt()||s||a||o?"none":"flex",x("center-self").style.display="block",x("confirm-button").style.display="block",x("control-panel").style.display="flex",x("leave-game").style.display=a||o?"block":"none",x("view-last-replay").style.display=a?"block":"none";let l="";Object.keys(G_SPEEDS).forEach(t=>{let[,e]=G_SPEEDS[t],a=t===dt()?f(mt()):"";l+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${e}</div>\n<div class="action" style="${a}" id="${t}" onclick="events.setSpeed('${t}')" onmousedown="events.setSpeed('${t}')">${t}\n</div>\n</div>`}),d(x("speed-buttons"),l),x("back-practice").style.display=1===gt().players.length?"block":"none";let r="";G_actions.forEach(([t,n],a)=>{const o=e.actions[t];o&&(r=Xe(t+(o<99?` (${o})`:""),"$"+n,t,a>1)+r)}),d(x("action-buttons"),r);const i=G_getActionCost(yt())+G_getSpeedCost(dt());x("confirm-button").disabled=i>e.funds,d(x("funds"),"Funds: $"+e.funds);let c=x("target");const p=ht(),{x:y,y:m}=b(p[0],p[1]);c.style.display=lt()||a||o?"none":"flex",c.style.left=y-30+"px",c.style.top=m-30+"px",c.style.stroke=g("",mt()),c.className="target";const u=x("x").cloneNode(!0);u.id="x2",u.style.display="block",d(c,""),c.appendChild(u),Be(t)},Be=(t,e,n)=>{const a=ot(t),o=rt(),s=a.dead,l=st(),r=x("banner-message"),i=x("banner-message2");if(d(r,""),d(i,""),o){const e=at(t.result,t);return d(r,"The Game is Over!"),void d(i,e?`The Victor is <span style="${f(e.color)}">${e.name}</span>!`:"The result is a DRAW!")}if(n)d(r,"Viewing replay: "+n.name);else if(s)d(r,"You have been eliminated!");else if(!lt())if(l){const t=(e=e||J).playersNotReady||[];if(0===t.length)return;d(r,"Waiting for other players: "+t.map(({playerName:t,color:e})=>`<span style="${f(e)}">${t}</span>`).join(", "))}else d(r,`You are the <span style="${f(a.color)}border:1px solid;padding:2px;">${a.color}</span> player.`),d(i,`<span style="color:${g("light",a.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${g("light",a.color)}">[Left Click/Tap]</span> to pan.`)},Pe=t=>{const e=x("games");d(e,"");for(let n=0;n<t.length;n++){const{id:a,name:o}=t[n];e.innerHTML+=`<button class="join-button" onclick="events.join('${a}')">${n+1}. Join Game: ${o}</button>`}t.length||d(e,'<span style="color:lightblue"> There are no joinable games at the moment.</span>'),d(x("map-select-practice"),Ue({ownerId:ut()},"menu-map-select"))},Ye=t=>{const{players:e}=t,n=x("players-lobby");d(n,"");for(let t=0;t<e.length;t++){const{id:a,userName:o}=e[t];n.innerHTML+=`<div class="lobby-player">${t+1}. ${a===ut()?`<a class="lobby-name">${o}</a>`:o}</div>`}const a=e[0].id===ut(),o=e.length>1&&e.length<=4,s=x("map-select");s.parentElement.style.padding=a?"":"0.5rem 0",d(s,Ue(t,"lobby-map-select")),d(x("lobby-title"),k),d(x("player-count"),`<a style="color:${o?"#12a012":"red"}">${e.length} of 4</a> joined (at least 2 required to start)`);const l=x("start");l.style.display=a?"block":"none",l.disabled=!o},Xe=(t,e,n,a)=>`<div class="h-button-list">\n<button class="action" onclick="events.setAction('${n}')" onmousedown="events.setAction('${n}')"\nstyle="${yt()===n?f(mt()):""};width:80%;margin:2px;animation:${a?"2s linear infinite border-color;":""}">${t}</button>\n<div>${e}</div>\n</div>`,Ue=(t,e)=>{const n=ut()===t.ownerId,a=n?_t():t.mapIndex,o=Et(),s=a>-1&&a<o.length?o[a].name:"Custom Map",l=Et().reduce((t,e,n)=>t+`<option ${a===n?"selected":""} value=${n}>${e.name}</option>`,"");return n?`<select id="${e}" value="${a}" onchange="events.setMapIndex(this.id)">${l}</select>`:`<span style="color:lightblue;">${s}</span>`},He=(t,e)=>{if(!t)return;const n=rt();x("controls").style.display=lt()?"none":"flex",x("control-panel").style.display="none",x("center-self").style.display="none",x("leave-game").style.display="none",x("view-last-replay").style.display="none",x("back-practice").style.display="block",x("confirm-button").style.display="none",d(x("speed-buttons"),""),d(x("action-buttons"),n?'\n<button onclick="events.viewLastReplay()">Restart Replay</button>\n    ':'\n  <button onclick="events.replayNextRound()">Simulate Round</button>\n    ');const a=xt();d(x("funds"),"Current Round: "+Math.min(a+1,t.rounds.length)+"/"+t.rounds.length),x("target").style.display="none",Be(e,null,t)},Je=()=>{const t=Mt(),e=x("sound");e.style.background="white",e.src=t?"sound.svg":"no-sound.svg"}})();