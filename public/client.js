(()=>{const e=async(e,t,n)=>{he(!0);const l=new Headers;l.key=te();const o=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:l}),s=await o.json();return s[1],he(!1),{result:s[0],err:s[1]}};let t,n;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on(G_S_CONNECTED,([{games:e,maps:t,id:n}])=>{we(n),Ge(t),E(e)}),e.on(G_S_LIST_UPDATED,([e])=>{E(e)}),e.on(G_S_LOBBY_LIST_UPDATED,([e])=>{G(e)}),e.on(G_S_START,([{startTime:e,gameData:t}])=>{Ae(t)}),e.on(G_S_STOP,([e])=>{Re("menu"),Ne(e),Ee(null)}),e.on(G_S_START_SIMULATION,([e])=>{_e([e]),Ce(e)}),e.on(G_S_STOP_SIMULATION,([e])=>{_e([]),ke(e)}),e.on(G_S_BROADCAST,([{gameData:e}])=>{Ee(e);const t=ne();t.push(e),t.length>500&&t.shift()}),e.on(G_S_FINISHED,([e])=>{je(e)}),e.on("connect",()=>{}),e.on("disconnect",e=>{Xe("You disconnected from the game server!")}),e.on("error",e=>{Xe("An error occurred with the connection to the game server!")}),Me()},!1)})();let l=!1,o=null,s=Math.PI;const a=()=>g("c").getContext("2d"),i=(e,t)=>{e.innerHTML=t},r=(e,t,n,l)=>{const o=a();o.beginPath(),o.arc(e,t,n,0,2*s,!1),o.fillStyle=l,o.fill()},c=(e,t,n,l,o,i)=>{const r=a();if(r.save(),r.beginPath(),r.translate(e,t),r.fillStyle=o,void 0!==i){const e=n/2,t=l/2;r.translate(e,t),r.rotate(i*s/180),r.fillRect(-e,-l/1.5,n,l)}else r.fillRect(0,0,n,l);r.restore()},d=(e,t,n,l)=>{let o=l-t,a=n-e;const{sqrt:i,asin:r}=Math;let c=i(a*a+o*o),d=0;return d=l>=t&&n>=e?180*r(o/c)/s+90:l>=t&&n<e?180*r(o/-c)/s-90:l<t&&n>e?180*r(o/c)/s+90:180*r(-o/c)/s-90,d>=360&&(d=360-d),d<0&&(d=360+d),isNaN(d)?0:d},p=e=>`background-color:${h("dark",e)};color:${h("light",e)};`,y=e=>{t=+new Date,n=0,o=e;const s=()=>{let e=+new Date;n=e-t,t=e,o(),requestAnimationFrame(s)};l||requestAnimationFrame(s),l=!0},u=()=>{const e=a().canvas,{left:t,top:n}=e.getBoundingClientRect();return{left:t,top:n,width:e.width,height:e.height}},h=(e,t)=>({"":{blue:"#44F"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#B8860B"}}[e][t]||e+t),m=(e,t)=>{const{width:n,height:l}=u();return{x:(e-n/2)/G_SCALE,y:-(t-l/2)/G_SCALE}},f=(e,t)=>{const{width:n,height:l}=u();return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+l/2)}},g=e=>document.getElementById(e),x=e=>{const{players:t,planets:n,projectiles:l}=e,o=ne();(()=>{const e=a(),t=e.canvas;e.fillStyle="#222",e.fillRect(0,0,t.width,t.height)})();for(let t=0;t<o.length;t++){const{projectiles:n}=o[t];for(let t=0;t<n.length;t++){const{px:l,py:o,r:s,meta:a}=n[t],{x:i,y:c}=f(l,o),d=V(a.player,e);r(i,c,s*G_SCALE,h("light",d.color))}}w(t),S(n,e),S(l,e);let s=e.collisions,i=s.length;if(i)for(let t=0;t<i;t++){const[n,l]=s[t],{x:o,y:a}=f(n.px,n.py);if((l&&l.meta||{}).player===n.meta.player)continue;"Move"!==n.meta.type&&v(o,a);let i=e.projectiles.indexOf(n);if(i>-1&&e.projectiles.splice(i,1),W(l)){const t=V(n.meta.player,e);g("res-"+l.id).remove();let o="";switch(l.type){case G_res_coin:o="+$"+l.value;break;case G_res_spray:o="+Spreadfire"}const{x:s,y:a}=f(l.x,l.y);b(s,a,o,h("light",t.color))}const r=l&&J(l,e),c=l&&"Move"===n.meta.type&&!!l.color;let d=null;if(r?d=V(l.id,e):c&&(d=V(n.meta.player,e)),d){d.dead=!0;const{x:e,y:t}=f(d.x,d.y);b(e,t,"Eliminated!",h("light",d.color));for(let e=0;e<15;e++){const{x:t,y:n}=G_getRandomLocInCircle(d.x,d.y,G_AU/2),{x:l,y:o}=f(t,n);setTimeout(()=>{v(l,o)},e/12*2e3)}}}e.collisions=[]},_=(e,t,n,l,o,s,a)=>{a=a||{};const r={position:"absolute",left:l+"px",top:o+"px",...a},c=document.createElement("div");c.className=n,i(c,t),c.id=s;for(let e in r)c.style[e]=r[e];e.appendChild(c)},v=(e,t)=>{const n=e+","+t;g(n)||_(g("particles"),"","expl",e-50,t-50,n)},b=(e,t,n,l)=>{const o="text,"+e+","+t;g(o)||_(g("particles"),n,"text-particle",e-100,t,o,{color:l})},w=e=>{for(let t=0;t<e.length;t++){const{x:n,y:l,r:o,color:s,target:a,dead:i}=e[t],{x:p,y:y}=f(n,l),u=2*o*G_SCALE-10,m=u/2,[x,_]=s===oe()?ie():a,{x:v,y:b}=f(x,_),w=g("player-name-"+s);w.style.left=p-100+"px",w.style.top=y-75+"px",i?w.style.opacity=0:(r(p,y,o*G_SCALE,h("dark",s)),c(p-m,y-m,u,u,h("",s)),c(p-5,y-30,10,60,"white",d(p,y,v,b)),r(p,y,m/1.5,h("light",s)))}},S=(e,t)=>{for(let n=0;n<e.length;n++){const{meta:l,px:o,py:s,r:a,color:i}=e[n],{x:c,y:d}=f(o,s);if("object"==typeof l){const e=V(l.player,t);if(l.player&&"Move"===l.type){e.x=o,e.y=s;continue}}r(c,d,a*G_SCALE,"object"==typeof l?V(l.player,t).color:i)}},$=e=>{if(!e)return;const t=z(e),n=K(),l=ee(),o=t.dead,s=Q();g("controls").style.display=Z()||s||l||o?"none":"flex",g("leave-game").style.display=l||o?"block":"none";let a="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],l=e===le()?p(oe()):"";a+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${t}</div>\n<div class="action" style="${l}" id="${e}" onclick="events.setSpeed('${e}')">${e}\n</div>\n</div>`}),i(g("speed-buttons"),a),g("back-practice").style.display=ue()?"block":"none";let r="";G_actions.forEach(([e,n],l)=>{t.actions[e]&&(r=((e,t,n,l,o)=>`<div class="h-button-list">\n<button ${l?"disabled":""} onclick="events.confirmAction('${n}')" style="width:120px;margin:2px;animation:${o?"2s linear infinite border-color;":""}">${e}</button>\n<div>${t}</div>\n</div>`)(e,"$"+n,e,G_getSpeedCost(le())+n>t.funds,l>1)+r)}),i(g("action-buttons"),r),g("funds").innerHTML="Funds: $"+t.funds;let c=g("target");const d=ie(),{x:y,y:u}=f(d[0],d[1]);c.style.display=Z()||l||o?"none":"flex",c.style.left=y-30+"px",c.style.top=u-30+"px",c.style.stroke=h("",oe()),c.className="target";const m=g("x").cloneNode(!0);m.id="x2",m.style.display="block",i(c,""),c.appendChild(m);const x=g("banner-message"),_=g("banner-message2");if(s?i(x,"Waiting for other players..."):l?i(x,"The Game is Over!"):o?i(x,"You have been destroyed!"):x.innerHTML=`You are the <span style="${p(t.color)}border:1px solid;padding:2px;">${t.color}</span> player.`,l){const t=V(e.result,e);t?_.innerHTML=`The Victor is <span style="${p(t.color)}">${t.name}</span>!`:i(_,"The result is a DRAW!")}else s||Z()||o?i(_,""):i(_,`<span style="color:${h("light",t.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${h("light",t.color)}">[Left Click/Tap]</span> to pan.`)},E=e=>{const t=g("games");i(t,"");for(let n=0;n<e.length;n++){const{id:l,name:o}=e[n];let s=n+1;t.innerHTML+=`<button style="background-color:#225;" onclick="events.join('${l}')">${s}. Join Game: ${o}</button>`}},G=e=>{const t=g("players-lobby");i(t,"");for(let n=0;n<e.length;n++){const{id:l,userName:o}=e[n];let s=n+1;t.innerHTML+=`<div class="lobby-player">${s}. ${l===se()?`<span class="lobby-name">${o}</span>`:o}</div>`}const n=ye(),l=e[0].id===se(),o=e.length>1&&e.length<=n.maxPlayers,s=g("lobby-map-select");s.innerHTML=pe().reduce((e,t,n)=>e+`<option value=${n}>${t.name}</option>`,""),s.value=de(),s.style.display=l?"block":"none",i(g("lobby-title"),ae());const a=g("start");a.style.display=l?"block":"none",a.disabled=!o};let T=null,L=null,M=null,A=null,C=null,k=0,D=[],Y=!1,R="menu",N=null,j=!1,I="Normal",O=!1,X=[0,0],H=null,P="blue",B="",F=!1,q=null,U=["dialog","game","lobby","menu"];const W=e=>{if(e){const t=e.type;return t===G_res_spray||t===G_res_coin}return!1},J=e=>!(!e.color||!e.target),V=(e,t)=>t.players.reduce((t,n)=>n.id===e?n:t,null),z=e=>{const{players:t}=e||{};for(let e=0;e<t.length;e++){const n=t[e];if(n.id===se())return n}return null},K=()=>Y,Q=()=>O,Z=()=>j,ee=()=>F,te=()=>C,ne=()=>D,le=()=>I,oe=()=>P,se=()=>T,ae=()=>M,ie=()=>X,re=()=>H,ce=()=>B,de=()=>k,pe=()=>q,ye=()=>q[k],ue=()=>1===re().players.length,he=e=>Y=e,me=e=>O=e,fe=e=>j=e,ge=e=>F=e,xe=e=>A=e,_e=e=>D=e,ve=e=>I=e,be=e=>L=e,we=e=>T=e,Se=e=>M=e,$e=e=>X=e,Ee=e=>H=e,Ge=e=>q=e;window.events={async create(t){Ie(g("player-name-input").value);const{result:n,err:l}=await e(G_R_CREATE,`${se()}/${ce()||se()}/${!!t}`);if(!l){const{id:e,name:l}=n;be(e),Se(l||"Game Name"),Re("lobby"),G([{id:se(),userName:ce()}]),t&&await window.events.start()}},async join(t){Ie(g("player-name-input").value);const{result:n,err:l}=await e(G_R_JOIN,`${se()}/${t},${ce()||se()}`);if(l)Xe("Could not join game.");else{const{id:e,name:t,players:l}=n;be(e),Se(t),Re("lobby"),G(l)}},async leave(){const{err:t}=await e(G_R_LEAVE,""+se());t||(be(null),Re("menu"))},async start(){await e(G_R_START,`${se()}/${de()}`)},async setMapIndex(e){void 0===e&&(e=g("lobby-map-select").value),k=e},async confirmAction(t){let n;switch(t){case G_action_spread:case G_action_shoot:case G_action_move:const[e,t]=ie();n=[e,t,le()].join(",");break;default:n=null}const l=G_getActionCost(t),o=z(re()),{x:s,y:a}=f(o.x,o.y);b(s,a-30,"-$"+l,h("light",oe())),De(!0),me(!0);const{err:i}=await e(G_R_CONFIRM_ACTION,`${se()}/${t}/${n}`);i&&me(!1),De(!1)},setSpeed(e){ve(e),$(re())},setTarget(e){e.preventDefault(),e.stopPropagation(),!A||Q()||Z()||He(e)},centerCam(){Ye()},async returnToMenu(){L&&await window.events.leave(),Ee(null),be(null),Re("menu")},hideDialog(){Re(N)}};let Te=g("c"),Le=0;Te.addEventListener("touchend",e=>{if(Pe)return;let t=+new Date;t-Le<500&&(window.events.setTarget(e),e.preventDefault()),Le=t}),Te.addEventListener("contextmenu",window.events.setTarget);const Me=()=>{let e=g("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),Ie(Oe()),t(),function(e,t){function n(e,t,n,l,o){const s=l,a=t,i=n,r=o;let c=!1,d=!1,p=0,y=0,u=0;e.style.transform="matrix(1, 0, 0, 1, 0, 0)";const h=()=>{let t=e.style.transform,n=t.indexOf("(")+1,l=t.indexOf(")"),o=t.slice(n,l).split(",");return{scale:+o[0],transX:+o[4],transY:+o[5]}},m=t=>{e.style.transform="matrix("+t.scale+", 0, 0, "+t.scale+", "+t.transX+", "+t.transY+")"},f=(e,t)=>{let n=h();n.transX+=e,n.transY+=t,m(n)},g=(t,n,l)=>{let o=h(),s=n-(e.width?e.width:e.offsetWidth)/2,c=l-(e.height?e.height:e.offsetHeight)/2;t=r?t:t*o.scale,o.scale+=t;let d=o.scale<=a||o.scale>=i;o.scale<a&&(o.scale=a),o.scale>i&&(o.scale=i),d||(f(s,c),m(o),f(-s*t,-c*t))},x=(e,t,n,l)=>Math.sqrt(Math.pow(n-e,2)+Math.pow(l-t,2)),_=(e,t,n,l)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,l)+Math.abs(l-t)/2});e.addEventListener("mousedown",e=>{0===e.button&&(e.preventDefault(),c=!0,p=e.clientX,y=e.clientY)}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(c=!0,n>=2){const{clientX:e,clientY:n}=t[1],{clientX:l,clientY:o}=t[0];u=x(e,n,l,o),d=!0,Pe=!0;const{x:s,y:a}=_(e,n,l,o);p=s,y=a}else p=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",e=>{0===e.button&&(c=!1,Pe=!1)}),e.addEventListener("mouseleave",()=>{c=!1,Pe=!1}),e.addEventListener("touchend",e=>{0===e.touches.length&&(c=!1,d=!1,Pe=!1)}),e.addEventListener("mousemove",e=>{if(c){let t=e.clientX-p,n=e.clientY-y;f(t,n),p=e.clientX,y=e.clientY}}),e.addEventListener("touchmove",e=>{const t=e.touches,n=t.length;if(c||d){let l=0,o=0;if(n>=2){const{clientX:e,clientY:n}=t[1],{clientX:s,clientY:a}=t[0],i=x(e,n,s,a),{x:r,y:c}=_(e,n,s,a);l=r-p,o=c-y,f(l,o),p=r,y=c;const d=h();g(i>u?.018:-.018,d.tranX,d.transY),u=i}else{const t=e.touches[0];l=t.clientX-p,o=t.clientY-y,f(l,o),p=t.clientX,y=t.clientY}}});const v=e=>{let t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));g(t<0?-s:s,e.offsetX,e.offsetY)};e.addEventListener("DOMMouseScroll",v,!1),e.addEventListener("mousewheel",v,!1)}let l=[],o=(t=t||{}).minScale?t.minScale:.1,s=t.maxScale?t.maxScale:1,a=t.increment?t.increment:.2,i=!!t.liner&&t.liner;document.querySelectorAll(e).forEach((function(e){l.push(new n(e,o,s,a,i))})),1==l.length&&l[0]}("#cc",[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},Ae=e=>{xe(!0),Ee(e),Re("game");const{players:t,width:n,height:l}=e;((e,t)=>{const n=g("c");n.width=e,n.height=t})(2*n*G_SCALE,2*l*G_SCALE);const o=z(e);var s;ve("Normal"),s=o.color,P=s;const a=g("players");i(a,"");for(let e=0;e<t.length;e++){const{x:n,y:l,name:o,color:s}=t[e],r=document.createElement("div");i(r,o),r.className="player-name",r.id="player-name-"+s;const{x:c,y:d}=f(n,l);r.style.left=c-100+"px",r.style.top=d-75+"px",r.style.color=h("light",s),a.appendChild(r)}$e([o.x,o.y+100]),Ye(),me(!1),fe(!1),ge(!1),g("particles").innerHTML="",Re("game"),$(e),(e=>{const t=g("res");i(t,"");for(let n=0;n<e.length;n++){const{x:l,y:o,id:s,type:a}=e[n],{x:i,y:r}=f(l,o);_(t,a===G_res_coin?"$":"!","resource "+a,i-25,r-25,"res-"+s)}})(e.resources),x(e)},Ce=e=>{Ee(e),me(!1),fe(!0),g("particles").innerHTML="",$(e),x(e),y(()=>{let e=re();G_applyGravity(e.projectiles,e.planets,e.players.concat(e.resources),n),x(e)})},ke=e=>{if(y((function(){})),fe(!1),e){Ee(e),$(e);for(let t=0;t<e.projectiles.length;t++){const n=e.projectiles[t],{x:l,y:o,meta:s}=f(n.px,n.py);v(l,o,s&&"Move"===s.type?"mv":"sm")}e.projectiles=[],x(e);const t=z(e),{x:n,y:l}=f(t.x,t.y);t.dead||setTimeout(()=>b(n,l-30,"+$"+e.baseFundsPerRound,h("light",oe())),500)}},De=e=>{he(e),$(re())},Ye=()=>{const e=z(re()),{width:t,height:n}=u(),{x:l,y:o}=f(e.x,e.y),s=g("cc").style;s.transition="transform 0.5s",s.transform=`matrix(1, 0, 0, 1, ${-(l-t/2)}, ${-(o-n/2-2)})`,setTimeout(()=>{s.transition=""},500)},Re=(e,t)=>{R=e,U.forEach(n=>{const l=g(n);let o="none";e===n&&(o="flex",t&&t()),l.style.display=o})},Ne=e=>{N=R,Re("dialog"),g("dialog-text").innerHTML=e},je=e=>{re()&&e.result&&(xe(!1),ge(!0),Ee(e),$(e),x(e))},Ie=e=>{g("player-name-input").value=e,B=e,localStorage.setItem("js13k2020_orbital_forts_u",e)},Oe=()=>ce()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",Xe=e=>{ke(re()),Re("menu"),be(null),Ee(null),xe(!1),E([]),Re("menu"),Ne(e)},He=e=>{let t=g("c");if(e.changedTouches){const n=e.changedTouches[0],l=t.parentElement.style.transform,{left:o,top:s}=t.getBoundingClientRect(),a=parseFloat(l.slice(7,l.indexOf(",")));let{x:i,y:r}=m((n.clientX-o)/a,(n.clientY-s)/a);$e([i,r])}else{const{offsetX:t,offsetY:n}=e;let{x:l,y:o}=m(t,n);$e([l,o])}$(re()),x(re())};let Pe=!1})();