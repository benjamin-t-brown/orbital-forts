(()=>{const e={},t=e=>e[0].id,s=e=>e[2]||t(e),n=(e,t)=>e[2]=t,o=e=>e[1],r=(e,t)=>e[1]=t,a=e=>e[1]=null,l=(e,t)=>[e,t],i=(e,t)=>JSON.stringify([e,t]),c=()=>(+new Date*Math.random()).toString(16),d=e=>(t,s)=>{try{e(t,s)}catch(e){s.send(i(null,"Internal server error."))}},p=()=>{const t=[],s=e=>{for(let s=0;s<t.length;s++){if(t[s].id===e)return!0}};for(const n in e){const r=o(e[n]);r&&(s(r.id)||t.push(r))}return t},_=()=>p().filter(e=>!e.isStarted()&&!e.isPractice()),u=()=>{((t,s,n)=>{for(const o in e){if(o===n)continue;const[r]=e[o];r.emit(t,s)}})(G_SOCKET_GAME_LIST_UPDATED,l(_()))},m=(t,s)=>{const n=(t=>e[t])(t);return n||(s.send(i(null,"No user exists: "+t)),!1)},G={[G_REST_CREATE_GAME+"/:id/:userName/:isPractice"]:d((e,t)=>{const{id:a,userName:l,isPractice:c}=e.params,d=m(a,t);if(d)if(l)if(o(d))t.send(i(null,"A game already exists for that user: "+s(d)));else{n(d,l);const e=l+"'s Game",s=E(d,e);r(d,s),"true"===c&&s.setMapIndex(-1),t.send(i({id:s.id,name:e})),u()}else t.send(i(null,"No user name specified"))}),[G_REST_JOIN_GAME+"/:id/:args"]:d((e,t)=>{const{id:s,args:o}=e.params,a=o.indexOf(","),l=o.slice(0,a),c=o.slice(a+1),d=m(s,t);if(!d)return;const _=(e=>p().reduce((t,s)=>s.id===e?s:t,null))(l);_?(r(d,_),n(d,c),_.join(d)?(t.send(i({id:_.id,name:_.name,players:_.getPlayers()})),u()):t.send(i(null,"Could not join game."))):t.send(i(null,"A game exists for that user: "+s))}),[G_REST_LEAVE_GAME+"/:id"]:d((e,t)=>{const{id:s}=e.params,n=m(s,t);if(!n)return;const r=o(n);r?(a(n),r.leave(n),t.send(i(r.id)),u()):t.send(i(null,"A game exists for that user: "+s))}),[G_REST_START_GAME+"/:id/:mapIndex"]:d((e,t)=>{const{id:s,mapIndex:n}=e.params,r=m(s,t);if(!r)return;const a=o(r);a?a.canStart()?(t.send(i(!0)),a.setMapIndex(Number(n)),a.start(),u()):t.send(i(null,"Cannot start game.")):t.send(i(null,"No game exists for that user: "+s))}),[G_REST_GAME_CONFIRM_ACTION+"/:id/:action/:args"]:d((e,t)=>{const{id:s,action:n,args:r}=e.params,a=m(s,t);if(!a)return;const l=o(a);l?l.isStarted()?l.confirmAction(n,r,a)?t.send(i(!0)):t.send(i(null,"Cannot confirm action.")):t.send(i(null,"Cannot send actions to a game that has not been started!")):t.send(i(null,"No game exists for that user: "+s))}),io:t=>{const s=(e=>[e,"",""])(t);e[t.id]=s,t.on("disconnect",d(()=>{(t=>{const[s,n]=t;n&&n.leave(t),delete e[s]})(s)}));const n=c();t.emit(G_SOCKET_CONNECTED,l({games:_(),maps:U,id:t.id,key:n}))}};module.exports=G;const A=60/G_SCALE,y=12*G_AU,h=20*G_AU,f=e=>({color:"aquamarine",mass:5*10**30,r:A,hp:5,...e}),g=(e,t,s)=>({x:e,y:t,r:s}),x=(e,t,s)=>({type:"coin",value:250,r:G_AU/4,x:e,y:t,posR:s}),U=[{name:"Small Map",maxRoundLength:5e3,maxPlayers:4,width:y,height:y,playerLocations:[g(0,-y/3,G_AU),g(0,y/3,G_AU),g(-y/3,0,G_AU),g(y/3,0,G_AU)],resourceLocations:[x(-y/1.8,-y/1.8,G_AU),x(y/1.8,-y/1.8,G_AU),x(-y/1.8,y/1.8,G_AU),x(y/1.8,y/1.8,G_AU),x(0,y/1.5,G_AU),x(0,-y/1.5,G_AU),x(y/1.5,0,G_AU),x(-y/1.5,0,G_AU)],planetLocations:[f({x:0,y:0,posR:0}),f({x:-y/3,y:-y/3,posR:G_AU}),f({x:y/3,y:-y/3,posR:G_AU}),f({x:-y/3,y:y/3,posR:G_AU}),f({x:y/3,y:y/3,posR:G_AU})]},{name:"Large Map",maxRoundLength:8e3,maxPlayers:4,width:h,height:h,playerLocations:[g(0,-h/1.5,G_AU),g(0,h/1.5,G_AU),g(-h/1.5,0,G_AU),g(h/1.5,0,G_AU)],resourceLocations:[x(0,-h/2.2,G_AU),x(0,h/2.2,G_AU),x(-h/2.2,0,G_AU),x(h/2.2,0,G_AU),x(-h/1.5,-h/1.5,G_AU),x(h/1.5,-h/1.5,G_AU),x(-h/1.5,h/1.5,G_AU),x(h/1.5,h/1.5,G_AU)],planetLocations:[f({x:G_AU,y:G_AU,posR:0}),f({x:-G_AU,y:-G_AU,posR:0}),f({x:-G_AU,y:G_AU,posR:0}),f({x:G_AU,y:-G_AU,posR:0}),f({x:h/1.1,y:h/1.1,posR:G_AU}),f({x:-h/1.1,y:h/1.1,posR:G_AU}),f({x:h/1.1,y:-h/1.1,posR:G_AU}),f({x:-h/1.1,y:-h/1.1,posR:G_AU}),f({x:-h/2.5,y:-h/2.5,posR:2*G_AU}),f({x:h/2.5,y:-h/2.5,posR:2*G_AU}),f({x:-h/2.5,y:h/2.5,posR:2*G_AU}),f({x:h/2.5,y:h/2.5,posR:2*G_AU})]}],E=(e,n)=>{let o,r,i,d,p=[e],_=0,m=!1,G=!1,A=null,y=1,h=0,f=25/G_SCALE,g=100,x=0;const E=["blue","red","green","yellow"],S=()=>{try{let e=+new Date;r=e-o,o=e;let t=A,s=G_applyGravity(t.projectiles,t.projectiles.concat(t.planets),t.players.filter(e=>!e.dead).concat(t.resources),r);A.collisions=s;let n=s.length;if(n)for(let e=0;e<n;e++){const[o,r]=s[e];let a=!0;if(r)if("coin"===r.type){M(o.meta.player,A).funds+=r.value,I(r.id,A),a=!1}else{if(r.meta){o.meta.speed>r.meta.speed?L(r.meta.id,A):(o.meta.speed<r.meta.speed||L(r.meta.id,A),L(o.meta.id,A)),s.reduce((e,t,s)=>t.meta&&t.meta.id===r.id?s:e,-1)>-1&&(s.splice(e,1),n--);continue}if(r.color){L(r.color,A,!0);const e=M(r.id,A);e.hp--,e.hp<=0&&(e.dead=!0)}}let l=t.projectiles.indexOf(o);l>-1&&a&&t.projectiles.splice(l,1)}for(let e=0;e<A.projectiles.length;e++){const t=A.projectiles[e];"Move"===t.meta.type&&O(t.meta.player,t.px,t.py),o-_>=t.t&&(s.push([t,null]),A.projectiles.splice(e,1),e--,"Move"===t.meta.type&&O(t.meta.player,t.px,t.py))}if(0===A.projectiles.length)return void T();h++,(h>=10||n)&&(h=0,((e,t,s)=>{v.emitAll(G_SOCKET_BROADCAST_GAME,l({i:e,timestamp:t,gameData:s}))})(y++,o,A))}catch(e){T()}},R=()=>{_=o=+new Date,r=0,v.emitAll(G_SOCKET_START_SIMULATION,l(A)),d=setTimeout(T,A.maxRoundLength),i=setInterval(S,G_FRAME_MS)},T=()=>{if(m){v.emitAll(G_SOCKET_STOP_SIMULATION,l(A)),clearInterval(i),i=-1,clearTimeout(d),d=-1,A.projectiles=[],A.collisions=[];const e=N();e?(v.finished=!0,v.finish(e)):A.players.forEach(e=>{e.ready=!1,e.funds+=25})}},C=e=>{let t=e.length;e=[...e];const s=[];for(let n=0;n<t;n++){const t=Math.floor(Math.random()*e.length);s.push(e[t]),e.splice(t,1)}return s},M=(e,s)=>{const n="string"==typeof e?e:t(e);return s.players.reduce((e,t)=>t.id===n?t:e,null)},L=(e,t,s)=>{const n=s?((e,t)=>t.projectiles.reduce((t,s,n)=>s.color===e?n:t,-1))(e,t):((e,t)=>t.projectiles.reduce((t,s,n)=>s.meta.id===e?n:t,-1))(e,t);n>-1&&t.projectiles.splice(n,1)},I=(e,t)=>{const s=((e,t)=>t.resources.reduce((t,s,n)=>s.id===e?n:t,-1))(e,t);s>-1&&t.resources.splice(s,1)},O=(e,t,s)=>{const n=M(e,A);P(t,s)&&(n.x=t,n.y=s)},P=(e,t)=>{const{width:s,height:n}=A;return e>=-s&&e<=s&&t>=-n&&t<=n},j=()=>A.players.reduce((e,t)=>e&&(!!t.dead||t.ready),!0),N=()=>{if(G)return!1;let e=[];for(let t=0;t<A.players.length;t++){const s=A.players[t];s.dead||e.push(s)}return 0===e.length?"draw":1===e.length&&e[0].id},D=()=>{const e=v.getPlayers();v.emitAll(G_SOCKET_LOBBY_LIST_UPDATED,l(e))},v={id:t(e),name:n,getPlayers:()=>p.map(e=>({id:t(e),userName:s(e)})),join:e=>!m&&!G&&(p.length<U[x].maxPlayers&&(p.push(e),D(),!0)),leave(e){for(let t=0;t<p.length;t++){const s=p[t];if(s===e){if(p.splice(t,1),a(s),m){const e=M(s,A);return 0===p.length?v.stop():e.dead||(e.dead=!0),N()?v.stop():j()&&setTimeout(()=>{try{R()}catch(e){}},500),!0}return 0===t?v.stop():D(),!0}}return!1},start(){m=!0,A=(e=>{let n=C(e);const o=U[x],{resourceLocations:r,planetLocations:a,playerLocations:l}=o,i={...o,players:[],planets:[],resources:[],projectiles:[],collisions:[],result:!1,baseFundsPerRound:25};for(let e=0;e<n.length;e++){const o=n[e],{x:r,y:a,r:c}=l[e],d=G_getRandomLocInCircle(r,a,c);i.players.push({id:t(o),name:s(o),funds:g,ready:!1,dead:!1,hp:1,color:E[e],r:f,...d,target:[d.x,d.y]})}for(let e=0;e<a.length;e++){const t=a[e],{x:s,y:n,mass:o,color:r,r:l,posR:c}=t,d=G_getRandomLocInCircle(s,n,c);i.planets.push(G_Body(r,o,r,l,0,0,d.x,d.y))}for(let e=0;e<r.length;e++){const t=r[e],{x:s,y:n,posR:o}=t;i.resources.push({...t,id:c(),...G_getRandomLocInCircle(s,n,o)})}return i})(p),v.emitAll(G_SOCKET_START_GAME,l({startTime:_,gameData:A}))},stop(){T(),v.emitAll(G_SOCKET_STOP_GAME,l("The game was stopped.")),p.forEach(e=>{a(e)}),u()},finish(e){A.result=e,v.emitAll(G_SOCKET_GAME_FINISHED,l(A)),p.forEach(e=>{a(e)}),u()},setMapIndex(e){e>=0&&e<U.length&&(x=e),-1===e&&(x=0,G=!0,g=1e4)},confirmAction(e,t,s){const n=M(s,A);if(!n)return!1;if(n.dead)return!1;switch(e){case"Shoot":case"Move":const[o,r,a]=t.split(","),l=(([e,t])=>{const s=Math.sqrt(e*e+t*t);return[e/s,t/s]})([o-n.x,r-n.y]),i=((e,t,s,n)=>{let o=5/G_SCALE,r=A.maxRoundLength;"Move"===e&&(o=15/G_SCALE,r=1e3);const{color:a,x:l,y:i}=n;return[G_Body({type:e,id:c(),player:n.id,speed:t,color:n.color},1,a,o,s[0]*t,s[1]*t,l,i,r)]})(e,G_SPEEDS[a]&&G_SPEEDS[a][0]||G_SPEEDS.normal[0],l,n),d=((e,t,s)=>{const n=G_getActionCost(e)+G_getSpeedCost(t);return M(s,A).funds>n&&n})(e,a,s);if(!1===d)return!1;A.projectiles=A.projectiles.concat(i),n.target=[o,r],n.funds-=d,n.cost=d;break;default:t=null}return n.action=e,n.ready=!0,j()&&setTimeout(()=>{try{R()}catch(e){}},500),!0},canStart:()=>!!G||p.length>1&&p.length<=U[x].maxPlayers&&!m,isPractice:()=>G,isStarted:()=>m,emitAll(e,t){p.forEach(s=>{s[0].emit(e,t)})}};return v}})();