(()=>{const e={},t=e=>e[0].id,s=e=>e[2]||t(e),n=(e,t)=>e[2]=t,r=e=>e[1],a=(e,t)=>e[1]=t,o=e=>e[1]=null,l=e=>"Game exists: "+s(e),i=e=>"No game: "+s(e),c=(e,t)=>[e,t],d=(e,t)=>JSON.stringify([e,t]),p=()=>(+new Date*Math.random()).toString(16),u=e=>(t,s)=>{try{e(t,s)}catch(e){s.send(d(null,"Error."))}},m=()=>{const t=[],s=e=>{for(let s=0;s<t.length;s++){if(t[s].id===e)return!0}};for(const n in e){const a=r(e[n]);a&&(s(a.id)||t.push(a))}return t},_=()=>m().filter(e=>!e.isStarted()&&!e.isPractice()),h=()=>{((t,s,n)=>{for(const r in e){if(r===n)continue;const[a]=e[r];a.emit(t,s)}})(G_S_LIST_UPDATED,c(_()))},y=(t,s)=>{const n=(t=>e[t])(t);return n||(s.send(d(null,"No user: "+t)),!1)},G={[G_R_CREATE+"/:id/:userName/:isPractice"]:u((e,t)=>{const{id:s,userName:o,isPractice:i}=e.params,c=y(s,t);if(c)if(o)if(r(c))t.send(d(null,l(c)));else{n(c,o);const e=o+"'s Game",s=v(c,e);a(c,s),"true"===i&&s.setMapIndex(-1),t.send(d({id:s.id,name:e})),h()}else t.send(d(null,"No given userName."))}),[G_R_JOIN+"/:id/:args"]:u((e,t)=>{const{id:s,args:r}=e.params,o=r.indexOf(","),i=r.slice(0,o),c=r.slice(o+1),p=y(s,t);if(!p)return;const u=(e=>m().reduce((t,s)=>s.id===e?s:t,null))(i);u?(a(p,u),n(p,c),u.join(p)?(t.send(d({id:u.id,name:u.name,players:u.getPlayers()})),h()):t.send(d(null,"Cannot join."))):t.send(d(null,l(p)))}),[G_R_LEAVE+"/:id"]:u((e,t)=>{const{id:s}=e.params,n=y(s,t);if(!n)return;const a=r(n);a?(o(n),a.leave(n),t.send(d(a.id)),h()):t.send(d(null,l(n)))}),[G_R_START+"/:id/:mapIndex"]:u((e,t)=>{const{id:s,mapIndex:n}=e.params,a=y(s,t);if(!a)return;const o=r(a);o?o.canStart()?(t.send(d(!0)),o.setMapIndex(Number(n)),o.start(),h()):t.send(d(null,"Cannot start yet.")):t.send(d(null,i(a)))}),[G_R_CONFIRM_ACTION+"/:id/:action/:args"]:u((e,t)=>{const{id:s,action:n,args:a}=e.params,o=y(s,t);if(!o)return;const l=r(o);l?l.isStarted()?l.confirmAction(n,a,o)?t.send(d(!0)):t.send(d(null,"Cannot confirm.")):t.send(d(null,"Game not started.")):t.send(d(null,i(o)))}),io:t=>{const s=(e=>[e,"",""])(t);e[t.id]=s,t.on("disconnect",u(()=>{(t=>{const[s,n]=t;n&&n.leave(t),delete e[s]})(s)}));const n=p();t.emit(G_S_CONNECTED,c({games:_(),maps:I,id:t.id,key:n}))}};module.exports=G;const g=60/G_SCALE,f=12*G_AU,A=20*G_AU,S=e=>({color:"aquamarine",mass:5*10**30,r:g,hp:5,...e}),x=(e,t,s)=>({x:e,y:t,r:s}),R=(e,t,s,n)=>({type:n,value:250,r:G_AU/3.5,x:e,y:t,posR:s}),L=(e,t,s)=>{const n=R(e,t,s,G_res_coin);return n.value=250,n},E=(e,t,s)=>[e(t,s),e(-t,s),e(t,-s),e(-t,-s)],T=(e,t,s)=>[e(0,s),e(0,-s),e(t,0),e(-t,0)],I=[{name:"Small Map",maxRoundLength:8e3,maxPlayers:4,width:f,height:f,playerLocations:[...T((e,t)=>x(e,t,G_AU),f/3,f/3)],resourceLocations:[...E((e,t)=>L(e,t,G_AU),f/1.8,f/1.8),...T((e,t)=>R(e,t,G_AU,G_res_spray),f/1.5,f/1.5)],planetLocations:[S({x:0,y:0,posR:0}),...E((e,t)=>S({x:e,y:t,posR:G_AU}),f/3,f/3)]},{name:"Large Map",maxRoundLength:8e3,maxPlayers:4,width:A,height:A,playerLocations:[...T((e,t)=>x(e,t,G_AU),A/1.5,A/1.5)],resourceLocations:[...E((e,t)=>L(e,t,G_AU),A/1.5,A/1.5),...T((e,t)=>L(e,t,G_AU),A/2.2,A/2.2)],planetLocations:[...E((e,t)=>S({x:e,y:t,posR:0}),G_AU,G_AU),...E((e,t)=>S({x:e,y:t,posR:G_AU}),A/1.1,A/1.1),...E((e,t)=>S({x:e,y:t,posR:2*G_AU}),A/2.5,A/2.5)]}],v=(e,n)=>{let r,a,l,i,d=[e],u=0,m=!1,_=!1,y=null,G=1,g=0,f=25/G_SCALE,A=100,S=0;const x=["blue","red","green","yellow"],R=()=>{try{let e=+new Date;a=e-r,r=e;let t=y,{projectiles:s,planets:n,players:o,resources:l}=t,i=G_applyGravity(s,s.concat(n),o.filter(e=>!e.dead).concat(l),a);y.collisions=i;let d=i.length;if(d)for(let e=0;e<d;e++)L(i[e])&&(i.splice(e,1),e--,d--);for(let e=0;e<y.projectiles.length;e++){const t=y.projectiles[e];t.meta.type===G_action_move&&N(t.meta.player,t.px,t.py),t.meta.remove?(y.projectiles.splice(e,1),e--):(r-u>=t.t||E(t.px,t.py))&&(i.push([t,null]),y.projectiles.splice(e,1),e--)}if(0===y.projectiles.length)return void v();g++,(g>=10||i.length)&&(g=0,((e,t,s)=>{O.emitAll(G_S_BROADCAST,c({i:e,timestamp:t,gameData:s}))})(G++,r,y))}catch(e){v()}},L=e=>{const[t,s]=e;let n=U(t.meta.player,y);switch(!0){case!(!s.color||!s.name):n=U(s.id,y),n.dead=!0,t.meta.remove=!0;break;case(e=>e.meta&&e.meta.proj)(s):if(s.meta.player===t.meta.player)return!0;const e=t.meta.speed,r=s.meta.speed;e>=r&&(s.meta.remove=!0),r>=e&&(t.meta.remove=!0);break;case(e=>e.type===G_res_coin)(s):n.funds+=s.value,C(s.id,y);break;case(e=>e.type===G_res_spray)(s):n.actions[G_action_spread]+=2,C(s.id,y);break;case(e=>!!e.color)(s):t.meta.remove=!0,t.meta.type===G_action_move&&(n.dead=!0)}},E=(e,t)=>{const s=y.width+G_AU/2,n=y.height+G_AU/2;return e<-s||e>s||t>n||t<-n},T=()=>{u=r=+new Date,a=0,O.emitAll(G_S_START_SIMULATION,c(y)),i=setTimeout(v,y.maxRoundLength),l=setInterval(R,G_FRAME_MS)},v=()=>{if(m){O.emitAll(G_S_STOP_SIMULATION,c(y)),clearInterval(l),l=-1,clearTimeout(i),i=-1,y.projectiles=[],y.collisions=[];const e=M();e?(O.finished=!0,O.finish(e)):y.players.forEach(e=>{e.ready=!1,e.funds+=25})}},P=e=>{let t=e.length;e=[...e];const s=[];for(let n=0;n<t;n++){const t=Math.floor(Math.random()*e.length);s.push(e[t]),e.splice(t,1)}return s},U=(e,s)=>{const n="string"==typeof e?e:t(e);return s.players.reduce((e,t)=>t.id===n?t:e,null)},C=(e,t)=>{const s=((e,t)=>t.resources.reduce((t,s,n)=>s.id===e?n:t,-1))(e,t);s>-1&&t.resources.splice(s,1)},N=(e,t,s)=>{const n=U(e,y);j(t,s)&&(n.x=t,n.y=s)},j=(e,t)=>{const{width:s,height:n}=y;return e>=-s&&e<=s&&t>=-n&&t<=n},D=()=>y.players.reduce((e,t)=>e&&(!!t.dead||t.ready),!0),M=()=>{if(_)return!1;let e=[];for(let t=0;t<y.players.length;t++){const s=y.players[t];s.dead||e.push(s)}return 0===e.length?"draw":1===e.length&&e[0].id},w=()=>{const e=O.getPlayers();O.emitAll(G_S_LOBBY_LIST_UPDATED,c(e))},O={id:t(e),name:n,getPlayers:()=>d.map(e=>({id:t(e),userName:s(e)})),join:e=>!m&&!_&&(d.length<I[S].maxPlayers&&(d.push(e),w(),!0)),leave(e){for(let t=0;t<d.length;t++){const s=d[t];if(s===e){if(d.splice(t,1),o(s),m){const e=U(s,y);return 0===d.length?O.stop():e.dead||(e.dead=!0),M()?O.stop():D()&&setTimeout(()=>{try{T()}catch(e){}},500),!0}return 0===t?O.stop():w(),!0}}return!1},start(){m=!0,y=(e=>{let n=P(e);const r=I[S],{resourceLocations:a,planetLocations:o,playerLocations:l}=r,i={...r,players:[],planets:[],resources:[],projectiles:[],collisions:[],result:!1,baseFundsPerRound:25};for(let e=0;e<n.length;e++){const r=n[e],{x:a,y:o,r:c}=l[e],d=G_getRandomLocInCircle(a,o,c);i.players.push({id:t(r),name:s(r),funds:A,actions:{[G_action_shoot]:99,[G_action_move]:99,[G_action_spread]:0},ready:!1,dead:!1,hp:1,color:x[e],r:f,...d,target:[d.x,d.y]})}for(let e=0;e<o.length;e++){const t=o[e],{x:s,y:n,mass:r,color:a,r:l,posR:c}=t,d=G_getRandomLocInCircle(s,n,c);i.planets.push(G_Body(a,r,a,l,0,0,d.x,d.y))}for(let e=0;e<a.length;e++){const t=a[e],{x:s,y:n,posR:r}=t;i.resources.push({...t,id:p(),...G_getRandomLocInCircle(s,n,r)})}return i})(d),O.emitAll(G_S_START,c({startTime:u,gameData:y}))},stop(){v(),O.emitAll(G_S_STOP,c("The game was stopped.")),d.forEach(e=>{o(e)}),h()},finish(e){y.result=e,O.emitAll(G_S_FINISHED,c(y)),d.forEach(e=>{o(e)}),h()},setMapIndex(e){e>=0&&e<I.length&&(S=e),-1===e&&(S=0,_=!0,A=1e5)},confirmAction(e,t,s){const n=U(s,y);if(!n||n.dead)return!1;const[r,a,o]=t.split(","),l=(([e,t])=>{const s=Math.sqrt(e*e+t*t);return[e/s,t/s]})([r-n.x,a-n.y]),i=((e,t,s,n)=>{const r=(e,t)=>{const{round:s,cos:n,sin:r,PI:a}=Math,o=n(t*=a/180),l=r(t);return[s(1e4*(e[0]*o-e[1]*l))/1e4,s(1e4*(e[0]*l+e[1]*o))/1e4]},a=(s,r)=>G_Body({proj:!0,type:e,id:p(),player:n.id,speed:t,color:n.color},l,m,i,s*t,r*t,_,h,c),o=[];let l=1,i=5/G_SCALE,c=y.maxRoundLength,d=s[0],u=s[1];const{color:m,x:_,y:h}=n;switch(e){case G_action_spread:for(let e=-5;e<=5;e+=5){let[t,n]=r(s,e);o.push(a(t,n))}break;case G_action_move:i=15/G_SCALE,c=1e3;default:o.push(a(d,u))}return o})(e,G_SPEEDS[o]&&G_SPEEDS[o][0]||G_SPEEDS.normal[0],l,n),c=((e,t,s)=>{const n=G_getActionCost(e)+G_getSpeedCost(t);return U(s,y).funds>n&&n})(e,o,s);return!1!==c&&(y.projectiles=y.projectiles.concat(i),n.target=[r,a],n.funds-=c,n.cost=c,n.actions[e]-=n.actions[e]<99?1:0,n.action=e,n.ready=!0,D()&&setTimeout(()=>{try{T()}catch(e){}},500),!0)},canStart:()=>!!_||d.length>1&&d.length<=I[S].maxPlayers&&!m,isPractice:()=>_,isStarted:()=>m,emitAll(e,t){d.forEach(s=>{s[0].emit(e,t)})}};return O}})();