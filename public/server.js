(()=>{const e={},t=e=>e[0].id,n=e=>e[2]||t(e),s=(e,t)=>e[2]=t,a=e=>e[1],r=(e,t)=>e[1]=t,o=e=>e[1]=null,l=e=>"Game exists: "+n(e),c=e=>"No game: "+n(e),i=(e,t)=>[e,t],d=(e,t)=>JSON.stringify([e,t]),p=()=>(+new Date*Math.random()).toString(16),_=e=>(t,n)=>{try{e(t,n)}catch(e){n.send(d(null,"Error."))}},m=()=>{const t=[],n=e=>{for(let n=0;n<t.length;n++){if(t[n].id===e)return!0}};for(const s in e){const r=a(e[s]);r&&(n(r.id)||t.push(r))}return t},u=()=>m().filter(e=>!e.isStarted()&&!e.isPractice()),G=()=>{((t,n,s)=>{for(const a in e){if(a===s)continue;const[r]=e[a];r.emit(t,n)}})(G_S_LIST_UPDATED,i(u()))},y=(t,n)=>{const s=(t=>e[t])(t);return s||(n.send(d(null,"No user: "+t)),!1)},h={[G_R_CREATE+"/:id/:userName/:isPractice"]:_((e,t)=>{const{id:n,userName:o,isPractice:c}=e.params,i=y(n,t);if(i)if(o)if(a(i))t.send(d(null,l(i)));else{s(i,o);const e=o+"'s Game",n=U(i,e);r(i,n),"true"===c&&n.setMapIndex(-1),t.send(d({id:n.id,name:e})),G()}else t.send(d(null,"No given userName."))}),[G_R_JOIN+"/:id/:args"]:_((e,t)=>{const{id:n,args:a}=e.params,o=a.indexOf(","),c=a.slice(0,o),i=a.slice(o+1),p=y(n,t);if(!p)return;const _=(e=>m().reduce((t,n)=>n.id===e?n:t,null))(c);_?(r(p,_),s(p,i),_.join(p)?(t.send(d({id:_.id,name:_.name,players:_.getPlayers()})),G()):t.send(d(null,"Cannot join."))):t.send(d(null,l(p)))}),[G_R_LEAVE+"/:id"]:_((e,t)=>{const{id:n}=e.params,s=y(n,t);if(!s)return;const r=a(s);r?(o(s),r.leave(s),t.send(d(r.id)),G()):t.send(d(null,l(s)))}),[G_R_START+"/:id/:mapIndex"]:_((e,t)=>{const{id:n,mapIndex:s}=e.params,r=y(n,t);if(!r)return;const o=a(r);o?o.canStart()?(t.send(d(!0)),o.setMapIndex(Number(s)),o.start(),G()):t.send(d(null,"Cannot start yet.")):t.send(d(null,c(r)))}),[G_R_CONFIRM_ACTION+"/:id/:action/:args"]:_((e,t)=>{const{id:n,action:s,args:r}=e.params,o=y(n,t);if(!o)return;const l=a(o);l?l.isStarted()?l.confirmAction(s,r,o)?t.send(d(!0)):t.send(d(null,"Cannot confirm.")):t.send(d(null,"Game not started.")):t.send(d(null,c(o)))}),io:t=>{const n=(e=>[e,"",""])(t);e[t.id]=n,t.on("disconnect",_(()=>{(t=>{const[n,s]=t;s&&s.leave(t),delete e[n]})(n)}));const s=p();t.emit(G_S_CONNECTED,i({games:u(),maps:T,id:t.id,key:s}))}};module.exports=h;const g=60/G_SCALE,f=12*G_AU,A=20*G_AU,S=e=>({color:"aquamarine",mass:5*10**30,r:g,hp:5,...e}),x=(e,t,n)=>({x:e,y:t,r:n}),L=(e,t,n,s)=>({type:s,value:250,r:G_AU/3.5,x:e,y:t,posR:n}),R=(e,t,n)=>{const s=L(e,t,n,G_res_coin);return s.value=250,s},C=(e,t,n)=>[e(t,n,0),e(-t,n,1),e(t,-n,2),e(-t,-n,3)],E=(e,t,n)=>[e(0,n,0),e(0,-n,1),e(t,0,2),e(-t,0,3)],T=[{name:"Small Map",maxRoundLength:8e3,maxPlayers:4,width:f,height:f,playerLocations:[...E((e,t)=>x(e,t,G_AU),f/3,f/3)],resourceLocations:[...C((e,t)=>R(e,t,G_AU),f/1.8,f/1.8),...E((e,t,n)=>L(e,t,G_AU,n<2?G_res_spray:G_res_planetCracker),f/1.5,f/1.5),...C((e,t)=>R(e,t,G_AU/4),f/1.2,f/1.2)],planetLocations:[S({x:0,y:0,posR:0}),...C((e,t)=>S({x:e,y:t,posR:G_AU}),f/3,f/3)]},{name:"Large Map",maxRoundLength:8e3,maxPlayers:4,width:A,height:A,playerLocations:[...E((e,t)=>x(e,t,G_AU),A/1.5,A/1.5)],resourceLocations:[...C((e,t)=>R(e,t,G_AU),A/1.8,A/1.8),...C((e,t)=>R(e,t,G_AU/2),A/3.8,A/3.8),...E((e,t,n)=>L(e,t,G_AU/1,n<2?G_res_spray:G_res_planetCracker),A/1.1,A/1.1),...E((e,t,n)=>L(e,t,G_AU/1,n>=2?G_res_spray:G_res_planetCracker),A/2.1,A/2.1),...C((e,t)=>R(e,t,G_AU/4),A/1.2,A/1.2)],planetLocations:[...C((e,t)=>S({x:e,y:t,posR:0}),G_AU,G_AU),...C((e,t)=>S({x:e,y:t,posR:G_AU}),A/1.1,A/1.1),...C((e,t)=>S({x:e,y:t,posR:2*G_AU}),A/2.5,A/2.5)]}],U=(e,s)=>{let a,r,l,c,d=[e],_=0,m=!1,u=!1,y=null,h=1,g=0,f=25/G_SCALE,A=100,S=0;const x=["blue","red","green","yellow"],L=()=>{try{let e=+new Date;r=e-a,a=e;let t=y,{projectiles:n,planets:s,players:o,resources:l}=t,c=G_applyGravity(n,n.concat(s),o.filter(e=>!e.dead).concat(l),r);y.collisions=c;let d=c.length;if(d)for(let e=0;e<d;e++)R(c[e])&&(c.splice(e,1),e--,d--);for(let e=0;e<n.length;e++){const t=n[e];t.meta.type===G_action_move&&N(t.meta.player,t.px,t.py),t.meta.remove?(n.splice(e,1),e--):(a-_>=t.t||C(t.px,t.py))&&(c.push([t,null]),n.splice(e,1),e--)}for(let e=0;e<s.length;e++){s[e].meta.remove&&(s.splice(e,1),e--)}if(0===n.length)return void U();g++,(g>=10||c.length)&&(g=0,((e,t,n)=>{O.emitAll(G_S_BROADCAST,i({i:e,timestamp:t,gameData:n}))})(h++,a,y))}catch(e){U()}},R=e=>{const[t,n]=e;let s=I(t.meta.player,y);switch(!0){case!(!n.color||!n.name):s=I(n.id,y),s.dead=!0,t.meta.remove=!0;break;case(e=>e.meta&&e.meta.proj)(n):if(n.meta.player===t.meta.player)return!0;const e=t.meta.speed*t.meta.mass,a=n.meta.speed*n.meta.mass;e>=a&&(n.meta.remove=!0),a>=e&&(t.meta.remove=!0);break;case(e=>e.type===G_res_coin)(n):s.funds+=n.value,P(n.id,y);break;case(e=>e.type===G_res_spray)(n):s.actions[G_action_spread]+=2,P(n.id,y);break;case(e=>e.type===G_res_planetCracker)(n):s.actions[G_action_planetCracker]+=2,P(n.id,y);break;case(e=>!!e.color)(n):t.meta.remove=!0;const r=t.meta.type;r===G_action_move?s.dead=!0:r===G_action_planetCracker&&(n.meta.remove=!0)}},C=(e,t)=>{const n=y.width+G_AU/2,s=y.height+G_AU/2;return e<-n||e>n||t>s||t<-s},E=()=>{_=a=+new Date,r=0,O.emitAll(G_S_START_SIMULATION,i(y)),c=setTimeout(U,y.maxRoundLength),l=setInterval(L,G_FRAME_MS)},U=()=>{if(m){O.emitAll(G_S_STOP_SIMULATION,i(y)),clearInterval(l),l=-1,clearTimeout(c),c=-1,y.projectiles=[],y.collisions=[];const e=M();e?(O.finished=!0,O.finish(e)):y.players.forEach(e=>{e.ready=!1,e.funds+=25})}},v=e=>{let t=e.length;e=[...e];const n=[];for(let s=0;s<t;s++){const t=Math.floor(Math.random()*e.length);n.push(e[t]),e.splice(t,1)}return n},I=(e,n)=>{const s="string"==typeof e?e:t(e);return n.players.reduce((e,t)=>t.id===s?t:e,null)},P=(e,t)=>{const n=((e,t)=>t.resources.reduce((t,n,s)=>n.id===e?s:t,-1))(e,t);n>-1&&t.resources.splice(n,1)},N=(e,t,n)=>{const s=I(e,y);k(t,n)&&(s.x=t,s.y=n)},k=(e,t)=>{const{width:n,height:s}=y;return e>=-n&&e<=n&&t>=-s&&t<=s},D=()=>y.players.reduce((e,t)=>e&&(!!t.dead||t.ready),!0),M=()=>{if(u)return!1;let e=[];for(let t=0;t<y.players.length;t++){const n=y.players[t];n.dead||e.push(n)}return 0===e.length?"draw":1===e.length&&e[0].id},w=()=>{const e=O.getPlayers();O.emitAll(G_S_LOBBY_LIST_UPDATED,i(e))},O={id:t(e),name:s,getPlayers:()=>d.map(e=>({id:t(e),userName:n(e)})),join:e=>!m&&!u&&(d.length<T[S].maxPlayers&&(d.push(e),w(),!0)),leave(e){for(let t=0;t<d.length;t++){const n=d[t];if(n===e){if(d.splice(t,1),o(n),m){const e=I(n,y);return 0===d.length?O.stop():e.dead||(e.dead=!0),M()?O.stop():D()&&setTimeout(()=>{try{E()}catch(e){}},500),!0}return 0===t?O.stop():w(),!0}}return!1},start(){m=!0,y=(e=>{let s=v(e);const a=T[S],{resourceLocations:r,planetLocations:o,playerLocations:l}=a,c={...a,players:[],planets:[],resources:[],projectiles:[],collisions:[],result:!1,baseFundsPerRound:25};for(let e=0;e<s.length;e++){const a=s[e],{x:r,y:o,r:i}=l[e],d=G_getRandomLocInCircle(r,o,i);c.players.push({id:t(a),name:n(a),funds:A,actions:{[G_action_shoot]:99,[G_action_move]:99,[G_action_spread]:0,[G_action_planetCracker]:0},ready:!1,dead:!1,hp:1,color:x[e],r:f,...d,target:[d.x,d.y]})}for(let e=0;e<o.length;e++){const t=o[e],{x:n,y:s,mass:a,color:r,r:l,posR:i}=t,d=G_getRandomLocInCircle(n,s,i);c.planets.push(G_Body({color:r,type:"planet"},a,r,l,0,0,d.x,d.y))}for(let e=0;e<r.length;e++){const t=r[e],{x:n,y:s,posR:a}=t;c.resources.push({...t,id:p(),...G_getRandomLocInCircle(n,s,a)})}return c})(d),O.emitAll(G_S_START,i({startTime:_,gameData:y}))},stop(){U(),O.emitAll(G_S_STOP,i("The game was stopped.")),d.forEach(e=>{o(e)}),G()},finish(e){y.result=e,O.emitAll(G_S_FINISHED,i(y)),d.forEach(e=>{o(e)}),G()},setMapIndex(e){e>=0&&e<T.length&&(S=e),-1===e&&(S=0,u=!0,A=1e5)},confirmAction(e,t,n){const s=I(n,y);if(!s||s.dead)return!1;const[a,r,o]=t.split(","),l=(([e,t])=>{const n=Math.sqrt(e*e+t*t);return[e/n,t/n]})([a-s.x,r-s.y]),c=((e,t,n,s)=>{const a=(e,t)=>{const{round:n,cos:s,sin:a,PI:r}=Math,o=s(t*=r/180),l=a(t);return[n(1e4*(e[0]*o-e[1]*l))/1e4,n(1e4*(e[0]*l+e[1]*o))/1e4]},r=(n,a)=>G_Body({proj:!0,type:e,id:p(),player:s.id,speed:t,color:s.color},l,m,c,n*t,a*t,u,G,i),o=[];let l=1,c=5/G_SCALE,i=y.maxRoundLength,d=n[0],_=n[1];const{color:m,x:u,y:G}=s;switch(e){case G_action_spread:for(let e=-5;e<=5;e+=5){let[t,s]=a(n,e);o.push(r(t,s))}break;case G_action_planetCracker:c=20/G_SCALE,l=10,o.push(r(d,_));break;case G_action_move:i=1e3,c=15/G_SCALE;default:o.push(r(d,_))}return o})(e,G_SPEEDS[o]&&G_SPEEDS[o][0]||G_SPEEDS.normal[0],l,s),i=((e,t,n)=>{const s=G_getActionCost(e)+G_getSpeedCost(t);return I(n,y).funds>s&&s})(e,o,n);return!1!==i&&(y.projectiles=y.projectiles.concat(c),s.target=[a,r],s.funds-=i,s.cost=i,s.actions[e]-=s.actions[e]<99?1:0,s.action=e,s.ready=!0,D()&&setTimeout(()=>{try{E()}catch(e){}},500),!0)},canStart:()=>!!u||d.length>1&&d.length<=T[S].maxPlayers&&!m,isPractice:()=>u,isStarted:()=>m,emitAll(e,t){d.forEach(n=>{n[0].emit(e,t)})}};return O}})();