const G_AU=1496e8,G_SCALE=75/G_AU;let G_SPEEDS={Normal:[55e3,0],Super:[125e3,50]};const G_res_sprites={coin:{elem:"div",label:"",offsetTop:25,content:"$"},spread:{elem:"div",label:"Spread Fire",offsetTop:45,content:"S"},"planet-cracker":{elem:"div",label:"Planet Crkr.",offsetTop:45,content:"P"},cluster:{elem:"div",label:"Cluster Bomb",offsetTop:45,content:"C"},wave:{elem:"div",label:"Wave Bomb",offsetTop:45,content:"W"},wormhole:{elem:"div",label:"",offsetTop:32,content:"<div></div>"},boomerang:{elem:"div",label:"Boomerang",offsetTop:45,content:"B"},prox:{elem:"div",label:"",offsetTop:25,content:'<div class="prox2">!</div>'}};let G_actions=[["Move",50],["Shoot",0],["Spread Fire",100],["Wave Bomb",125],["Planet Crkr.",150],["Cluster Bomb",200],["Boomerang",25]];const G_getEntityType=e=>{switch(!0){case!e:return"ent_nothing";case!(!(t=e).color||!t.name):return"ent_player";case(e=>e.meta&&e.meta.proj)(e):return"ent_projectile";case(e=>"coin"===e.type)(e):return"ent_res_coin";case(e=>"spread"===e.type)(e):return"ent_res_spread";case(e=>"planet-cracker"===e.type)(e):return"ent_res_planet_cracker";case(e=>!!e.color)(e):return"ent_planet";case(e=>"cluster"===e.type)(e):return"ent_res_cluster";case(e=>"wave"===e.type)(e):return"ent_res_wave";case(e=>"wormhole"===e.type)(e):return"ent_res_wormhole";case(e=>"boomerang"===e.type)(e):return"ent_res_boomerang";case(e=>"prox"===e.type)(e):return"ent_res_prox";case(e=>"shockwave"===e.type)(e):return"ent_shockwave";default:return"ent_nothing"}var t},G_createCollision=(e,t,n)=>[e.id,t&&t.id||0,!1,G_randomId(),n],G_randomId=()=>(+new Date*Math.random()).toString(16),G_normalize=(e,t,n,o,r)=>o+(e-t)*(r-o)/(n-t),G_dist=(e,t)=>Math.sqrt(e**2+t**2),G_getActionCost=e=>G_actions.reduce((t,[n,o])=>n===e?o:t,0),G_getRandomLocInCircle=(e,t,n)=>{let o=2*Math.PI*Math.random(),r=Math.sqrt(Math.random())*n;return{x:e+r*Math.cos(o),y:t+r*Math.sin(o)}},G_getEntityFromEntMap=(e,t)=>t.entMap[e],G_getHeadingTowards=(e,t,n,o)=>{let r=o-t,a=n-e;const{sqrt:s,asin:l}=Math;let i=s(a*a+r*r),c=0;return c=o>=t&&n>=e?180*l(r/i)/Math.PI+90:o>=t&&n<e?180*l(r/-i)/Math.PI-90:o<t&&n>e?180*l(r/i)/Math.PI+90:180*l(-r/i)/Math.PI-90,c>=360&&(c=360-c),c<0&&(c=360+c),isNaN(c)?0:c},G_rotateVectorDeg=(e,t)=>{const{round:n,cos:o,sin:r,PI:a}=Math,s=o(t*=a/180),l=r(t);return[n(1e4*(e[0]*s-e[1]*l))/1e4,n(1e4*(e[0]*l+e[1]*s))/1e4]};
/** @preserve SAT.js - Version 0.8.0 - Copyright 2012 - 2018 - Jim Riecken <jimr@jimr.ca> - released under the MIT License. https://github.com/jriecken/sat-js */
var SAT;SAT=function(){function e(e,t){this.x=e||0,this.y=t||0}function t(t,n){this.pos=t||new e,this.r=n||0,this.offset=new e}function n(t,n){this.pos=t||new e,this.angle=0,this.offset=new e,this.setPoints(n||[])}function o(t,n,o){this.pos=t||new e,this.w=n||0,this.h=o||0}function r(){this.a=null,this.b=null,this.overlapN=new e,this.overlapV=new e,this.clear()}function a(e,t,n){for(var o=Number.MAX_VALUE,r=-Number.MAX_VALUE,a=e.length,s=0;s<a;s++){var l=e[s].dot(t);l<o&&(o=l),l>r&&(r=l)}n[0]=o,n[1]=r}function s(e,t,n,o,r,s){var l=u.pop(),i=u.pop(),c=d.pop().copy(t).sub(e),p=c.dot(r);if(a(n,r,l),a(o,r,i),i[0]+=p,i[1]+=p,l[0]>i[1]||i[0]>l[1])return d.push(c),u.push(l),u.push(i),!0;if(s){var y,h,m=0;l[0]<i[0]?(s.aInB=!1,l[1]<i[1]?(m=l[1]-i[0],s.bInA=!1):m=(y=l[1]-i[0])<(h=i[1]-l[0])?y:-h):(s.bInA=!1,l[1]>i[1]?(m=l[0]-i[1],s.aInB=!1):m=(y=l[1]-i[0])<(h=i[1]-l[0])?y:-h);var f=Math.abs(m);f<s.overlap&&(s.overlap=f,s.overlapN.copy(r),m<0&&s.overlapN.reverse())}return d.push(c),u.push(l),u.push(i),!1}function l(e,t){var n=e.len2(),o=t.dot(e);return o<0?f:o>n?v:g}function i(e,t,n){for(var o=d.pop().copy(t.pos).add(t.offset).sub(e.pos),r=t.r,a=r*r,s=e.calcPoints,i=s.length,c=d.pop(),p=d.pop(),y=0;y<i;y++){var u=y===i-1?0:y+1,h=0===y?i-1:y-1,m=0,g=null;c.copy(e.edges[y]),p.copy(o).sub(s[y]),n&&p.len2()>a&&(n.aInB=!1);var x=l(c,p);if(x===f){c.copy(e.edges[h]);var b=d.pop().copy(o).sub(s[h]);if((x=l(c,b))===v){if((_=p.len())>r)return d.push(o),d.push(c),d.push(p),d.push(b),!1;n&&(n.bInA=!1,g=p.normalize(),m=r-_)}d.push(b)}else if(x===v){if(c.copy(e.edges[u]),p.copy(o).sub(s[u]),(x=l(c,p))===f){if((_=p.len())>r)return d.push(o),d.push(c),d.push(p),!1;n&&(n.bInA=!1,g=p.normalize(),m=r-_)}}else{var _,w=c.perp().normalize();if((_=p.dot(w))>0&&Math.abs(_)>r)return d.push(o),d.push(w),d.push(p),!1;n&&(g=w,m=r-_,(_>=0||m<2*r)&&(n.bInA=!1))}g&&n&&Math.abs(m)<Math.abs(n.overlap)&&(n.overlap=m,n.overlapN.copy(g))}return n&&(n.a=e,n.b=t,n.overlapV.copy(n.overlapN).scale(n.overlap)),d.push(o),d.push(c),d.push(p),!0}function c(e,t,n){for(var o=e.calcPoints,r=o.length,a=t.calcPoints,l=a.length,i=0;i<r;i++)if(s(e.pos,t.pos,o,a,e.normals[i],n))return!1;for(i=0;i<l;i++)if(s(e.pos,t.pos,o,a,t.normals[i],n))return!1;return n&&(n.a=e,n.b=t,n.overlapV.copy(n.overlapN).scale(n.overlap)),!0}var p={};p.Vector=e,p.V=e,e.prototype.copy=e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this},e.prototype.clone=e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.perp=e.prototype.perp=function(){var e=this.x;return this.x=this.y,this.y=-e,this},e.prototype.rotate=e.prototype.rotate=function(e){var t=this.x,n=this.y;return this.x=t*Math.cos(e)-n*Math.sin(e),this.y=t*Math.sin(e)+n*Math.cos(e),this},e.prototype.reverse=e.prototype.reverse=function(){return this.x=-this.x,this.y=-this.y,this},e.prototype.normalize=e.prototype.normalize=function(){var e=this.len();return e>0&&(this.x=this.x/e,this.y=this.y/e),this},e.prototype.add=e.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},e.prototype.sub=e.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},e.prototype.scale=e.prototype.scale=function(e,t){return this.x*=e,this.y*=void 0!==t?t:e,this},e.prototype.project=e.prototype.project=function(e){var t=this.dot(e)/e.len2();return this.x=t*e.x,this.y=t*e.y,this},e.prototype.projectN=e.prototype.projectN=function(e){var t=this.dot(e);return this.x=t*e.x,this.y=t*e.y,this},e.prototype.reflect=e.prototype.reflect=function(e){var t=this.x,n=this.y;return this.project(e).scale(2),this.x-=t,this.y-=n,this},e.prototype.reflectN=e.prototype.reflectN=function(e){var t=this.x,n=this.y;return this.projectN(e).scale(2),this.x-=t,this.y-=n,this},e.prototype.dot=e.prototype.dot=function(e){return this.x*e.x+this.y*e.y},e.prototype.len2=e.prototype.len2=function(){return this.dot(this)},e.prototype.len=e.prototype.len=function(){return Math.sqrt(this.len2())},p.Circle=t,t.prototype.getAABB=t.prototype.getAABB=function(){var t=this.r;return new o(this.pos.clone().add(this.offset).sub(new e(t,t)),2*t,2*t).toPolygon()},t.prototype.setOffset=t.prototype.setOffset=function(e){return this.offset=e,this},p.Polygon=n,n.prototype.setPoints=n.prototype.setPoints=function(t){if(!this.points||this.points.length!==t.length){var n,o=this.calcPoints=[],r=this.edges=[],a=this.normals=[];for(n=0;n<t.length;n++){var s=t[n],l=n<t.length-1?t[n+1]:t[0];s===l||s.x!==l.x||s.y!==l.y?(o.push(new e),r.push(new e),a.push(new e)):(t.splice(n,1),n-=1)}}return this.points=t,this._recalc(),this},n.prototype.setAngle=n.prototype.setAngle=function(e){return this.angle=e,this._recalc(),this},n.prototype.setOffset=n.prototype.setOffset=function(e){return this.offset=e,this._recalc(),this},n.prototype.rotate=n.prototype.rotate=function(e){for(var t=this.points,n=t.length,o=0;o<n;o++)t[o].rotate(e);return this._recalc(),this},n.prototype.translate=n.prototype.translate=function(e,t){for(var n=this.points,o=n.length,r=0;r<o;r++)n[r].x+=e,n[r].y+=t;return this._recalc(),this},n.prototype._recalc=function(){var e,t=this.calcPoints,n=this.edges,o=this.normals,r=this.points,a=this.offset,s=this.angle,l=r.length;for(e=0;e<l;e++){var i=t[e].copy(r[e]);i.x+=a.x,i.y+=a.y,0!==s&&i.rotate(s)}for(e=0;e<l;e++){var c=t[e],p=n[e].copy(e<l-1?t[e+1]:t[0]).sub(c);o[e].copy(p).perp().normalize()}return this},n.prototype.getAABB=n.prototype.getAABB=function(){for(var t=this.calcPoints,n=t.length,r=t[0].x,a=t[0].y,s=t[0].x,l=t[0].y,i=1;i<n;i++){var c=t[i];c.x<r?r=c.x:c.x>s&&(s=c.x),c.y<a?a=c.y:c.y>l&&(l=c.y)}return new o(this.pos.clone().add(new e(r,a)),s-r,l-a).toPolygon()},n.prototype.getCentroid=n.prototype.getCentroid=function(){for(var t=this.calcPoints,n=t.length,o=0,r=0,a=0,s=0;s<n;s++){var l=t[s],i=s===n-1?t[0]:t[s+1],c=l.x*i.y-i.x*l.y;o+=(l.x+i.x)*c,r+=(l.y+i.y)*c,a+=c}return new e(o/=a*=3,r/=a)},p.Box=o,o.prototype.toPolygon=o.prototype.toPolygon=function(){var t=this.pos,o=this.w,r=this.h;return new n(new e(t.x,t.y),[new e,new e(o,0),new e(o,r),new e(0,r)])},p.Response=r,r.prototype.clear=r.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this};for(var d=[],y=0;y<10;y++)d.push(new e);var u=[];for(y=0;y<5;y++)u.push([]);var h=new r,m=new o(new e,1e-6,1e-6).toPolygon();p.isSeparatingAxis=s;var f=-1,g=0,v=1;return p.pointInCircle=function(e,t){var n=d.pop().copy(e).sub(t.pos).sub(t.offset),o=t.r*t.r,r=n.len2();return d.push(n),r<=o},p.pointInPolygon=function(e,t){m.pos.copy(e),h.clear();var n=c(m,t,h);return n&&(n=h.aInB),n},p.testCircleCircle=function(e,t,n){var o=d.pop().copy(t.pos).add(t.offset).sub(e.pos).sub(e.offset),r=e.r+t.r,a=r*r,s=o.len2();if(s>a)return d.push(o),!1;if(n){var l=Math.sqrt(s);n.a=e,n.b=t,n.overlap=r-l,n.overlapN.copy(o.normalize()),n.overlapV.copy(o).scale(n.overlap),n.aInB=e.r<=t.r&&l<=t.r-e.r,n.bInA=t.r<=e.r&&l<=e.r-t.r}return d.push(o),!0},p.testPolygonCircle=i,p.testCirclePolygon=function(e,t,n){var o=i(t,e,n);if(o&&n){var r=n.a,a=n.aInB;n.overlapN.reverse(),n.overlapV.reverse(),n.a=n.b,n.b=r,n.aInB=n.bInA,n.bInA=a}return o},p.testPolygonPolygon=c,p}();const G_applyAction=(e,t,n)=>{const{action:o,speed:r,target:[a,s],auxArgs:l,vec:i,cost:c}=n;(({type:e,speed:t,normalizedVec:n,player:o,pos:r,lifetimeMultiplier:a},s)=>{const l=[];let i=1,c=5/G_SCALE,p=8e3,d=n[0],y=n[1],{color:u,x:h,y:m}=o;r&&(h=r.x,m=r.y);const f=(n,r)=>{let a=((e,t,n,o,r,a,s,l,i)=>{const c=new SAT.Circle(new SAT.Vector(s,l),o);return{id:G_randomId(),meta:e,mass:t,color:n,r:o,vx:r,vy:a,ax:0,ay:0,px:s,py:l,t:i,update:function(){},satCircle:c}})({proj:!0,type:e,player:o.id,speed:t,color:o.color},i,u,c,n*t,r*t,h,m,p);return a.tStart=s.tss,a};switch(e){case"Spread Fire":for(let e=-5;e<=5;e+=5){let[t,o]=G_rotateVectorDeg(n,e);l.push(f(t,o))}break;case"Planet Crkr.":c=20/G_SCALE,i=10,l.push(f(d,y));break;case"Cluster Bomb":p=2e3*a,c=10/G_SCALE,l.push(f(d,y));break;case"Cluster Spawn":c=4/G_SCALE,p=1750;for(let e=0;e<360;e+=20){let[t,o]=G_rotateVectorDeg(n,e);l.push(f(t,o)),p+=30}break;case"Wave Bomb":p=2e3*a,c=12/G_SCALE,i=8,l.push(f(d,y));break;case"Boomerang":{const e=f(d,y);e.update=e=>{const t=G_getHeadingTowards(e.px,e.py,o.x,o.y)*Math.PI/180,n=-Math.round(350*Math.cos(t));((e,t,n)=>{e.ax=t,e.ay=n})(e,Math.round(350*Math.sin(t)),n)},l.push(e);break}case"Move":p=1e3,c=15/G_SCALE;default:l.push(f(d,y))}return l})({type:o,speed:r,normalizedVec:i,player:t,...l},e).forEach(t=>{e.projectiles.push(t.id),e.entMap[t.id]=t}),t.target=[a,s],t.funds-=c,t.cost=c,t.actions[o]-=t.actions[o]<99?1:0,t.action=o};(()=>{function e(e,t){const n=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return void 0!==t?"rgba("+n+", "+o+", "+r+", "+t+")":"rgb("+n+", "+o+", "+r+")"}const t=async(e,t,n)=>{Be(!0);const o=await fetch(`/${e}/${t}${n?"/"+n:""}`,{headers:{key:he()}});Be(!1);const r=await o.json();if(r[1])throw Error("[FETCH-ERROR] "+r[1]);return{result:r[0],err:r[1]}};let n,o;(()=>{let e;window.addEventListener("load",()=>{e=io({upgrade:!1,transports:["websocket"]}),e.on("s-connected",([{games:e,maps:t,id:n,key:o}])=>{Ye(n),Je(t),De(o),ct(e),i()}),e.on("s-game-list",([e])=>{ct(e)}),e.on("s-lobby-data",([e])=>{pt(e)}),e.on("s-game-meta",([e])=>{Ue(e),it(we(),e)}),e.on("s-start",([{gameData:e}])=>{$t(e),e.isPractice||Mt("start")}),e.on("s-stop",([e])=>{Ft("menu"),Wt(e),ze(null)}),e.on("s-simulate-start",([e])=>{je([e]),Bt(e),lt(e)}),e.on("s-simulate-stop",([{dynamicGameData:e,timestamp:t}])=>{const n=me();n.push({timestamp:t,dynamicGameData:e,last:!0}),n.length>500&&n.shift()}),e.on("s-broadcast",([{dynamicGameData:e,timestamp:t}])=>{const n=me();n.push({timestamp:t,dynamicGameData:e}),n.length>500&&n.shift()}),e.on("s-finished",([{gameData:e,replay:t}])=>{setTimeout(()=>{Rt(e),Ze(t)},500)}),e.on("connect",()=>{}),e.on("disconnect",async e=>{await Kt(),Yt("You disconnected from the game server!")}),e.on("error",async e=>{console.error("socket-error",e),await Kt(),Yt("An error occurred with the connection to the game server!")}),kt()},!1)})();let r=!1,a=null,s=+new Date,l=Math.PI;const i=()=>{ht(),C("practice").disabled=!1,C("create-game").disabled=!1,vt(),Ft("menu")},c=()=>{n-s>9e3&&(s=+new Date)},p=()=>C("c").getContext("2d"),d=(e,t)=>{e.innerHTML=t},y=()=>{const e=p(),t=e.canvas;e.clearRect(0,0,t.width,t.height)},u=(e,t,n,o)=>{const r=p();r.beginPath(),r.arc(e,t,n,0,2*l,!1),r.fillStyle=o,r.fill()},h=(e,t,n,o)=>{const r=p();r.beginPath(),r.arc(e,t,n,0,2*l,!1),r.strokeStyle=o,r.stroke()},m=(e,t,n,o,r,a)=>{const s=p();if(s.save(),s.beginPath(),s.translate(e,t),s.fillStyle=r,void 0!==a){const e=n/2;s.translate(e,o/2),s.rotate(a*l/180),s.fillRect(-e,-o/1.5,n,o)}else s.fillRect(0,0,n,o);s.restore()},f=(e,t)=>({"":{blue:"#44F",yellow:"#cac200"},dark:{blue:"darkblue",red:"darkred",green:"darkgreen",yellow:"#B8860B"},light:{blue:"lightblue",red:"#F08080",green:"lightgreen",yellow:"#FFF60B"}}[e][t]||e+t),g=e=>`background-color:${f("dark",e)};color:${f("light",e)};`,v={},x=(e,t,n,o,r,a,s,l)=>{const i=`${e},${t},${n},${o},${r},${a},${s},${l}`;if(!v[i]){const c=p().createRadialGradient(e,t,n,o,r,a);c.addColorStop(0,s),c.addColorStop(1,l),v[i]=c}return v[i]},b=e=>{("string"==typeof e?C(e):e).style.display="none"},_=e=>{("string"==typeof e?C(e):e).style.display=null},w=e=>{n=+new Date,o=0,a=e;const t=()=>{let e=+new Date;o=e-n,n=e,a(),requestAnimationFrame(t)};r||requestAnimationFrame(t),r=!0},E=e=>{const t=p().canvas;if(e){const{left:e,top:n}=t.getBoundingClientRect();return{left:e,top:n,width:t.width,height:t.height}}return{left:0,top:0,width:t.width,height:t.height}},M=(e,t)=>{const{width:n,height:o}=E(!0);return{x:(e-n/2)/G_SCALE,y:-(t-o/2)/G_SCALE}},G=(e,t)=>{const{width:n,height:o}=E(!0);return{x:Math.round(e*G_SCALE+n/2),y:Math.round(-t*G_SCALE+o/2)}},C=e=>document.getElementById(e),k=e=>{const{players:t,planets:n,projectiles:o}=e,r=fe();y(),c(),$(n.map(t=>G_getEntityFromEntMap(t,e)));for(let t=0;t<r.length;t++){const n=r[t],{projectiles:o}=r[t];for(let t=0;t<o.length;t++){const r=G_getEntityFromEntMap(o[t],n);if("Move"===r.meta.type)continue;const{px:a,py:s,r:l,meta:i}=r,{x:c,y:p}=G(a,s),d=ie(i.player,e);u(c,p,l*G_SCALE,f("light",d.color))}}P(o.map(t=>G_getEntityFromEntMap(t,e)).filter(e=>"Move"!==e.type),e),A(t.map(t=>G_getEntityFromEntMap(t,e)))},S=e=>{if(!e)return;const{planets:t,players:n}=e;y(),c(),A(n.map(t=>G_getEntityFromEntMap(t,e))),$(t.map(t=>G_getEntityFromEntMap(t,e)),!1);for(let t in e.entMap){const n=e.entMap[t];"shockwave"===n.type&&u(n.x,n.y,n.r*G_SCALE,"orange")}},A=e=>{for(let t=0;t<e.length;t++){const{x:n,y:o,r:r,color:a,target:s,dead:l}=e[t],{x:i,y:c}=G(n,o),p=2*r*G_SCALE-10,d=p/2,[y,h]=a===xe()?_e():s,{x:g,y:v}=G(y,h),x=C("pl-"+a);x.style.left=i-100+"px",x.style.top=c-75+"px",l?x.style.opacity=0:(u(i,c,r*G_SCALE,f("dark",a)),m(i-d,c-d,p,p,f("",a)),m(i-5,c-30,10,60,"white",G_getHeadingTowards(i,c,g,v)),u(i,c,d/1.5,f("light",a)))}},$=t=>{for(let e=0;e<t.length;e++){const{px:n,py:o,mass:r}=t[e],{x:a,y:s}=G(n,o),l=G_normalize(r,5*10**30,100*10**30,239359999999.99997,1675519999999.9998),i=x(a,s,20,a,s,l*G_SCALE,"#0d0d0d","transparent");u(a,s,800,i)}for(let n=0;n<t.length;n++){const{px:o,py:r,r:a,color:s}=t[n],{x:l,y:i}=G(o,r);u(l,i,a*G_SCALE,e(s,"0.9"))}},P=(e,t)=>{for(let n=0;n<e.length;n++){const{meta:o,px:r,py:a,r:s}=e[n],{x:l,y:i}=G(r,a);"Move"!==o.type&&(u(l,i,s*G_SCALE,ie(o.player,t).color),h(l,i,s*G_SCALE,f("light",ie(o.player,t).color)))}};let B=null,I=null,L=null,N=null,T=null,D=null,j=0,F=[],W=[],R=!1,V="menu",X=null,Y=!1,O="Shoot",H="Normal",z=!1,U=[0,0],q=null,J=null,Z="blue",K="",Q=!1,ee=null,te=null,ne=null,oe=!1,re=0,ae=!0,se=1,le=["dialog","game","lobby","menu","info"];const ie=(e,t)=>G_getEntityFromEntMap(e,t),ce=e=>{const{players:t}=e||{};for(let n=0;n<t.length;n++){const o=G_getEntityFromEntMap(t[n],e);if(o.id===be())return o}return G_getEntityFromEntMap(t[0],e)},pe=()=>R,de=()=>z,ye=()=>Y,ue=()=>Q,he=()=>D,me=()=>F,fe=()=>W,ge=()=>H,ve=()=>O,xe=()=>Z,be=()=>B,_e=()=>U,we=()=>q,Ee=()=>K,Me=()=>j,Ge=()=>ee,Ce=()=>oe,ke=()=>te,Se=()=>re,Ae=()=>ae,$e=()=>{const e=ve(),t=mt[e];return t?t.getArgs():{}},Pe=()=>se,Be=e=>R=e,Ie=e=>z=e,Le=e=>Y=e,Ne=e=>Q=e,Te=e=>T=e,De=e=>D=e,je=e=>F=e,Fe=e=>W=e,We=e=>H=e,Re=e=>O=e,Ve=e=>I=e,Xe=e=>L=e,Ye=e=>B=e,Oe=e=>N=e,He=e=>U=e,ze=e=>q=e,Ue=e=>J=e,qe=e=>{localStorage.setItem("js13k2020_orbital_forts_map",e),j=parseInt(e)},Je=e=>ee=e,Ze=e=>{ne=e;const t=JSON.stringify(ne);try{localStorage.setItem("js13k2020_orbital_forts_replay",t)}catch(e){}},Ke=e=>oe=e,Qe=e=>re=e,et=e=>{ae=e,localStorage.setItem("js13k2020_orbital_forts_sound",e)},tt=e=>se=e,nt=localStorage.getItem("js13k2020_orbital_forts_replay");if(nt)try{Ze(JSON.parse(nt))}catch(dn){}const ot=localStorage.getItem("js13k2020_orbital_forts_sound");null!==ot&&et("true"===ot);const rt=localStorage.getItem("js13k2020_orbital_forts_map");null!==ot&&qe(parseInt(rt)),window.events={async create(e){if(pe())return;Mt("button"),Vt(C("player-name-input").value.trim()||"Player");const{result:n,err:o}=await t("create",`${be()}/${encodeURIComponent(Ee())||be()}/${Me()}/${!!e}`);if(!o){const{id:t,name:o}=n;Ve(t),Xe(t),Oe(o||"Game Name"),e||(Ft("lobby"),pt(n.lobbyData)),e&&await window.events.start()}},async join(e){if(pe())return;Mt("button"),Vt(C("player-name-input").value.trim()||"Player");const{result:n,err:o}=await t("join",`${be()}/${e},${encodeURIComponent(Ee())}`);if(o)Yt("Could not join game.");else{const{id:e,name:t,lobbyData:o}=n;Ve(e),Oe(t),Xe(e),Ft("lobby"),pt(o)}},async leave(){Mt("button"),Kt()},async start(){pe()||await t("start",`${be()}/${Me()}`)},async setMapIndex(e){let t=C(e).value;qe(t),"lobby-map-select"===e&&await window.events.updateLobby()},async confirmAction(){Mt("button3");const e=ve();let n=[..._e(),ge(),JSON.stringify($e())].join(",");const o=G_getActionCost(e),r=ce(we()),{x:a,y:s}=G(r.x,r.y);ln(a,s-30,"-$"+o,f("light",xe())),Nt(!0),Ie(!0);const{err:l}=await t("confirm",`${be()}/${e}/${n}`);l&&Ie(!1),Nt(!1),lt(we())},setAction(e){Mt("button2"),Re(e),lt(we())},setSpeed(e){Mt("button2"),We(e),lt(we())},setTarget(e){e.preventDefault(),e.stopPropagation(),!T||de()||ye()||Ce()||Ot(e)},centerCam(){jt()},toMainMenu(){Ft("menu")},toHelpMenu(){Ft("info")},async returnToMenu(){Mt("button"),Nt(!0),Ce()?(Ut(),zt()):(It(),Pt()),await window.events.leave(),ze(null),Ve(null),Ft("menu")},hideDialog(){Ft(X)},async updateLobby(){const e=""+Me();await t("update-lobby",`${be()}/${e}`)},viewLastReplay(){Mt("button");const e=JSON.parse(JSON.stringify(ne));e?Ht(e):Yt("No recent replay found.")},replayNextRound(){Mt("button"),qt()},toggleSound(){const e=Ae();et(!e),ht()}};let at=C("c"),st=0;at.addEventListener("touchend",e=>{if(Qt)return;let t=+new Date;t-st<500&&(window.events.setTarget(e),e.preventDefault()),st=t}),at.addEventListener("contextmenu",window.events.setTarget);const lt=e=>{if(!e)return;const t=ce(e),n=pe(),o=ue(),r=t.dead,a=de();C("controls").style.display=ye()||a||o||r?"none":"flex",C("center-self").style.display="block",C("confirm-button").style.display="block",C("control-panel").style.display="flex",b("controls-replay"),C("leave-game").style.display=o||r?"block":"none",C("view-last-replay").style.display=o?"block":"none";let s="";Object.keys(G_SPEEDS).forEach(e=>{let[,t]=G_SPEEDS[e],o=e===ge()?g(xe()):"";s+=`<div class="action-label" style="pointer-events:${n?"none":"all"}">\n<div>Cost $${t}</div>\n<div class="action" style="${o}" id="${e}" onclick="events.setSpeed('${e}')" onmousedown="events.setSpeed('${e}')">${e}\n</div>\n</div>`}),d(C("speed-buttons"),s),C("back-practice").style.display=1===we().players.length?"block":"none";let l="";G_actions.forEach(([e,n],o)=>{const r=t.actions[e];r&&(l=dt(e+(r<99?` (${r})`:""),"$"+n,e,o>1)+l)}),d(C("action-buttons"),l);const i=G_getActionCost(ve())+(c=ge(),G_SPEEDS[c][1]);var c;C("confirm-button").disabled=i>t.funds,d(C("funds"),"Funds: $"+t.funds);let p=C("target");const y=_e(),{x:u,y:h}=G(y[0],y[1]);p.style.display=ye()||o||r?"none":"flex",p.style.left=u-30+"px",p.style.top=h-30+"px",p.style.stroke=f("",xe()),p.className="target";const m=C("x").cloneNode(!0);m.id="x2",m.style.display="block",d(p,""),p.appendChild(m),it(e),ft()},it=(e,t,n)=>{const o=ce(e),r=ue(),a=o.dead,s=de(),l=C("banner-message"),i=C("banner-message2");if(d(l,""),d(i,""),r){const t=ie(e.result,e);return d(l,"The Game is Over!"),void d(i,t?`The Victor is <span style="${g(t.color)}">${t.name}</span>!`:"The result is a DRAW!")}if(n)d(l,"Viewing replay: "+n.name);else if(a)d(l,"You have been eliminated!");else if(!ye())if(s){const e=(t=t||J).playersNotReady||[];if(0===e.length)return;d(l,"Waiting for other players: "+e.map(({playerName:e,color:t})=>`<span style="${g(t)}">${e}</span>`).join(", "))}else d(l,`You are the <span style="${g(o.color)}border:1px solid;padding:2px;">${o.color}</span> player.`),d(i,`<span style="color:${f("light",o.color)}">[Right Click/Dbl Tap]</span> to set Target.<br /> <span style="color:${f("light",o.color)}">[Left Click/Tap]</span> to pan.`)},ct=e=>{const t=C("games");d(t,"");for(let n=0;n<e.length;n++){const{id:o,name:r}=e[n];t.innerHTML+=`<button class="join-button" onclick="events.join('${o}')">${n+1}. Join Game: ${r}</button>`}e.length||d(t,'<span style="color:lightblue"> There are no joinable games at the moment.</span>');const n=C("map-select-practice");n&&n.parentElement&&Mn(n,yt({ownerId:be()},"menu-map-select"))},pt=e=>{const{players:t}=e,n=t.length>1&&t.length<=4,o=t[0].id===be();Mn(C("lobby"),En("div",{},[En("button",{className:"back",onclick:events.leave},wn("Back")),En("div",{id:"lobby-title"},wn(N)),En("span",{className:"menu-section"},[En("span",{},wn("Map: ")),En("span",{id:"map-select"},yt(e,"lobby-map-select"))]),En("span",{id:"player-count",style:"margin:.5rem"},[En("a",{style:"color:"+(n?"#12a012":"red")},wn(t.length+" of 4")),wn(" joined"+(n?".":" (at least 2 required to start)."))]),En("button",{id:"start",onclick:events.start,disabled:!n,style:o?"":"display: none"},wn("Start Game!")),En("div",{id:"players-lobby",className:"menu-section"},t.map(({id:e,userName:t},n)=>En("div",{className:"lobby-player"},e===be()?En("a",{className:"lobby-name"},wn(n+1+". "+t)):wn(n+1+". "+t))))]))},dt=(e,t,n,o)=>`<div class="h-button-list">\n<button class="action" onclick="events.setAction('${n}')" onmousedown="events.setAction('${n}')"\nstyle="${ve()===n?g(xe()):""};width:80%;margin:2px;animation:${o?"2s linear infinite border-color;":""}">${e}</button>\n<div>${t}</div>\n</div>`,yt=(e,t)=>{const n=be()===e.ownerId,o=n?Me():e.mapIndex,r=Ge(),a=o>-1&&o<r.length?r[o].name:"Custom Map";return n?En("select",{id:t,value:o,onchange:function(e){events.setMapIndex(e.target.id)}},Ge().map((e,t)=>En("option",{value:t,selected:o===t?"selected":""},wn(e.name)))):En("span",{style:"color: lightblue"},wn(a))},ut=(e,t)=>{if(!e)return;const n=ue();b("controls"),b("center-self"),b("leave-game"),b("view-last-replay"),b("confirm-button"),b("controls-additional"),_("back-practice"),ye()?b("controls-replay"):_("controls-replay"),n?(_("replay-restart"),b("replay-next-round")):(_("replay-next-round"),b("replay-restart"));const o=Se();d(C("replay-round-label"),"Current Round: "+Math.min(o+1,e.rounds.length)+"/"+e.rounds.length),b("target"),it(t,null,e)},ht=()=>{const e=Ae(),t=C("sound");t.style.background="white",t.src=e?"sound.svg":"no-sound.svg"},mt={"Cluster Bomb":{render:()=>{const e=Pe(),t=C("controls-slider-input");t.value=e,t.min=.25,t.max=2,t.step=.25;const n=e=>{d(C("controls-slider-input-label"),`Lifetime: ${2*e}s`)};t.onchange=e=>{tt(e.target.value),mt["Cluster Bomb"].render()},t.oninput=e=>{n(e.target.value)},C("controls-slider").style.display="block",n(e)},getArgs:()=>({lifetimeMultiplier:Pe()})},"Wave Bomb":{render:()=>{const e=Pe(),t=C("controls-slider-input");t.value=e,t.min=.25,t.max=2,t.step=.25;const n=e=>{d(C("controls-slider-input-label"),`Lifetime: ${2*e}s`)};t.onchange=e=>{tt(e.target.value),mt["Wave Bomb"].render()},t.oninput=e=>{n(e.target.value)},C("controls-slider").style.display="block",n(e)},getArgs:()=>({lifetimeMultiplier:Pe()})}},ft=()=>{const e=C("controls-additional");e.style.display=null,Array.prototype.forEach.call(e.children,e=>{"confirm-button"!==e.id&&(e.style.display="none")});const t=ve(),n=mt[t];n&&n.render()},gt=(e,t)=>{const n=document.createElement("div");n.className="menu-info-item";const o=on({id:"info-"+e,x:0,y:0,type:e},n);o.style.left=-45,o.style.top=20,o.style["font-size"]=0;const r=document.createElement("div");return r.className="menu-info-text",d(r,t),n.appendChild(r),n},vt=()=>{const e=C("menu-info");tn=0,d(e,""),e.appendChild(gt("coin","Shoot coins to gain funds for more powerful weapons.")),e.appendChild(gt("spread","The Spread Fire missile shoots three projectiles at a slight angle.")),e.appendChild(gt("cluster","The Cluster Bomb explodes into a flower of missiles.")),e.appendChild(gt("wave","The Wave Bomb explodes in a shockwave.")),e.appendChild(gt("planet-cracker","The Planet Cracker can destroy a planet.")),e.appendChild(gt("wormhole","Wormholes teleport projectiles to the other wormhole of corresponding color.")),e.appendChild(gt("prox","Proximity mines explode with a shockwave that can damage players or detonate other mines."))};let xt,bt,_t;bt=.3,xt=(e=1,t=.05,n=220,o=0,r=0,a=.1,s=0,l=1,i=0,c=0,p=0,d=0,y=0,u=0,h=0,m=0,f=0,g=1,v=0,x=44100,b=99+o*x,_=r*x,w=a*x,E=v*x,M=f*x,G=2*Math.PI,C=(e=>0<e?1:-1),k=b+E+_+w+M,S=(i*=500*G/x**2),A=(n*=(1+2*t*Math.random()-t)*G/x),$=C(h)*G/4,P=0,B=0,I=0,L=0,N=0,T=0,D=1,j=[],F=_t.createBufferSource(),W=_t.createBuffer(1,k,x))=>{for(F.connect(_t.destination);I<k;j[I++]=T)++N>100*m&&(N=0,T=P*n*Math.sin(B*h*G/x-$),T=C(T=s?1<s?2<s?3<s?Math.sin((T%G)**3):Math.max(Math.min(Math.tan(T),1),-1):1-(2*T/G%2+2)%2:1-4*Math.abs(Math.round(T/G)-T/G):Math.sin(T))*Math.abs(T)**l*e*bt*(I<b?I/b:I<b+E?1-(I-b)/E*(1-g):I<b+E+_?g:I<k-M?(k-I-M)/w*g:0),T=M?T/2+(M>I?0:(I<k-M?1:(I-k)/M)*j[I-M|0]/2):T),P+=1-u+1e9*(Math.sin(I)+1)%2*u,B+=1-u+1e9*(Math.sin(I)**2+1)%2*u,n+=i+=500*c*G/x**3,D&&++D>d*x&&(n+=p*G/x,A+=p*G/x,D=0),y&&++L>y*x&&(n=A,i=S,L=1,D=D||1);return W.getChannelData(0).set(j),F.buffer=W,F.start(),F},_t=new(window.AudioContext||webkitAudioContext),_t.Z=_t.createBufferSource,_t.createBufferSource=(e=_t.Z())=>(e.start=e.start||(e=>_t.noteOn(e)),e.stop=e.stop||(e=>_t.noteOff(e)),e);const wt={button:[,,204,,,.06,,1.39,64,-17,,,,,-17,.2,.26],button2:[,,1107,.01,,.01,1,.14,,,,,,.5,31,.1,.44],button3:[,,313,,,.08,1,1.74,,,322,.66,,.1,-20,.1,.44],expl:[,,366,,.06,.28,3,2.51,-4.7,-.5,,,,.1,.1,.3,.06],explC:[,,366,,.06,.28,3,2.5,-4.7,-.5,,,,.1,.1,.3,.06],explProjEat:[,,438,,.08,.1,1,2.4,.7,-.1,,,,1.1,,.1,.1],getSpreadFire:[,,252,,,.23,2,.65,,,,,,1.6,-7.5,,.04],getCluster:[,,80,,,.41,2,2.53,1.3,-.8,,,,.7,.4,.1,.17],getWave:[,,615,.03,,.08,4,2.92,,38,,,.19,,-2.1,,,,.03],getBoom:[,,892,.03,,.2,2,1.24,,51,,,,.8,,.1],getPC:[,,1343,,.02,.23,1,.98,,,928,.06,.01],hitProx:[,,96,,.1,.32,2,2.97,6.3,8.9,,,,1.3,,.2],lobby:[,,531,.05,,.05,3,,,-.1,783,1.22,,1.4,,,.12],wormhole:[,,192,.01,.26,.01,,.56,,28,,,,.7,,,.16],playerDead:[,,385,,.1,.45,4,1.32,,,,,,.9,,.1,.11],playerDead2:[,,378,,.06,.97,1,3.63,.4,,,,,.5,-.4,.6],shootNorm:[,,528,.02,,.25,3,1.62,,-.6,,,,3.6,,.1,.01],shootNorm2:[,,223,,.07,.16,3,.92,,,,,,1.6,-.9,.3,.07],shootPC:[,,254,,,.48,3,.13,-1.1,,,,,2,,.1,.07],explWave:[,,153,,,.34,4,.01,,4.2,,,,1.5,-1,.1,.18,.99,.02],explPlanet:[,,814,.04,.23,1.86,4,1.78,,.3,,,,.9,-.9,.4],explLarge2:[,,997,.04,.06,.87,3,1.23,,100,,,,1.8,1,.8],explCluster:[,,273,,,.36,3,.01,,,,,,.2,.6,.3,.04],coin:[,,1250,,.04,.21,,1.56,,,706,.04,,,,,.05],respawn:[,,47,.06,.04,.32,,.44,-.1,,,,,2.5,-3.8,.3],start:[,,427,.01,.37,1.55,1,3.3,.4,.5,,,,.2,.2,.1,.36],win:[,,10,.22,.18,.93,2,.9,,-.9,150,.06,.09],lose:[,,31,.03,.24,.95,3,2.76,.1,,,,,.7,,.7],tie:[,,393,.03,.57,.11,1,1.65,,,4,.58,,.5,,.6],idk:[,,35,.5,.42,.34,,.49,,,258,.05,.25,,,,.13]},Et={explC:.1},Mt=e=>{Ae()&&(bt=Et[e]||.3,xt(...wt[e]||wt.idk))};let Gt={},Ct={};const kt=()=>{let e=C("main").style,t=()=>{const{innerHeight:t}=window;e.height=t+"px"};addEventListener("resize",t),Vt(Xt()),t(),Gt=function(e,t){let n=(t=t||{}).minScale?t.minScale:.1,o=t.maxScale?t.maxScale:1,r=t.increment?t.increment:.2,a=!!t.liner&&t.liner;return function(e,t,n,o,r){const a=o,s=t,l=n,i=r;let c=!1,p=!1,d=0,y=0,u=0;e.style.transform="transform(0px, 0px) scale(1)";const h=()=>{const t=e.style.transform;return t?(t.match(/scale\((.*?)\)/),{scale:parseFloat(t.match(/scale\((.*)\)/)[1]),transX:parseFloat(t.match(/translate\((.*?)\)/)[1].split(",")[0]),transY:parseFloat(t.match(/translate\((.*?)\)/)[1].split(",")[1])}):{scale:1,transX:0,transY:0}},m=t=>{e.style.transform=`translate(${t.transX}px, ${t.transY}px) scale(${t.scale})`},f=(e,t)=>{let n=h();n.transX+=e,n.transY+=t,m(n)},g=(t,n,o,r)=>{let a=r||h(),c=n-(e.width?e.width:e.offsetWidth)/2,p=o-(e.height?e.height:e.offsetHeight)/2;a.scale+=t=i?t:t*a.scale;let d=a.scale<=s||a.scale>=l;a.scale<s&&(a.scale=s),a.scale>l&&(a.scale=l),d||(m(a),f(-c*t,-p*t))},v=(e,t,n,o)=>Math.round(Math.sqrt(Math.pow(n-e,2)+Math.pow(o-t,2))),x=(e,t,n,o)=>({x:Math.min(e,n)+Math.abs(n-e)/2,y:Math.min(t,o)+Math.abs(o-t)/2}),b=e=>{const{clientX:t,clientY:n}=e[1],{clientX:o,clientY:r}=e[0];return{center:x(t,n,o,r),d:v(t,n,o,r)}};e.addEventListener("mousedown",e=>{0===e.button&&(e.preventDefault(),c=!0,d=e.clientX,y=e.clientY)}),e.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches,n=t.length;if(n)if(c=!0,n>=2){p=!0,Qt=!0;const{center:{x:e,y:n},d:o}=b(t);u=o,d=e,y=n}else d=t[0].clientX,y=t[0].clientY}),e.addEventListener("mouseup",e=>{0===e.button&&(c=!1,p=!1,Qt=!1)}),e.addEventListener("mouseleave",()=>{p=!1,c=!1,Qt=!1}),e.addEventListener("touchend",e=>{0===e.touches.length&&(c=!1,p=!1,Qt=!1)}),e.addEventListener("mousemove",e=>{c&&(f(e.clientX-d,e.clientY-y),d=e.clientX,y=e.clientY)}),e.addEventListener("touchmove",t=>{const n=t.touches;if(c||p){let o=0,r=0;if(n.length>=2){const{center:{x:t,y:a},d:s}=b(n);if(o=t-d,r=a-y,f(o,r),d=t,y=a,Math.abs(s-u)>2){const n=h(),o=e.getBoundingClientRect();g(s>u?.042:-.042,Math.round((t-o.left)/n.scale),Math.round((a-o.top)/n.scale)),u=s}}else if(!p){const e=t.touches[0];o=e.clientX-d,r=e.clientY-y,f(o,r),d=e.clientX,y=e.clientY}}});const _=e=>{g(Math.max(-1,Math.min(1,e.wheelDelta||-e.detail))<0?-a:a,e.offsetX,e.offsetY)};return e.addEventListener("DOMMouseScroll",_,!1),e.addEventListener("mousewheel",_,!1),{translateZoom:({x:t,y:n,scale:o})=>{g(o-1,t,n,{scale:1,transX:-(t-e.offsetWidth/2),transY:-(n-e.offsetWidth/2)}),d=t,y=n}}}(document.getElementById("cc"),n,o,r,a)}(0,[{minScale:.2,maxScale:1,increment:.1,linear:!0}])},St=e=>{ze(e),Ue({}),je([]),Fe([]),Ft("game"),Xe(null);const{players:t,width:n,height:o}=e;((e,t)=>{const n=C("c");n.width=e,n.height=t;const o=C("cc");o.style.width=e+"px",o.style.height=t+"px"})(2*n*G_SCALE,2*o*G_SCALE);const r=ce(e);We("Normal"),Re("Shoot"),Z=r.color,Ct={};const a=C("players");d(a,"");for(let n=0;n<t.length;n++){const o=G_getEntityFromEntMap(t[n],e),{x:r,y:s,name:l,color:i}=o,c=document.createElement("div");d(c,l),c.className="player-name",c.id="pl-"+i;const{x:p,y:y}=G(r,s);c.style.left=p-100+"px",c.style.top=y-75+"px",c.style.color=f("light",i),a.appendChild(c)}Ie(!1),Le(!1),Ne(!1),rn(e.resources.map(t=>G_getEntityFromEntMap(t,e))),S(e),w(()=>{})},At=e=>{const{resources:t}=e;for(let n=0;n<t;n++){const o=G_getEntityFromEntMap(t[n],e);C("res-"+o.id)||on(o)}[...C("res").children].map(e=>{const t=e.children;return{resourceId:t[t.length-1].id.slice(4),child:e}}).forEach(({resourceId:e,child:n})=>{t.find(t=>t===e)||n.remove()})},$t=e=>{Te(!0),Ke(!1),St(e);const t=ce(e);C("particles").innerHTML="",He([t.x,t.y+100]),jt(),lt(e)},Pt=()=>{It(we()),Ft("menu"),Ve(null),ze(null),Te(!1)},Bt=(e,t)=>{let n;ze(e),Ie(!1),Le(!0),C("particles").innerHTML="",Fe([]),k(e),setTimeout(()=>{Mt("shootNorm")},500);let r=+new Date,a=0,s=0;setTimeout(()=>{w(()=>{n=+new Date;let l=n-500-r;const i=me();if(i.length){let n=!1,o=i[s],r=i[s+1];for(;r&&r.timestamp<=l;)o=r,s+=1,r=i[s+1],n=!0;if(n){const n=e.entMap;for(let e in o.dynamicGameData.partialEntMap)n[e]=o.dynamicGameData.partialEntMap[e];if(ze({...we(),...o.dynamicGameData,entMap:n}),o.last){Jt(o.dynamicGameData);const e=we();return void(t?t(e):It(e))}Jt(o.dynamicGameData)}}let c=we(),{projectiles:p,planets:d}=c;const y=p.map(e=>G_getEntityFromEntMap(e,c)),u=y.concat(d.map(e=>G_getEntityFromEntMap(e,c)));((e,t,n,o)=>{const r=(e,t)=>{let{px:n,py:o,mass:r,r:a}=e,{px:s,py:l,mass:i,r:c}=t,p=s-n,d=l-o,y=667428e-16*r*i/Math.max(G_dist(p,d),.001)**2,u=Math.atan2(d,p);return{fx:Math.cos(u)*y,fy:Math.sin(u)*y,c:!1}};let a=[],s=172800*o/13.333;for(let n=0;n<e.length;n++){let l=e[n],i=0,c=0;for(let e=0;e<t.length;e++){let n=t[e];if(l===n)continue;let{fx:o,fy:s,c:p}=r(l,n);if(p&&n.meta.color!==l.meta.color){const e=G_createCollision(l,n);a.push(e)}else i+=o,c+=s}0,l.vx+=i/l.mass*s+l.ax*o/13.333,l.vy+=c/l.mass*s+l.ay*o/13.333,l.px+=l.vx*s,l.py+=l.vy*s}})(y,u,0,o),k(c),Gn(c),Lt(c,l),a++,a%10==0&&Zt(c)})},500)},It=e=>{if(clearInterval(-1),w(()=>{}),Le(!1),We("Normal"),Re("Shoot"),je([]),e){ze(e),Gn(e),At(e);const t=ce(e);t.actions[ve()]||Re("Shoot"),lt(e);for(let t=0;t<e.projectiles.length;t++){const n=G_getEntityFromEntMap(e.projectiles[t],e),{x:o,y:r,meta:a}=G(n.px,n.py);sn(o,r,a&&"Move"===a.type?"mv":"sm"),Mt("expl")}e.projectiles=[],S(e),Gn(e);const{x:n,y:o}=G(t.x,t.y);if(!t.dead){const t=e.baseFundsPerRound;d(C("banner-message3"),`All players granted $${t}.`),setTimeout(()=>{ln(n,o-30,"+$"+t,f("light",xe()))},500),setTimeout(()=>{d(C("banner-message3"),"")},3e3)}}},Lt=(e,t)=>{const n=e.projectiles;for(let o=0;o<n.length;o++){const r=G_getEntityFromEntMap(n[o],e),{meta:a,px:s,py:l}=r;if(a.player&&"Move"===a.type&&t<=r.t){const t=ie(a.player,e);t.x=s,t.y=l}}},Nt=e=>{Be(e)},Tt=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let Dt=-1;const jt=()=>{const e=ce(we());let{x:t,y:n}=G(e.x,e.y);n+=Tt?.65*window.innerHeight:0;const o=C("cc").style;o.transition="transform 0.5s",Gt.translateZoom({x:t,y:n,scale:.65}),clearTimeout(Dt),Dt=setTimeout(()=>{o.transition=""},500)},Ft=(e,t)=>{V=e,le.forEach(n=>{const o=C(n);let r="none";e===n&&(r="flex",t&&t()),o.style.display=r}),"info"===e&&vt()},Wt=e=>{X=V,Ft("dialog"),C("dialog-text").innerHTML=e},Rt=e=>{if(we()&&e.result){const t=G_getEntityFromEntMap(e.result,e);t?t===ce(e)?Mt("win"):Mt("lose"):Mt("tie"),Te(!1),Ne(!0),ze(e),lt(e),k(e)}},Vt=e=>{C("player-name-input").value=e,K=e,localStorage.setItem("js13k2020_orbital_forts_u",e)},Xt=()=>Ee()||localStorage.getItem("js13k2020_orbital_forts_u")||"Player",Yt=e=>{Pt(),ct([]),Ft("menu"),Wt(e)},Ot=e=>{let t=C("c");if(e.changedTouches){const n=e.changedTouches[0],o=t.parentElement.style.transform,{left:r,top:a}=t.getBoundingClientRect(),s=parseFloat(o.slice(7,o.indexOf(",")));let{x:l,y:i}=M((n.clientX-r)/s,(n.clientY-a)/s);He([l,i])}else{const{offsetX:t,offsetY:n}=e;let{x:o,y:r}=M(t,n);He([o,r])}Ce()?(ut(we()),k(we())):(lt(we()),S(we()))},Ht=e=>{if(!e)throw Error("no replay provided to start");const{initialGameData:t}=e;Ke(!0),Ne(!1),Qe(0),te=e,ut(e,t),St(t);const n=ce(t);He([n.x,n.y+100]),jt()},zt=()=>{const e=ke(),t=we();e&&t&&(Ne(!0),ut(e,t))},Ut=()=>{const e=ke(),t=we();if(clearInterval(-1),w(()=>{}),Le(!1),t){ut(e,t);for(let e=0;e<t.projectiles.length;e++){const n=t.projectiles[e],{x:o,y:r,meta:a}=G(n.px,n.py);sn(o,r,a&&"Move"===a.type?"mv":"sm"),Mt("expl")}t.projectiles=[],S(t),Gn(t);const n=Se();if(n+1>e.rounds.length)t.result=e.result,zt();else{const o=e.rounds[n];if(o.dynamicGameData){const e={...t,...o.dynamicGameData};ze(e),At(e)}}}},qt=()=>{if(!Ce())return;const e=ke(),t=Se(),n=e.rounds[t];n&&(((e,t)=>{let n=we();e.dynamicGameData&&(ze({...n,...e.dynamicGameData}),n=we()),Ie(!1),Le(!0),C("particles").innerHTML="",ut(t,n),k(n),je([n]),setTimeout(()=>{Mt("shootNorm")},500);const o=ce(n);o&&e.actions[o.id]&&He(e.actions[o.id].target);for(let t in e.actions){const o=e.actions[t],r=ie(t,n);G_applyAction(n,r,o)}je(e.snapshots.map((t,n)=>({timestamp:t.timestamp,dynamicGameData:t.dynamicGameData,last:n===e.snapshots.length-1}))),Bt(n,Ut)})(n,e),Qe(t+1))},Jt=e=>JSON.parse(JSON.stringify(e)),Zt=e=>{const t=fe();t.push(Jt(e)),t.length>500&&t.shift()},Kt=async()=>{try{await t("leave",""+be())}catch(e){}Ve(null),Xe(null),Ft("menu")};let Qt=!1;document.addEventListener("touchmove",(function(e){void 0!==(e=e.originalEvent||e).scale&&1!==e.scale&&e.preventDefault()}),!1);const en={0:"#00f",1:"#00f",2:"red",3:"red",4:"yellow",5:"yellow",6:"cyan",7:"cyan",8:"orange",9:"orange",10:"green",11:"green"};let tn=0;const nn=(e,t,n,o,r,a,s)=>{s=s||{};const l={position:"absolute",left:o+"px",top:r+"px",...s},i=document.createElement("div");i.className=n,"string"==typeof t?d(i,t):i.appendChild(t),i.id=a;for(let e in l)i.style[e]=l[e];return e.appendChild(i),i},on=(e,t)=>{t=t||C("res");const{x:n,y:o,id:r,type:a}=e;let{label:s,content:l,offsetTop:i,elem:c}=G_res_sprites[a]||{};const p="wormhole"===a;let d="",y="";const{x:u,y:h}=G(n,o),m=document.createElement(c);m.innerHTML=s||"";const f=nn(m,l||"","resource "+a,u-100,h-i,"res-"+r);if(p){const e=en[tn];d=e,y=`radial-gradient(circle at 50% 120%, ${e}, ${e} 10%, rgb(75, 26, 63) 80%, #062745 100%)`,f.children[0].style.background=`radial-gradient(circle at 50% 0px, ${e}, rgba(255, 255, 255, 0) 58%)`,tn++}return d&&(f.style.color=d),y&&(f.style.background=y),m.style.left=f.style.left,m.style.top=f.style.top,m.className="res2 centered",f.style.position="unset",t.appendChild(m),m},rn=e=>{const t=C("res");d(t,""),tn=0;for(let t=0;t<e.length;t++)on(e[t])},an=(e,t,n,o)=>{for(let r=0;r<o;r++){const{x:a,y:s}=G_getRandomLocInCircle(e,t,n),{x:l,y:i}=G(a,s);setTimeout(()=>{sn(l,i)},r/o*800)}},sn=(e,t)=>{const n=e+","+t;C(n)||nn(C("particles"),"","expl",e-50,t-50,n)},ln=(e,t,n,o)=>{const r="text,"+e+","+t;C(r)||nn(C("particles"),n,"text-particle",e-100,t,r,{color:o})},cn=(e,t)=>{for(let n=0;n<10;n++){const o=G_normalize(n,0,10,0,360),r=`worm${n},${e},${t}`;if(C(r))return;nn(C("particles"),'<div class="worm"></div>',"",e,t,r,{transform:`rotateZ(${o}deg)`})}},pn=(e,t,n)=>{const o="shock"+e+","+t;if(!C(o))if(n){const r=nn(C("particles"),`<div class="shockwave2" style="${g(n)};border-color:unset"><div class="shockwave3" style="${g(n)};border-color:unset"></div></div>`,"shockwave",e-50-3,t-50-3,o);r.style.color=f("",n),r.style["background-color"]=f("light",n),r.style["border-color"]=f("dark",n)}else nn(C("particles"),'<div class="shockwave2"><div class="shockwave3"></div></div>',"shockwave",e-50-3,t-50-3,o)};var dn={},yn=[],un=e=>null==e?e:e.key,hn=function(e){this.tag[e.type](e)},mn=(e,t,n,o,r)=>{"key"===t||("o"===t[0]&&"n"===t[1]?((e.tag||(e.tag={}))[t=t.slice(2)]=o)?n||e.addEventListener(t,hn):e.removeEventListener(t,hn):!r&&"list"!==t&&"form"!==t&&t in e?e[t]=null==o?"":o:null==o||!1===o?e.removeAttribute(t):e.setAttribute(t,o))},fn=(e,t)=>{var n=e.props,o=3===e.tag?document.createTextNode(e.type):(t=t||"svg"===e.type)?document.createElementNS("http://www.w3.org/2000/svg",e.type,{is:n.is}):document.createElement(e.type,{is:n.is});for(var r in n)mn(o,r,null,n[r],t);return e.children.map(e=>o.appendChild(fn(e=vn(e),t))),e.dom=o},gn=(e,t,n,o,r)=>{if(n===o);else if(null!=n&&3===n.tag&&3===o.tag)n.type!==o.type&&(t.nodeValue=o.type);else if(null==n||n.type!==o.type)t=e.insertBefore(fn(o=vn(o),r),t),null!=n&&e.removeChild(n.dom);else{var a,s,l,i,c=n.props,p=o.props,d=n.children,y=o.children,u=0,h=0,m=d.length-1,f=y.length-1;for(var g in r=r||"svg"===o.type,{...c,...p})("value"===g||"selected"===g||"checked"===g?t[g]:c[g])!==p[g]&&mn(t,g,c[g],p[g],r);for(;h<=f&&u<=m&&null!=(l=un(d[u]))&&l===un(y[h]);)gn(t,d[u].dom,d[u++],y[h]=vn(y[h++]),r);for(;h<=f&&u<=m&&null!=(l=un(d[m]))&&l===un(y[f]);)gn(t,d[m].dom,d[m--],y[f]=vn(y[f--]),r);if(u>m)for(;h<=f;)t.insertBefore(fn(y[h]=vn(y[h++]),r),(s=d[u])&&s.dom);else if(h>f)for(;u<=m;)t.removeChild(d[u++].dom);else{var v={},x={};for(g=u;g<=m;g++)null!=(l=d[g].key)&&(v[l]=d[g]);for(;h<=f;)l=un(s=d[u]),i=un(y[h]=vn(y[h])),x[l]||null!=i&&i===un(d[u+1])?(null==l&&t.removeChild(s.dom),u++):null==i||1===n.tag?(null==l&&(gn(t,s&&s.dom,s,y[h],r),h++),u++):(l===i?(gn(t,s.dom,s,y[h],r),x[i]=!0,u++):null!=(a=v[i])?(gn(t,t.insertBefore(a.dom,s&&s.dom),a,y[h],r),x[i]=!0):gn(t,s&&s.dom,null,y[h],r),h++);for(;u<=m;)null==un(s=d[u++])&&t.removeChild(s.dom);for(var g in v)null==x[g]&&t.removeChild(v[g].dom)}}return o.dom=t},vn=e=>!0!==e&&!1!==e&&e?e:_n(""),xn=e=>3===e.nodeType?_n(e.nodeValue,e):bn(e.nodeName.toLowerCase(),dn,yn.map.call(e.childNodes,xn),e,null,1),bn=(e,t,n,o,r,a)=>({type:e,props:t,children:n,dom:o,key:r,tag:a}),_n=(e,t)=>bn(e,dn,yn,t,null,3);const wn=_n,En=(e,t,n)=>bn(e,t,Array.isArray(n)?n:null==n?yn:[n],null,t.key),Mn=(e,t)=>((e=gn(e.parentNode,e,e.v||xn(e),t)).v=t,e),Gn=e=>{let t=e.collisions,n=t.length;const o=e=>{const t=(C("res-"+e)||{}).parentElement;return!!t&&(t.remove(),!0)};if(n)for(let r=0;r<n;r++){const[n,a,,s]=t[r];if(Ct[s])continue;Ct[s]=!0;const l=G_getEntityFromEntMap(n,e);if(!l)continue;const i=G_getEntityFromEntMap(a,e);if(!l)return;const{x:c,y:p}=G(l.px||l.x,l.py||l.y),d=G_getEntityFromEntMap(l.meta&&l.meta.player,e)||{},y=f("light",d.color);if("ent_shockwave"!==G_getEntityType(l)||0!==Object.keys(d).length)switch(G_getEntityType(i)){case"ent_player":{if(l.meta&&l.meta.player===i.id)continue;Mt("playerDead");const t=G_getEntityFromEntMap(i.id,e),{x:n,y:o}=G(i.x,i.y);if(t.dead=!0,ln(n,o,"Eliminated!",y),an(t.x,t.y,G_AU/2,7),"Wave Bomb"===l.meta.type){const{x:e,y:t}=G(l.px,l.py);return Mt("explWave"),void pn(e,t,d.color)}break}case"ent_projectile":if(e.projectiles.includes(l.id))Mt("expl");else{if("Wave Bomb"===l.meta.type){const{x:e,y:t}=G(l.px,l.py);return void pn(e,t)}Mt("explProjEat")}sn(c,p);break;case"ent_res_coin":{Mt("coin"),sn(c,p),o(i.id);const{x:e,y:t}=G(i.x,i.y);ln(e,t,"+$"+i.value,y);break}case"ent_res_spread":{Mt("getSpreadFire"),sn(c,p),o(i.id);const{x:e,y:t}=G(i.x,i.y);ln(e,t,"+2 SpreadFire",y);break}case"ent_res_planet_cracker":{Mt("getPC"),sn(c,p),o(i.id);const{x:e,y:t}=G(i.x,i.y);ln(e,t,"+2 PlanetCracker",y);break}case"ent_res_cluster":{Mt("getCluster"),sn(c,p),o(i.id);const{x:e,y:t}=G(i.x,i.y);ln(e,t,"+2 ClusterBomb",y);break}case"ent_res_wave":{Mt("getWave"),sn(c,p),o(i.id);const{x:e,y:t}=G(i.x,i.y);ln(e,t,"+2 Wave Bomb",y);break}case"ent_res_boomerang":{Mt("getBoom"),sn(c,p),o(i.id);const{x:e,y:t}=G(i.x,i.y);ln(e,t,"+2 Boomerang",y);break}case"ent_planet":if("Planet Crkr."===l.meta.type)Mt("explLarge2"),an(i.px,i.py,G_AU,30);else if("Move"===l.meta.type)Mt("playerDead2"),d.dead=!0,ln(c,p,"Eliminated!",y),an(d.x,d.y,G_AU/2,10);else if("Wave Bomb"===l.meta.type){const{x:e,y:t}=G(l.px,l.py);Mt("explWave"),pn(e,t,d.color)}else Mt("expl"),sn(c,p);break;case"ent_res_wormhole":{Mt("wormhole");const{x:e,y:t}=G(l.meta.prevX,l.meta.prevY);cn(c,p),cn(e,t);break}case"ent_res_prox":{Mt("hitProx");const{x:e,y:t}=G(i.x,i.y);pn(e,t),o(i.id);break}case"ent_nothing":default:if("Cluster Spawn"===l.meta.type)Mt("explC");else{if("Wave Bomb"===l.meta.type){const{x:e,y:t}=G(l.px,l.py);return Mt("explWave"),void pn(e,t,d.color)}Mt("expl")}sn(c,p)}else switch(G_getEntityType(i)){case"ent_player":{if(l.meta&&l.meta.player===i.id)continue;Mt("playerDead");const t=G_getEntityFromEntMap(i.id,e),{x:n,y:o}=G(i.x,i.y);if(t.dead=!0,ln(n,o,"Eliminated!",y),an(t.x,t.y,G_AU/2,7),"Wave Bomb"===l.meta.type){const{x:e,y:t}=G(l.px,l.py);return Mt("explWave"),void pn(e,t,d.color)}break}case"ent_res_prox":{Mt("hitProx");const{x:e,y:t}=G(i.x,i.y);pn(e,t),o(i.id);break}}}}})();